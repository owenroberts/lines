class EditUI{constructor(e,t){this.isAdded=!1,this.color="#ff00ff",this.panel=t,this.uis=new UICollection({class:"item-collection"}),this.item=e,this.docked=!1}add(){const e=this;let t=this.panel.addRow("label","label");this.uis.append(t);let i=new UIText({value:e.item.label,class:"label",callback:function(t){e.item.label=t}});t.append(i);let s=this.panel.addRow("edit","edit");this.uis.append(s),s.append(new UIToggle({text:"üê≠",class:"selectable",isOn:this.item.isSelectable,callback:()=>{this.item.isSelectable=!this.item.isSelectable}}));let o=new UIToggle({text:"üîì",class:"lock",isOn:!this.item.isLocked,callback:function(){e.item.lock()}});s.append(o);let n=new UIButton({text:"Edit",class:"edit",callback:function(){console.log(e),window.open(`${location.origin}/${location.pathname.includes("lines")?"lines/":""}animate/?src=${e.item.origin}`,"anim")}});s.append(n);let a=new UIButton({text:"Remove",class:"remove",callback:function(){e.item.isRemoved=!0,e.remove()}});s.append(a),this.panel.append(this.uis),this.isAdded=!0}remove(){this.uis.clear(),this.isAdded=!1}update(e){for(const t in e)this.uis[t].value=e[t]}toggle(){this.docked?this.remove():this.add(),this.docked=!this.docked}}class ItemEdit extends Entity{constructor(e,t,i){super(e,t,i),this.origin=e.src||t,this.displayLabel=!1,this.displayOutline=!1,this.label=e.label,this.scenes=e.scenes||["game"],this.ui=new ItemEditUI(this,edi.ui.panels.items),this.isLocked=!1,this.isSelectable=!0,this.isSelected=!1,this.isRemoved=!1}display(e){this.isRemoved||(super.display(this.isInMapBounds(e)),this.displayLabel&&this.drawLabel(),this.displayOutline&&this.drawOutline())}isInMapBounds(e){return this.xy.x+this.width>e.x-e.width/2&&this.xy.x<e.x+e.width/2&&this.xy.y+this.height>e.y-e.height/2&&this.xy.y<e.y+e.height/2}drawLabel(){GAME.ctx.fillText(this.label,this.xy.x,this.xy.y)}drawOutline(){GAME.ctx.strokeStyle="#000000",GAME.ctx.strokeRect(this.xy.x,this.xy.y,this.width,this.height),GAME.ctx.strokeStyle=this.ui.color,GAME.ctx.beginPath(),GAME.ctx.arc(this.position.x,this.position.y,5,0,2*Math.PI,!1),GAME.ctx.stroke()}isMouseOver(e,t,i){if(this.isInMapBounds(i.view)&&this.isSelectable){const s=i.translate(e,t);if(s.x>this.xy.x&&s.x<this.xy.x+this.width&&s.y>this.xy.y&&s.y<this.xy.y+this.height)return this.displayLabel=!0,this.displayOutline=!0,this;if(!this.isSelected)return this.displayLabel=!1,this.displayOutline=!1,!1}}select(e){this.isSelected=e,this.displayLabel=e,this.displayOutline=e,e?this.ui.add():this.ui.isAdded&&this.ui.remove(),this.texture&&e?this.texture.ui.add():this.texture&&this.texture.ui.remove()}update(e){this.isLocked||(this.position.add(e),this.ui.update({x:this.position.x,y:this.position.y}))}get data(){return{src:this.origin,x:this.position.x,y:this.position.y,scenes:this.scenes}}lock(e){this.isLocked=void 0!==e?e:!this.isLocked}}class ItemEditUI extends EditUI{constructor(e,t){super(e,t)}add(){const e=this;let t=this.panel.addRow("location","location");this.uis.append(t),t.append(new UILabel({text:"x",class:"x-label"})),this.uis.x=new UIText({value:this.item.position.x,class:"x-input",callback:e=>{this.item.position.x=+e}}),t.append(this.uis.x),t.append(new UILabel({text:"y",class:"y-label"})),this.uis.y=new UIText({value:this.item.position.y,class:"y-input",callback:e=>{this.item.position.y=+e}}),t.append(this.uis.y);let s=new UIButton({text:"üìç",class:"focus",callback:function(){edi.zoom.view.x=e.item.position.x,edi.zoom.view.y=e.item.position.y}});t.append(s);let o=this.panel.addRow("scene","scene");this.uis.append(o),o.append(new UISelect({options:this.item.scenes,selected:this.item.scenes[0],class:"scene-selector",callback:function(e){this.item.scenes[i]=e}})),o.append(new UIButton({text:"+ scene",class:"add-scene",callback:function(){console.warn("you didnt finish this",e)}})),super.add()}}class ItemUI extends Entity{constructor(e,t,i){super(e,t,i),this.x=e.x,this.y=e.y}set x(e){this._x=e,this.position.x=e%1!=0?GAME.width*e:e<0?GAME.width+e:e}get x(){return this._x}set y(e){this._y=e,this.position.y=e%1!=0?GAME.height*e:e<0?GAME.height+e:e}get y(){return this._y}display(){GAME.ctx.strokeStyle="#000000",super.display(!0),this.displayLabel&&this.drawLabel(),this.outline&&this.drawOutline()}mouseOver(e,t,i){return e>this.position.x&&e<this.position.x+this.width&&t>this.position.y&&t<this.position.y+this.height?(this.displayLabel=!0,this.outline=!0,i&&(this.selected=!0),this):this.selected?void 0:(this.displayLabel=!1,this.outline=!1,!1)}createUI(){const e=this;super.createUI(),this.ui.x.setValue(this.x),this.ui.x.callback=function(t){e.x=+t},this.ui.y.setValue(this.y),this.ui.y.callback=function(t){e.y=+t}}updatePosition(e,t){this.position.x+=Math.round(e),this.position.y+=Math.round(t)}}class Marker{constructor(e,t){this.position=new Cool.Vector(e,t)}display(){GAME.ctx.strokeStyle="#ff00ff",GAME.ctx.beginPath(),GAME.ctx.moveTo(-50,0),GAME.ctx.lineTo(50,0),GAME.ctx.stroke(),GAME.ctx.strokeStyle="#ffff00",GAME.ctx.beginPath(),GAME.ctx.moveTo(0,-50),GAME.ctx.lineTo(0,50),GAME.ctx.stroke()}}class TextureEdit extends Texture{constructor(e,t){super(e,t),e.src&&(this.src=e.src),this.scenes=e.scenes||["game"],this.label=e.label,void 0===e.x||e.locations||(this.locations=[{x:e.x,y:e.y}]),this.isLocked=!1,this.isSelectable=!0,this.isRemoved=!1,this.ui=new TextureEditUI(this,edi.ui.panels.textures)}addLocation(e,t){super.addLocation(e,t,this.locations.length),this.ui.remove(),this.ui.create()}display(e){if(!this.isRemoved)for(let t=0;t<this.locations.length;t++){let i=this.locations[t].x,s=this.locations[t].y;this.isInMapBounds(e,i,s,this.animation.width,this.animation.height)&&(this.center&&(i-=this.animation.width/2,s-=this.animation.height/2),void 0!==this.locations[t].i&&(this.animation.state="f-"+this.locations[t].i),this.animation.draw(i,s,GAME.debug),this.drawLabel(i,s,t),this.drawOutline(i,s))}}drawLabel(e,t,i){GAME.ctx.fillText(`${this.label} ${i}`,e,t)}drawOutline(e,t){GAME.ctx.strokeStyle="#000000",GAME.ctx.strokeRect(e,t,this.animation.width,this.animation.height),GAME.ctx.strokeStyle=this.ui.color,GAME.ctx.beginPath(),GAME.ctx.arc(e,t,5,0,2*Math.PI,!1),GAME.ctx.stroke()}isInMapBounds(e,t,i,s,o){return t+s>e.x-GAME.width/2&&t<e.x+e.width+GAME.width/2&&i+o>e.y-GAME.height/2&&i<e.y+e.height+GAME.height/2}isMouseOver(e,t,i){for(let e=0;e<this.locations.length;e++){let t=this.locations[e];if(this.isInMapBounds(i.view,t.x,t.y,this.animation.width,this.animation.height)){const e=i.translate(t.x,t.y);if(e.x>t.x&&e.x<t.x+this.animation.width&&e.y>t.y&&e.y<t.y+this.animation.height)return t.isSelected=!0,this}}return!1}get data(){return{src:this.src,locations:this.locations.map(e=>({x:e.x,y:e.y})),scenes:this.scenes,tags:this.tags}}get settings(){return!!this.isLocked&&{lock:this.isLocked}}lock(){this.isLocked=!this.isLocked;for(let e=0;e<this.items.length;e++)this.items[e].lock(this.isLocked)}}class TextureEditUI extends EditUI{constructor(e,t){super(e,t),this.allSelected=!1,this.prevSelected=void 0}create(){const e=this;this.uis.add=new UIButton({text:"Add",class:"add",callback:function(){edi.tool.set("location"),edi.tool.callback=function(t,i){e.item.addLocation(t,i),delete edi.tool.callback,edi.tool.set("zoom")}}}),this.uis.selectAll=new UIToggle({text:"All",class:"all",callback:function(){edi.tool.clear(),e.allSelected=!e.allSelected;for(let t=0;t<e.item.items.length;t++)e.item.items[t].selected&&(e.prevSelected=t),e.item.items[t].selected=e.allSelected;!e.allSelected&&e.prevSelected&&(e.items[e.prevSelected].selected=!0)}}),this.uis.frame=new UISelect({options:["index","random"],selected:this.item.frame,class:"frame-type",callback:function(t){e.item.frame=t;for(let i=0;i<e.item.items.length;i++){const s=e.item.items[i];s.animation.randomFrames!=t&&("random"==t?(s.animation.randomFrames=!0,s.animation.createNewState("random",0,s.animation.endFrame)):(s.animation.randomFrames=!1,s.animation.createNewState("still",i,i)))}}}),super.create()}}function Data(e,t){const i=this;function s(e,t){const i=JSON.stringify(e),s=new Blob([i],{type:"application/x-download;charset=utf-8"});return saveAs(s,t)}if(this.saveFiledEnabled=!1,this.saveSettingsOnUnload=t.save||!1,this.save=function(){!function i(o,n){const a=t.files[o],l={};n[a]={};for(const t in e.sprites[a]){const i=e.sprites[a][t];i.isRemoved||(l[t]=i.data),i.settings&&(n[a][t]=i.settings)}s(l,a+".json").onwriteend=()=>{o<t.files.length-1?(o++,i(o,n)):s(n,"settings.json")}}(0,{})},this.dropSprite=function(i,s,o,n){let a,l="sprites",c="scenery";const d=new Modal("Add Sprite",(function(){a="ui"==l?e[l]:e[l][c],a[i]=new e.classes[c]({label:i,src:`${t.path}/sprites/${i}.json`,scenes:[e.scene],...edi.zoom.translate(o,n)})}));d.add(new UISelect({options:["ui","sprites"],selected:l,callback:function(e){l=e}})),d.add(new UISelect({options:["scenery","textures"],selected:c,callback:function(e){c=e}}))},window.File&&window.FileReader&&window.FileList&&window.Blob){i.saveFilesEnabled=!0,console.log("%c Save file enabled ","color:lightgreen;background:black;");const e=document.getElementById("map");e&&(e.addEventListener("dragover",(function(e){e.preventDefault()})),e.addEventListener("drop",(function(e){e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files;for(let s,o=0;s=t[o];o++){if(!s.type.match("application/json"))continue;const t=new FileReader;t.onload=function(t){i.dropSprite(s.name.split(".")[0],JSON.parse(t.target.result),e.offsetX,e.offsetY)},t.readAsText(s)}})))}window.addEventListener("beforeunload",(function(e){i.saveSettingsOnUnload&&lns.ui.settings.saveSettings(),t.reload&&(e.returnValue="Did you save dumbhole?")}))}function Ruler(){this.x=0,this.y=0,this.width=0,this.height=0,this.update=function(){},this.display=function(e){e.strokeStyle="#bb11ff",e.strokeRect(m.x,m.y,m.w,m.h),e.font="48px monaco",e.fillText(Math.floor(m.w),m.x+m.w/2,m.y-10),e.fillText(Math.floor(m.h),m.x-20,m.y+m.h/2)}}function Zoom(){const e=this;this.canvas={width:void 0,height:void 0},this.view={x:0,y:0,width:void 0,height:void 0},this.previous={x:void 0,y:void 0},this.mouseDown=!1,this.clear=function(e){e.setTransform(1,0,0,1,0,0)},this.set=function(e,t){e.scale(this.canvas.width/this.view.width*GAME.dpr,this.canvas.height/this.view.height*GAME.dpr),e.translate(t.x-this.view.x,t.y-this.view.y)},this.wheel=function(e,t){const i=this.view.width/2+this.view.x,s=this.view.height/2+this.view.y,o=event.wheelDelta<0||event.detail>0?1.1:.9;this.view.width*=o,this.view.height*=o,this.view.x=i-this.view.width/2,this.view.y=s-this.view.height/2,t&&t()},this.getDelta=function(e,t){return{x:(e-this.previous.x)/this.canvas.width*this.view.width,y:(t-this.previous.y)/this.canvas.height*this.view.height}},this.updateView=function(e,t){this.view.x-=e,this.view.y-=t},this.updatePrevious=function(e,t){this.previous.x=e,this.previous.y=t},this.save=function(){localStorage.zoom=JSON.stringify({view:e.view,previous:e.previous,canvas:e.canvas})},this.load=function(){if(localStorage.zoom){const t=JSON.parse(localStorage.zoom);for(const i in t)e[i]=t[i]}},this.center=function(){e.canvas={width:GAME.width,height:GAME.height},e.view={x:0,y:0,width:GAME.width,height:GAME.height},e.previous={x:void 0,y:void 0}},this.translate=function(t,i){const s=e.canvas.width/e.view.width;return t=t/s+e.view.x-GAME.width/2,i=i/s+e.view.y-GAME.height/2,{x:Math.round(t),y:Math.round(i)}}}function Items(){}function Textures(){const e=this;this.display=function(){for(const t in GAME.anims.textures)e.panel.add(new UIToggle({text:t,callback:function(){GAME.anims.textures[t].ui.toggle()}}))}}const gme=new Game({canvas:"map",width:960,height:720,dps:30,mixedColors:!0,checkRetina:!0,scenes:["game"],debug:!0,stats:!1});gme.load({scenery:"/data/scenery.json",textures:"/data/textures.json"});const edi={};function start(){gme.sprites={scenery:{},textures:{}};let e="tomb_x";const t=gme.data.scenery.entries[e],i=new ItemEdit({...t,label:e});i.addAnimation(gme.anims.scenery[e]),gme.scenes.add(i,t.scenes),gme.updateBounds(i.position),gme.sprites.scenery[e]=i,edi.ui.textures.display(),edi.zoom.canvas.width=edi.zoom.view.width=GAME.width,edi.zoom.canvas.height=edi.zoom.view.height=GAME.height,edi.zoom.load(),edi.tool.set("zoom"),edi.ui.markers.center=new Marker(0,0),gme.canvas.addEventListener("mousewheel",(function(e){edi.zoom.wheel(e,(function(){gme.ctx.miterLimit=1}))}),!1),edi.ui.selectScene=new UISelect({id:"select-scene",label:"scene:",options:gme.scenes.length?gme.scenes:["game"],selected:gme.scene,callback:function(e){gme.scene=e,edi.ui.reset()}}),fetch("/data/settings.json").then(e=>e.json()).then(e=>{for(const t in e)for(const i in e[t])e[t][i].lock}),edi.ui.settings.load(),gme.scene="game"}function draw(){edi.zoom.clear(gme.ctx),edi.zoom.set(gme.ctx,{x:gme.width/2,y:gme.height/2}),gme.ctx.font="16px monaco",gme.ctx.fillStyle="#bb11ff";for(const e in edi.ui.markers)edi.ui.markers[e].display();gme.scenes.current.display(edi.zoom.view),"ruler"==edi.tool.current&&edi.ruler.display(),edi.zoom.clear(gme.ctx)}function mouseMoved(e,t,i){if(1==i&&edi.zoom.mouseDown){const i=edi.zoom.getDelta(e,t);"transform"==edi.tool.current&&edi.tool.items.length>0?edi.tool.items.all(e=>{e.update({x:Math.round(i.x),y:Math.round(i.y)})}):edi.zoom.updateView(i.x,i.y)}edi.zoom.updatePrevious(e,t),edi.tool.item||intersectItems(e,t,!1)}function mouseDown(e,t,i,s){if(1==i)if("location"==edi.tool.current){const i=edi.zoom.translate(e,t);edi.tool.callback(i.x,i.y)}else{const i=intersectItems(e,t);i&&console.log(i),edi.tool.items.length>0?i&&s?i.select(!0):i&&!s?(edi.tool.clear(),i.select(!0)):i||edi.tool.clear():i&&i.select(!0),i.isSelected?edi.tool.items.add(i):edi.tool.items.remove(i),edi.zoom.mouseDown=!0,edi.zoom.previous.x||(edi.zoom.previous.x=e),edi.zoom.previous.y||(edi.zoom.previous.y=t)}}function mouseUp(e,t,i){1==i&&(edi.zoom.mouseDown=!1)}function intersectItems(e,t,i){for(let i=0;i<gme.scenes.current.displaySprites.length;i++){const s=gme.scenes.current.displaySprites.sprite(i);if(s.isMouseOver(e,t,edi.zoom))return s}return!1}edi.ui=new Interface(edi),edi.ui.load("interface/interface.json"),edi.ui.settings=new Settings(edi,"edi"),edi.ui.textures=new Textures,edi.ui.items=new Items,edi.ui.markers={},edi.zoom=new Zoom,edi.ruler=new Ruler,edi.tool={set:function(e){const t=e.toolName||e;edi.tool.current=t,edi.ui.selectTool.value=t,gme.canvas.className="",gme.canvas.classList.add(t+"-tool")},items:new SpriteCollection,clear:function(){edi.tool.items.all(e=>{e.select(!1)}),edi.tool.items.clear()}},edi.ui.selectTool=new UISelect({id:"select-tool",options:["zoom","transform","ruler","location"],selected:edi.tool.current,callback:edi.tool.set}),edi.ui.reset=function(){for(const e in GAME.sprites)GAME.sprites[e].removeUI();for(const e in GAME.ui)GAME.ui[e].removeUI()},edi.data=new Data(gme,{save:!1,path:"/drawings",files:["scenery","textures"]});
//# sourceMappingURL=src_maps/editor.min.js.map
