function Background(){const e=this;this.show=!0,this.img=new Image,this.x=0,this.y=0,this.width=0,this.height=0,this.size=1,this.rotation=0,this.loadImage=function(n){console.log(n),e.img.src=n,e.img.onload=function(){e.width=e.img.width,e.height=e.img.height}},this.toggle=function(){e.show=!e.show},this.display=function(){this.img.src&&this.show&&(this.rotation>0&&(lns.canvas.ctx.save(),lns.canvas.ctx.rotate(this.rotation*Math.PI/180)),lns.canvas.ctx.drawImage(this.img,this.x,this.y,this.size*this.width,this.height*this.size),this.rotation>0&&lns.canvas.ctx.restore())}}function Canvas(e,n,t,a,s){const i=this;this.canvas=document.getElementById(e),this.dpr=s&&window.devicePixelRatio||1,this.scale=1,this.ctx=this.canvas.getContext("2d"),this.ctx.miterLimit=1,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.lineWidth=1,this.setBGColor=function(e){i.bgColor=e,i.canvas.style.backgroundColor=e},this.setBGColor(a),this.setLineWidth=function(e){i.ctx.lineWidth=i.lineWidth=+e,i.ctx.miterLimit=1,i.ctx.lineCap="round",i.ctx.lineJoin="round"},this.setScale=function(e){i.scale=+e,i.setWidth(i.width),i.setHeight(i.height)},this.setWidth=function(e){i.width=+e,i.canvas.width=+e*i.dpr*i.scale,i.reset()},this.setHeight=function(e){i.height=+e,i.canvas.height=+e*i.dpr*i.scale,i.reset()},this.cursorToggle=function(e){e?lns.canvas.canvas.classList.add("no-cursor"):i.canvas.classList.remove("no-cursor")},this.reset=function(){i.ctx.scale(1,1),i.ctx.scale(i.dpr*i.scale,i.dpr*i.scale),i.canvas.style.zoom=1/i.dpr,i.ctx.lineWidth=i.lineWidth,i.ctx.miterLimit=1,i.ctx.lineCap="round",i.ctx.lineJoin="round"},this.setWidth(n),this.setHeight(t),this.fitCanvasToDrawing=function(){lns.draw.reset();let e=0,n={x:1e4,y:1e4},t={x:0,y:0};for(let a=0;a<lns.anim.layers.length;a++){const s=lns.anim.layers[a],i=lns.anim.drawings[s.drawingIndex];for(let a=0;a<i.length;a++){const r=i.points[a];"end"!==r&&"add"!==r&&(e=Math.max(e,4*s.jiggleRange),n.x=Math.min(n.x,r[0]+s.x),n.y=Math.min(n.y,r[1]+s.y),t.x=Math.max(t.x,r[0]+s.x),t.y=Math.max(t.y,r[1]+s.y))}}lns.ui.faces.width.update(Math.round(t.x-n.x+2*e)),lns.ui.faces.height.update(Math.round(t.y-n.y+2*e));for(let t=0;t<lns.anim.layers.length-1;t++)lns.anim.layers[t].x-=n.x-e>0?n.x-e:0,lns.anim.layers[t].y-=n.y-e>0?n.y-e:0}}function Data(){const e=this;let n=[],t=[],a=[];this.saveStates={current:{drawings:void 0,layers:void 0},prev:{drawings:void 0,layers:void 0}},this.saveState=function(){e.saveStates.current.drawings?(e.saveStates.prev.drawings=_.cloneDeep(e.saveStates.current.drawings),e.saveStates.prev.layers=_.cloneDeep(e.saveStates.current.layers)):(e.saveStates.prev.drawings=_.cloneDeep(lns.anim.drawings),e.saveStates.prev.layers=_.cloneDeep(lns.anim.layers)),e.saveStates.current.drawings=_.cloneDeep(lns.anim.drawings),e.saveStates.current.layers=_.cloneDeep(lns.anim.layers)},this.undo=function(){e.saveStates.prev.drawings?(lns.anim.drawings=_.cloneDeep(e.saveStates.prev.drawings),lns.anim.layers=_.cloneDeep(e.saveStates.prev.layers),e.saveStates.current.drawings=_.cloneDeep(e.saveStates.prev.drawings),e.saveStates.current.layers=_.cloneDeep(e.saveStates.prev.layers),e.saveStates.prev.drawings=void 0,e.saveStates.prev.layers=void 0):console.log("%c Can't undo ","color:lightblue;background:gray;"),lns.ui.drawings.clear(),lns.ui.update()},this.copy=function(){lns.draw.reset(),n=[];for(let e=0;e<lns.anim.layers.length-1;e++)lns.anim.layers[e].isInFrame(lns.anim.currentFrame)&&n.push(lns.anim.layers[e])},this.paste=function(){e.saveState(),0==a.length&&a.push(lns.anim.currentFrame);for(let e=0;e<a.length;e++)for(let t=0;t<n.length;t++){const s=n[t].addIndex(a[e]);s&&lns.anim.addLayer(s)}a=[],lns.draw.reset(),lns.ui.update()},this.addMultipleCopies=function(){n=[];let t=+prompt("Number of copies: ",1);if(e.copy(),t)for(let n=0;n<t;n++)lns.ui.play.next(1),e.paste();lns.ui.update()},this.copyRange=function(){const e=+prompt("Start frame:"),n=+prompt("end frame:");t=[];for(let a=e;a<=n;a++){t[a]=[];for(let e=0;e<lns.anim.layers.length-1;e++)lns.anim.layers[e].isInFrame(a)&&t[a].push(lns.anim.layers[e])}},this.pasteRange=function(){for(let e=0;e<t.length;e++){const n=t[e];if(n)for(let e=0;e<n.length;e++){const t=n[e].addIndex(lns.anim.currentFrame);t&&lns.anim.addLayer(t)}lns.ui.play.next(1)}lns.draw.reset(),lns.ui.update()},this.clearLines=function(){lns.draw.drawing=new Drawing},this.clearLayers=function(){e.saveState();for(let e=lns.anim.layers.length-2;e>=0;e--)lns.anim.layers[e].isInFrame(lns.anim.currentFrame)&&(lns.anim.layers[e].removeIndex(lns.anim.currentFrame,(function(){lns.anim.layers.splice(e,1)})),lns.ui.update())},this.cutTopLayer=function(){for(let e=lns.anim.layers.length-2;e>=0;e--){lns.anim.layers[e].isInFrame(lns.anim.currentFrame)&&(lns.anim.layers[e].removeIndex(lns.anim.currentFrame,(function(){lns.anim.layers.splice(e,1)})),lns.ui.update());break}},this.cutBottomLayer=function(){for(let e=0;e<lns.anim.layers.length-1;e++){lns.anim.layers[e].isInFrame(lns.anim.currentFrame)&&(lns.anim.layers[e].removeIndex(lns.anim.currentFrame,(function(){lns.anim.layers.splice(e,1)})),lns.ui.update());break}},this.clearFrame=function(){e.clearLines(),e.clearLayers()},this.deleteFrame=function(n){void 0!==n||lns.anim.currentFrame;e.saveState();const t=lns.anim.currentFrame;for(let e=lns.anim.layers.length-2;e>=0;e--){const n=lns.anim.layers[e];n.endFrame<t||(n.startFrame===t&&n.endFrame===t?lns.anim.removeLayer(n):n.endFrame>t&&n.startFrame>t?(n.startFrame-=1,n.endFrame-=1):n.endFrame>t&&(n.endFrame-=1),n.resetTweens())}lns.anim.updateStates(),lns.ui.update()},this.deleteFrameRange=function(){e.saveState();const n=+prompt("Start frame:"),t=+prompt("End frame:");if(t>0){for(let a=t;a>=n;a--)e.deleteFrame(a);lns.draw.cutEnd(),lns.ui.play.setFrame(0)}},this.cutLastSegment=function(){lns.draw.pop()},this.cutLastLine=function(){lns.draw.popOff()},this.insert=function(n){lns.draw.reset(),e.saveState();for(let e=0,t=lns.anim.layers.length-1;e<t;e++)lns.anim.layers[e].shiftIndex(lns.anim.currentFrame+n,1),lns.anim.addLayer(lns.anim.layers[e].removeIndex(lns.anim.currentFrame+n));lns.ui.play.next(n),lns.ui.update()},this.quickAnimate=function(e){lns.draw.reset();const n=+prompt("Number of frames?");for(let t=0;t<lns.anim.layers.length-1;t++){const a=lns.anim.layers[t];if(a.isInFrame(lns.anim.currentFrame))switch(a.endFrame=a.startFrame+n,lns.anim.state.end<a.endFrame&&(lns.anim.state.end=a.endFrame),e){case"Draw":a.addTween({prop:"endIndex",startFrame:a.startFrame,endFrame:a.endFrame,startValue:0,endValue:lns.anim.drawings[a.drawingIndex].length});break;case"Reverse":a.addTween({prop:"startIndex",startFrame:a.startFrame,endFrame:a.endFrame,startValue:0,endValue:lns.anim.drawings[a.drawingIndex].length});break;case"DrawReverse":const e=Math.floor(n/2);a.addTween({prop:"endIndex",startFrame:a.startFrame,endFrame:a.startFrame+e,startValue:0,endValue:lns.anim.drawings[a.drawingIndex].length}),a.addTween({prop:"startIndex",startFrame:a.startFrame+e,endFrame:a.endFrame,startValue:0,endValue:lns.anim.drawings[a.drawingIndex].length})}}lns.ui.update()},this.offsetDrawing=function(n){let t=lns.anim.layers.filter((e=>e.isToggled));if(0==t.length&&(t=lns.anim.layers.filter((e=>e.isInFrame(lns.anim.currentFrame)))),lns.draw.reset(),t){if(e.saveState(),n||(n=new Cool.Vector(+prompt("x"),+prompt("y"))),n)for(let e=0;e<t.length;e++)t[e].x+=n.x,t[e].y+=n.y}else console.log("%c No layers in frame ","color:yellow; background:black;")},this.trimDrawing=function(){},this.applyOffset=function(){for(let e=0;e<lns.anim.layers.length;e++){const n=lns.anim.layers[e],t=lns.anim.drawings[n.drawingIndex];for(let e=0;e<t.length;e++)t.points[e][0]+=n.x,t.points[e][1]+=n.y;n.x=0,n.y=0}},this.pruneDrawings=function(){const e=[];for(let n=0;n<lns.anim.drawings.length;n++){lns.anim.drawings[n]&&e.push(n)}for(let n=0;n<lns.anim.layers.length;n++){const t=lns.anim.layers[n],a=e.indexOf(t.drawingIndex);t.drawingIndex=a}for(let e=lns.anim.drawings.length;e>=0;e--)null==lns.anim.drawings[e]&&lns.anim.drawings.splice(e,1)}}function Draw(e){const n=this;if(Object.defineProperty(this,"layer",{get:function(){return lns.anim.layers[lns.anim.layers.length-1]}}),Object.defineProperty(this,"drawing",{get:function(){return lns.anim.drawings[lns.anim.drawings.length-1]},set:function(e){lns.anim.drawings[lns.anim.drawings.length-1]=e}}),lns.anim.drawings.push(new Drawing),lns.anim.layers.push(new Layer({...e,drawingIndex:Math.max(lns.anim.drawings.length-1,0),startFrame:lns.anim.currentFrame})),this.setProperties=function(e,t){for(const a in e)void 0!==n.layer[a]&&(n.layer[a]=e[a],lns.ui.faces[a]&&lns.ui.faces[a].update(e[a],t))},this.setProperty=function(e,t){lns.anim.updateProperty(e,t),n.layer[t]=e},this.setDefaults=function(){n.setProperties(e)},this.reset=function(e){let t=!1;n.drawing?n.drawing.length>0&&(t=!0):t=!0,t&&(lns.anim.drawings.push(new Drawing),lns.ui.faces.color.addColor(n.layer.color),lns.anim.layers.push(new Layer({linesInterval:+lns.ui.faces.linesInterval.value,segmentNum:+lns.ui.faces.segmentNum.value,jiggleRange:+lns.ui.faces.jiggleRange.value,wiggleRange:+lns.ui.faces.wiggleRange.value,wiggleSpeed:+lns.ui.faces.wiggleSpeed.value,color:lns.ui.faces.color.value,drawingIndex:lns.anim.drawings.length-1,startFrame:+e||lns.anim.currentFrame})),lns.data.saveState()),lns.ui.update()},this.cutEnd=function(){let e=0;for(let n=0;n<lns.anim.layers.length-1;n++){const t=lns.anim.layers[n];t.endFrame>e&&(e=t.endFrame)}lns.draw.layer.endFrame>e&&(lns.draw.layer.endFrame=e)},this.hasDrawing=function(){return lns.anim.layers.some((e=>e.isInFrame(lns.anim.currentFrame)&&lns.anim.drawings[e.drawingIndex].length>0))},this.quickColorSelect=function(){const e=new UIModal({title:"Select Color",app:lns,position:lns.mousePosition});e.add(new UIColor({callback:function(e){n.setProperty(e,"color"),lns.ui.faces.color.el.value=e}})),lns.ui.faces.color.colors.forEach((t=>{e.add(new UIButton({text:t,css:{background:t},value:t,callback:function(){n.setProperty(t,"color"),lns.ui.faces.color.el.value=t,e.clear()}}))}))},this.randomColor=function(){const e="#"+Math.floor(16777215*Math.random()).toString(16);n.setProperty(e,"color"),lns.ui.faces.color.el.value=e},this.colorVariation=function(){let e=parseInt(n.layer.color.substr(1),16);e+=Cool.randomInt(-500,500),e=Math.max(0,e);const t="#"+e.toString(16);n.setProperty(t,"color"),lns.ui.faces.color.el.value=t},this.isBrush=!1,this.brushSpreadXLeft=0,this.brushSpreadXRight=0,this.brushSpreadY=0,this.brushRandomX=0,this.brushRandomY=0,this.brushSegmentsMin=1,this.brushSegmentsMax=3,this.startDots=!1,this.dots=10,this.grass=0,this.mouseTimer=performance.now(),this.mouseInterval=30,this.distanceThreshold=5,this.isDrawing=!1,lns.mousePosition=new Cool.Vector,this.prevPosition=new Cool.Vector,this.isErasing=!1,this.eraseDistance=10,this.eraseMethod="points",this.setEraseMethod=function(e){n.eraseMethod=e},this.outSideCanvas=function(e){e.toElement!=lns.canvas.canvas&&(n.isDrawing&&n.reset(),n.isDrawing=!1)},this.pop=function(){n.drawing.length>0&&("end"===n.drawing.pop()&&n.drawing.pop(),n.drawing.add("end"))},this.popOff=function(){if(n.drawing.length>0){n.drawing.pop();for(let e=n.drawing.length-1;e>=0&&("end"!==n.drawing.points[e]&&"add"!==n.drawing.points[e]);e--)n.drawing.pop()}},this.addBrush=function(e,t){let a=new Cool.Vector(e,t);a.divide(lns.canvas.scale),n.drawing.add(a.round());const s=Cool.randomInt(n.brushSegmentsMin,n.brushSegmentsMax);for(let a=1;a<=s;a++){let i=Cool.random(-n.brushSpreadXLeft,n.brushSpreadXRight)*(a/s)*(1-Cool.random(n.brushRandomX)),r=n.brushSpreadY*(a/s)*(1-Cool.random(n.brushRandomY)),l=new Cool.Vector(e+i,t-r);l.divide(lns.canvas.scale),l.x>0&&l.x<lns.canvas.width&&l.y>0&&l.y<lns.canvas.height&&n.drawing.add(l.round())}n.drawing.add("end")},this.addLine=function(e,t){n.drawing.add(new Cool.Vector(e,t).divide(lns.canvas.scale).round())},this.erase=function(e,t){let a=new Cool.Vector(e,t).divide(lns.canvas.scale).round();for(let e=lns.anim.layers.length-1;e>=0;e--){const t=lns.anim.layers[e];if(t.isLocked)continue;if(!t.isInFrame(lns.anim.currentFrame))continue;const s=lns.anim.drawings[t.drawingIndex];for(let e=s.points.length-1;e>=0;e--){const t=new Cool.Vector(s.points[e]);if(a.distance(t)<n.eraseDistance)if("lines"===n.eraseMethod){let n=e,t=e;for(;"end"!==s.points[n]&&n>0;)n--;for(;"end"!==s.points[t]&&t<s.length;)t++;s.points.splice(n,t)}else"points"===n.eraseMethod&&(s.points[e]="end")}if("points"===n.eraseMethod)for(let e=s.points.length-1;e>=0;e--)"end"===s.points[e]&&"end"===s.points[e-1]&&s.points.splice(e,1),"end"===s.points[e+1]&&"end"===s.points[e-1]&&s.points.splice(e,1),"end"===s.points[e]&&0===e&&s.points.splice(e,1);0===s.points.length&&e!==lns.anim.layers.length-1?t.removeIndex(lns.anim.currentFrame,(function(){lns.anim.layers.splice(e,1),n.reset()})):s.update(t.drawProps)}},this.update=function(e){performance.now()>n.mouseInterval+n.mouseTimer&&(n.mouseTimer=performance.now(),lns.mousePosition.x=e.pageX,lns.mousePosition.y=e.pageY,n.isDrawing?n.isBrush?n.addBrush(Math.round(e.offsetX),Math.round(e.offsetY)):lns.mousePosition.distance(n.prevPosition)>n.distanceThreshold&&(n.addLine(Math.round(e.offsetX),Math.round(e.offsetY)),n.prevPosition=lns.mousePosition.clone()):n.isErasing&&n.erase(Math.round(e.offsetX),Math.round(e.offsetY)))},this.start=function(e){e.preventDefault(),e.which>=2&&(n.isErasing=!0),1!=e.which||lns.render.isPlaying||e.altKey?e.altKey&&(n.startDots=new Cool.Vector(Math.round(e.offsetX),Math.round(e.offsetY))):e.ctrlKey?n.isErasing=!0:(n.isDrawing=!0,n.mouseTimer=performance.now(),n.isBrush?n.addBrush(Math.round(e.offsetX),Math.round(e.offsetY)):(n.addLine(Math.round(e.offsetX),Math.round(e.offsetY)),n.prevPosition=lns.mousePosition.clone()))},this.end=function(e){if(n.isErasing=!1,n.startDots){const t=Math.abs(n.startDots.x-e.offsetX),a=Math.abs(n.startDots.y-e.offsetY),s=t/a,i=t/(s*n.dots/2),r=a/(1/s*n.dots/2);let[l,o]=n.startDots.x<e.offsetX?[n.startDots.x,e.offsetX]:[e.offsetX,n.startDots.x],[d,c]=n.startDots.y<e.offsetY?[n.startDots.y,e.offsetY]:[e.offsetY,n.startDots.y];for(let e=l;e<o;e+=i)for(let t=d;t<c;t+=r){const a=Math.round(e)+Cool.randomInt(-i/2,i/2),s=Math.round(t)+Cool.randomInt(-r/2,r/2),l=Cool.randomInt(1,3);for(let e=0;e<l;e++)n.drawing.add(new Cool.Vector(a+Cool.randomInt(-1,1),s+Cool.randomInt(-1,1)));n.drawing.add("end")}n.startDots=!1}else if(1==e.which){n.isDrawing=!1;let t=n.drawing.get(-2);"end"!==t&&"add"!==t&&n.drawing.length>1?n.drawing.add(e.shiftKey?"add":"end"):n.drawing.pop()}n.prevPosition=void 0},window.navigator.platform.includes("iPad")){const a={which:1},s=window.devicePixelRatio;function t(e,n){if(e.preventDefault(),e.touches[0]){const t=e.target.getBoundingClientRect();a.offsetX=e.targetTouches[0].pageX-t.left/s,a.offsetY=e.targetTouches[0].pageY-t.top/s,a.which=1,n(a)}}lns.canvas.canvas.addEventListener("touchstart",(e=>{t(e,n.start)})),lns.canvas.canvas.addEventListener("touchmove",(e=>{t(e,n.update)})),lns.canvas.canvas.addEventListener("touchend",(e=>{n.end(a)}))}else window.PointerEvent?(lns.canvas.canvas.addEventListener("pointermove",n.update),lns.canvas.canvas.addEventListener("pointerdown",n.start),lns.canvas.canvas.addEventListener("pointerup",n.end)):(lns.canvas.canvas.addEventListener("mousemove",n.update),lns.canvas.canvas.addEventListener("mousedown",n.start),lns.canvas.canvas.addEventListener("mouseup",n.end));document.addEventListener("mousemove",n.outSideCanvas)}function Files(e){const n=this;this.saveFilesEnabled=!1,this.saveSettingsOnUnload=e.save||!1,this.fileName=void 0,this.saveFile=function(t,a){lns.draw.reset(),lns.ui.play.checkEnd(),lns.anim.drawings.pop(),lns.anim.layers.pop(),n.fileName=lns.ui.faces.title.value||prompt("Name this file:"),e.fit&&confirm("Fit canvas?")&&lns.canvas.fitCanvasToDrawing();const s={v:"2.5",w:+lns.canvas.width,h:+lns.canvas.height,fps:+lns.anim.fps,mc:[...new Set(lns.anim.layers.map((e=>e.color)))].length>1};e.bg&&(s.bg=lns.canvas.bgColor),t?(s.l=_.cloneDeep(lns.anim.layers.filter((e=>e.isInFrame(lns.anim.currentFrame)))),s.l=s.l.map((e=>(e.startFrame=0,e.endFrame=0,e.getSaveProps())))):s.l=lns.anim.layers.map((e=>e.getSaveProps()));const i=new Set(s.l.map((e=>e.d)));s.d=[];for(let e=0;e<lns.anim.drawings.length;e++)s.d[e]=i.has(e)?lns.anim.drawings[e].points.map((e=>"end"===e?0:"add"===e?1:[Math.round(e[0]),Math.round(e[1])])):null;if(lns.ui.timeline.groups.length>0&&(s.g=[...lns.ui.timeline.groups]),Object.keys(lns.anim.states).length>1){s.s={};for(const e in lns.anim.states)"default"!=e&&(s.s[e]=[lns.anim.states[e].start,lns.anim.states[e].end])}const r=JSON.stringify(s);if(n.fileName){const e=new Blob([r],{type:"application/x-download;charset=utf-8"});saveAs(e,`${n.fileName}${t?"-"+lns.anim.frame:""}.json`),setTimeout(a,500),lns.ui.faces.title.value=n.fileName}},this.saveFramesToFiles=function(){let e=0;!function t(){e<=lns.anim.endFrame&&(lns.anim.frame=e,n.saveFile(!0,(()=>{e++,t()})))}()},this.loadFile=function(e){n.fileName=e,n.fileName&&(".json"!==n.fileName.slice(n.fileName.length-5)&&(n.fileName+=".json"),fetch(n.fileName).then((e=>e.json())).then((t=>{n.loadJSON(t,e.split("/").pop())})).catch((e=>{console.error(e)})))},this.loadJSON=function(e,n){lns.anim=new Lines(lns.canvas.ctx,lns.render.dps,!0),lns.anim.loadData(e,(function(){lns.canvas.setWidth(e.w),lns.canvas.setHeight(e.h),lns.ui.faces.fps.update(e.fps),e.bg&&lns.canvas.setBGColor(e.bg),e.g&&(lns.ui.timeline.groups=[...e.g]),lns.draw.reset()})),lns.ui.faces.title.value=n,lns.ui.faces.fps.value=e.fps,document.title=n+" ~ animate",lns.ui.faces.width.value=e.w,lns.ui.faces.height.value=e.h,lns.anim.layers.forEach((e=>{e&&(lns.ui.faces.color.addColor(e.color),lns.ui.faces.color.value=e.color)})),e.bg&&(lns.ui.faces.bgColor.value=e.bg),lns.ui.update()},this.reOpenFile=function(){n.saveFile({},(function(e){location.href+=`?src=/${prompt("Enter location:")}/${e}.json`}))},this.openFile=function(){const e=document.createElement("input");e.type="file",e.click(),e.onchange=function(){n.readFile(e.files)}},this.readFile=function(e,t){for(let t,a=0;t=e[a];a++){if(!t.type.match("application/json"))continue;const e=new FileReader;e.onload=function(e){n.fileName=t.name.split(".")[0],n.loadJSON(JSON.parse(e.target.result),n.fileName)},e.readAsText(t)}},window.File&&window.FileReader&&window.FileList&&window.Blob&&(n.saveFilesEnabled=!0,console.log("%c Save file enabled ","color:lightgreen;background:black;"),lns.canvas.canvas.addEventListener("dragover",(function(e){e.preventDefault()})),lns.canvas.canvas.addEventListener("drop",(function(e){e.preventDefault(),e.stopPropagation(),n.readFile(e.dataTransfer.files,lns.ui.updateFIO)}))),window.addEventListener("beforeunload",(function(t){n.saveSettingsOnUnload&&lns.ui.settings.saveSettings(),e.reload&&(t.returnValue="Did you save dumbhole?")}))}function Render(e,n){const t=this;this.showStats=n,this.dps=e||30,this.interval=1e3/this.dps,this.timer=performance.now(),window.drawCount=0,this.onionSkinNum=0,this.onionSkinIsVisible=!1,this.toggleStats=function(e){void 0!==e&&(t.showStats=e),!t.stats&&t.showStats&&(t.stats=new Stats,t.stats.dom.style.position="absolute",t.stats.dom.style.top="-48px",t.stats.dom.style.right="0",t.stats.dom.style.left="auto",lns.ui.panels.play.el.appendChild(lns.render.stats.dom)),t.stats&&(t.stats.dom.style.display=t.showStats?"block":"none")},this.reset=function(){lns.anim.frame=0,lns.anim.isPlaying=!1,lns.canvas.ctx.miterLimit=1,lns.ui.update()},this.toggle=function(){lns.anim.isPlaying?lns.draw.layer.startFrame=lns.draw.layer.endFrame=lns.anim.currentFrame:(lns.ui.play.checkEnd(),lns.draw.reset()),lns.anim.isPlaying=!lns.anim.isPlaying,lns.ui.timeline.update()},this.setDps=function(e){t.dps=+e,t.interval=1e3/t.dps,lns.anim.dps=t.dps},this.setFps=function(e){lns.anim.fps=+e},this.clearCount=0,this.clearInterval=0,this.update=function(e){if(t.showStats&&t.stats.begin(),performance.now()>t.interval+t.timer||"cap"==e){if(t.timer=performance.now(),lns.anim.isPlaying&&lns.ui.timeline.update(),t.clearCount===t.clearInterval?(lns.canvas.ctx.clearRect(0,0,lns.canvas.width,lns.canvas.height),t.clearCount=0):t.clearCount++,lns.ui.capture.bg&&(lns.ui.capture.frames>0||lns.ui.capture.isVideo)&&(lns.canvas.ctx.fillStyle=lns.canvas.bgColor,lns.canvas.ctx.fillRect(0,0,lns.canvas.width,lns.canvas.height)),lns.bgImage.display(),t.onionSkinNum>0&&t.onionSkinIsVisible){const e=lns.anim.currentFrame;for(let n=1;n<=t.onionSkinNum;n++){const a=e-n;a>=0&&(lns.anim.currentFrame=a,lns.anim.overrideProperty("color",`rgba(105,150,255,${1.5-n/t.onionSkinNum})`),lns.anim.draw())}lns.anim.cancelOverride(),lns.anim.currentFrame=e}if(lns.anim.layers.some((e=>e.isHighlighted))){lns.anim.overrideProperty("color","#94dfe3");for(let e=0,n=lns.anim.layers.length-1;e<n;e++){const n=lns.anim.layers[e];n.isInFrame(lns.anim.currentFrame)&&n.isHighlighted||(n.dontDraw=!0)}lns.canvas.ctx.lineWidth=5,lns.anim.draw(0,0,!0),lns.anim.cancelOverride(),lns.canvas.ctx.lineWidth=lns.canvas.lineWidth,lns.anim.layers.filter((e=>e.dontDraw)).forEach((e=>{e.dontDraw=!1}))}lns.anim.update(),lns.anim.draw(),window.drawCount++}lns.ui.capture.isCapturing||window.requestAnimFrame(t.update),t.showStats&&t.stats.end()},this.start=function(){window.requestAnimFrame(t.update)}}const LayerMixin={init(e){this.isToggled=!1,this.isLocked=!1,this.isHighlighted=!1,this.groupNumber=void 0!==e.groupNumber?e.groupNumber:-1},reset(){this.isToggled=!1,this.isLocked=!1,this.isHighlighted=!1,this.highlightColor="#94dfe3"},toggle(){this.isToggled=!this.isToggled},isInFrame(e){return e>=this.startFrame&&e<=this.endFrame&&!this.dontDraw},addTween(e){this.tweens.push(e),e.startFrame<this.startFrame&&(this.startFrame=e.startFrame),e.endFrame>this.endFrame&&(this.endFrame=e.endFrame),"default"==lns.anim.stateName&&lns.anim.state.end<this.endFrame&&(lns.anim.state.end=this.endFrame)},resetTweens(){for(let e=0;e<this.tweens.length;e++){const n=this.tweens[e];n.startFrame<this.startFrame&&(n.startFrame=this.startFrame),n.endFrame>this.endFrame&&(n.endFrame=this.endFrame)}},addIndex(e){if(!this.isInFrame(e))if(this.startFrame-1==e)this.startFrame-=1;else{if(this.endFrame+1!=e)return new Layer({...this.getCloneProps(),startFrame:e,endFrame:e});this.endFrame+=1}return this},removeIndex(e,n){if(this.startFrame===e&&this.endFrame===e)n();else if(this.startFrame===e)this.startFrame+=1;else{if(this.endFrame!==e){if(e>this.startFrame&&e<this.endFrame){const n=new Layer(this.getCloneProps());return n.startFrame=e+1,n.endFrame=this.endFrame,n.resetTweens(),this.endFrame=e-1,this.resetTweens(),n}return this}this.endFrame-=1}this.resetTweens()},shiftIndex(e,n){return n||(n=-1),this.startFrame>=e&&(this.startFrame+=n),this.endFrame>=e&&(this.endFrame+=n),this.resetTweens(),this},resetDrawingEndIndex(e){this.drawingEndIndex=e},getSaveProps(){const e={n:this.segmentNum,r:this.jiggleRange,w:this.wiggleRange,v:this.wiggleSpeed,ws:this.wiggleSegments,c:this.color,f:[this.startFrame,this.endFrame],d:this.drawingIndex,b:this.breaks,l:this.linesInterval,g:this.groupNumber};return this.x&&(e.x=this.x),this.y&&(e.y=this.y),this.tweens&&(e.t=this.tweens.map((e=>[e.prop,e.startFrame,e.endFrame,e.startValue,e.endValue]))),e},getEditProps(){return{segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,linesInterval:this.linesInterval,breaks:this.breaks,color:this.color}},getTweenProps(){return{segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,linesInterval:this.linesInterval,startIndex:this.drawingStartIndex,endIndex:this.drawingEndIndex}},getCloneProps(){return props={drawingIndex:this.drawingIndex,segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,breaks:this.breaks,linesInterval:this.linesInterval,x:this.x,y:this.y,color:this.color,drawingStartIndex:this.drawingStartIndex,drawingEndIndex:this.drawingEndIndex,startFrame:this.startFrame,endFrame:this.endFrame,groupNumber:this.groupNumber}}},LinesMixin={updateProperty(e,n){for(let t=0;t<this.layers.length-1;t++)this.layers[t].isToggled&&(this.layers[t][n]=e)},addLayer(e){-1==this.layers.indexOf(e)&&this.layers.splice(lns.anim.layers.length-1,0,e)},removeLayer(e){const n=this.layers.indexOf(e);n>=0&&this.layers.splice(n,1)},updateStates(){for(const e in this.states)this.states[e].end>this.endFrame&&(this.states[e].end=this.endFrame)}};class UILayer extends UICollection{constructor(e,n){super(n),this.addClass("layer"),this.layer=e,n.canMoveUp&&(this.canMoveUp=n.canMoveUp);const t=this;this.toggle=new UIToggle({type:"layer-toggle",class:"timeline-btn",text:`${e.drawingIndex}`,isOn:e.isToggled,callback:function(n){e.isToggled=void 0!==n?n:!e.isToggled,e.isToggled&&lns.draw.setProperties(e.getEditProps(),!0),t.highlight.update(e.isToggled)}}),this.highlight=new UIToggle({type:"layer-highlight",class:"timeline-btn",text:"*",isOn:e.isHighlighted,callback:function(n){e.isHighlighted=void 0!==n?n:!e.isHighlighted}}),this.edit=new UIButton({type:"layer-edit",class:"timeline-btn",text:"E",callback:()=>{const n=new UIModal({title:"Edit Layer",app:lns,position:this.position,callback:()=>{lns.ui.update()}});n.add(new UIButton({text:"Cut Segment",callback:()=>{const n=lns.anim.drawings[e.drawingIndex];n.pop(),n.pop(),n.add("end"),e.resetDrawingEndIndex(n.length)}})),n.add(new UIButton({text:"Cut Line",callback:()=>{const n=lns.anim.drawings[e.drawingIndex];n.pop();for(let e=n.length-1;e>0&&"end"!==n.get(e)[0];e--)n.pop();e.resetDrawingEndIndex(n.length)}})),n.add(new UIButton({text:"Clone",callback:()=>{const n=e.getCloneProps();n.startFrame=n.endFrame=e.endFrame+1,lns.anim.addLayer(new Layer(n)),lns.ui.play.setFrame(e.endFrame+1)}})),n.add(new UIButton({text:"Split",callback:()=>{const n=e.getCloneProps();n.startFrame=lns.anim.currentFrame+1,e.endFrame=lns.anim.currentFrame,lns.anim.addLayer(new Layer(n)),lns.ui.play.setFrame(e.endFrame+1)}})),n.addBreak("Start Frame:"),n.add(new UINumber({value:e.startFrame,callback:function(n){e.startFrame=+n}})),n.addBreak("End Frame:"),n.add(new UINumber({value:e.endFrame,callback:function(n){e.endFrame=+n}})),n.adjustPosition()}}),this.tween=new UIButton({text:"T",class:"timeline-btn",type:"layer-tween",callback:()=>{const n={prop:"endIndex",startFrame:lns.anim.currentFrame,endFrame:lns.anim.currentFrame+10,startValue:0,endValue:"end"},t=new UIModal("Add Tween",lns,this.position,(function(){n.endValue=lns.anim.drawings[e.drawingIndex].length,e.addTween(n),lns.ui.update()}));t.addBreak("Property:"),t.add(new UISelect({options:Object.keys(e.getTweenProps()),value:"endIndex",selected:"endIndex",callback:function(e){n.prop=e}})),t.addBreak("Start Frame:"),t.add(new UINumber({value:n.startFrame,callback:function(e){n.startFrame=+e}})),t.addBreak("End Frame:"),t.add(new UINumber({value:n.endFrame,callback:function(e){n.endFrame=+e}})),t.addBreak("Start Value:"),t.add(new UINumber({value:n.startValue,callback:function(e){n.startValue=+e}})),t.addBreak("End Value:"),t.add(new UINumber({value:n.endValue,callback:function(e){n.endValue=+e}}))}}),this.remove=new UIButton({type:"remove",text:"X",class:"timeline-btn",callback:()=>{lns.anim.layers.splice(lns.anim.layers.indexOf(e),1),lns.ui.update()}}),this.startFrameNumber=new UINumberStep({value:e.startFrame,class:"timeline-btn",min:0,max:lns.anim.endFrame+1,callback:n=>{e.startFrame=+n,+n>e.endFrame&&(e.endFrame=+n),lns.ui.update()}}),this.endFrameNumber=new UINumberStep({value:e.endFrame,class:"timeline-btn",min:0,callback:n=>{e.endFrame=+n,+n<e.startFrame&&(e.startFrame=+n),lns.ui.update()}}),this.lock=new UIToggle({type:"layer-lock",text:"L",class:"timeline-btn",isOn:e.isLocked,callback:function(){e.isLocked=!e.isLocked}}),this.moveUp=new UIButton({text:"^",type:"move-up",class:"timeline-btn",callback:n.moveUp}),this.addToGroup=new UIButton({text:"G",type:"add-to-group",class:"timeline-btn",callback:()=>{n.addToGroup(this.position)}}),this.setup(n.width)}setup(e){e>20&&this.append(this.startFrameNumber),this.append(this.toggle),this.append(this.highlight),e>40&&this.append(this.edit),e>50&&this.append(this.lock),e>60&&this.append(this.tween),e>70&&this.append(this.remove),e>80&&this.append(this.addToGroup),e>90&&this.canMoveUp&&this.append(this.moveUp),e>80&&(this.append(this.endFrameNumber),this.endFrameNumber.addClass("right-margin"))}get html(){return this.el}}class UITimelineGroup extends UICollection{constructor(e,n){super(n),this.index=n.index,this.layers=e,this.addClass("group"),this.startFrame=n.startFrame,this.endFrame=n.endFrame,this.isToggled=!1;const t=this;this.breakUp=new UIButton({type:"group-breakup",class:"timeline-btn",text:"X",callback:function(){e.forEach((e=>{e.groupNumber=-1})),lns.ui.update()}}),this.toggle=new UIToggle({type:"group-toggle",class:"timeline-btn",text:n.name,isOn:this.isToggled,callback:function(n){t.isToggled=void 0!==n?n:!t.isToggled,e.forEach((e=>{e.toggle(t.isToggled),e.isHighlighted=t.isToggled}))}}),this.highlight=new UIToggle({type:"group-highlight",class:"timeline-btn",text:"*",isOn:!1,callback:function(){e.forEach((e=>{e.isHighlighted=!e.isHighlighted}))}}),this.lock=new UIToggle({type:"group-lock",text:"L",class:"timeline-btn",isOn:!1,callback:function(){e.forEach((e=>{e.isLocked=!e.isLocked}))}}),this.edit=new UIButton({type:"layer-edit",class:"timeline-btn",text:"E",callback:()=>{const t=new UIModal({title:"Edit Layer",app:lns,position:this.position,callback:()=>{lns.ui.update()}});t.addBreak("Start Frame:"),t.add(new UINumber({value:n.startFrame,callback:function(n){e.forEach((e=>{e.startFrame=+n}))}})),t.addBreak("End Frame:"),t.add(new UINumber({value:n.endFrame,callback:function(n){e.forEach((e=>{e.endFrame=+n}))}})),t.adjustPosition()}}),this.removeLayer=new UIButton({type:"group-remove-layer",class:"timeline-btn",text:"R",callback:()=>{const e=function(){lns.ui.timeline.resetLayers(),lns.ui.update()},n=new UIModal({title:"Remove Layers",app:lns,position:this.position,callback:e,onClear:e});for(let e=0,t=lns.anim.layers.length;e<t;e++){if(lns.anim.layers[e].groupNumber!==this.index)continue;const t=lns.anim.layers[e],a=new UIButton({text:`Layer ${e}, Drawing ${t.drawingIndex}`,callback:function(){t.groupNumber=-1,n.remove(a)}});n.add(a)}}}),this.startFrameNumber=new UINumberStep({value:this.startFrame,class:"timeline-btn",min:0,callback:n=>{e.forEach((e=>{e.startFrame=+n,+n>e.endFrame&&(e.endFrame=+n)})),lns.ui.update()}}),this.endFrameNumber=new UINumberStep({value:this.endFrame,class:"timeline-btn",min:0,callback:n=>{e.forEach((e=>{e.endFrame=+n,+n<e.startFrame&&(e.startFrame=+n)})),lns.ui.update()}}),this.setup(n.width)}setup(e){e>20&&this.append(this.startFrameNumber),this.append(this.toggle),this.append(this.highlight),e>40&&this.append(this.edit),e>50&&this.append(this.lock),e>60&&this.append(this.breakUp),e>70&&this.append(this.removeLayer),e>80&&(this.append(this.endFrameNumber),this.endFrameNumber.addClass("right-margin"))}}class UITween extends UICollection{constructor(e,n,t){super(e),this.addClass("tween"),this.tween=n,this.edit=new UIButton({text:"✎",type:"tween-edit",callback:()=>{const e=new UIModal({title:"Edit Tween",app:lns,position:this.position,callback:function(){lns.ui.update()}});e.addBreak("Start Frame:"),e.add(new UINumber({value:n.startFrame,callback:function(e){n.startFrame=+e}})),e.addBreak("End Frame:"),e.add(new UINumber({value:n.endFrame,callback:function(e){n.endFrame=+e}})),e.addBreak("Start Value:"),e.add(new UINumber({value:n.startValue,callback:function(e){n.startValue=+e}})),e.addBreak("End Value:"),e.add(new UINumber({value:n.endValue,callback:function(e){n.endValue=+e}}))}}),this.left=new UIDragButton({text:"⬗",type:"left",callback:(e,t)=>{n.startFrame+=(e||-1)*(t||1),lns.ui.update()}}),this.right=new UIDragButton({text:"⬖",type:"right",callback:(e,n)=>{this.tween.endFrame+=(e||1)*(n||1),lns.ui.update()}}),this.remove=new UIButton({type:"remove",text:"🗑",callback:()=>{t.tweens.splice(t.tweens.indexOf(this),1),lns.ui.update()}}),this.append(this.edit),this.append(this.remove),this.append(this.left),this.append(this.right)}get html(){return this.el}}function AnimatorInterface(){const e=this;let n;this.add=function(){n=new Animator(lns.anim),lns.anim.onPlayedState=function(){n.update()},function(){for(const t in n.params){const a=e.panel.addRow(),s=n.params[t];e.panel.add(new UILabel({text:t}),a);const i=e.panel.addRow();e.panel.add(new UINumber({text:"Min",value:s[0],callback:function(e){s[0]=+e}}),i,"min"),e.panel.add(new UINumber({text:"Max",value:s[1],callback:function(e){s[1]=+e}}),i,"max")}}()},this.remove=function(){n=void 0,lns.anim.onPlayedState=void 0;for(let n=e.panel.rows.length-1;n>0;n--)e.panel.rows[n].clear(),e.panel.removeRow(e.panel.rows[n])}}function Capture(e){const n=this;let t=e.useSequentialNumbering||!1,a=0;this.videoBitsPerSecond=8e6,this.isReady=!0,this.prev={f:void 0,n:0},this.frames=0,this.bg=!0,this.isCapturing=!1,this.isVideo=!1;let s=0;this.lineWidth=e.captureSettings.lineWidth||lns.canvas.lineWidth,this.canvasScale=e.captureSettings.canvasScale||lns.canvas.scale,this.one=function(){n.frames=1,n.start()},this.multiple=function(){n.frames=+prompt("Capture how many frames?"),n.start()},this.start=function(){a=0,lns.anim.onDraw=function(){n.frames>0?(n.capture(),n.frames--,n.isCapturing=!0):n.isCapturing&&(n.isCapturing=!1,lns.anim.isPlaying=!1,lns.anim.onDraw=void 0)}},this.cycle=function(){lns.draw.reset(),lns.anim.frame=lns.anim.endFrame,lns.anim.isPlaying=!0,n.frames=lns.anim.endFrame*Math.max(1,lns.render.dps/lns.anim.fps)+1,n.start()},this.capture=function(){if(lns.files.saveFilesEnabled)lns.canvas.canvas.toBlob((e=>{const s=lns.ui.faces.title.value,i=Cool.padNumber(lns.anim.currentFrame,3);let r;t?(r=`${s}-${Cool.padNumber(a,4)}.png`,a++):(i===n.prev.f?n.prev.n+=1:n.prev.n=0,r=`${s}-${i}-${n.prev.n}.png`,n.prev.f=i);saveAs(e,r).onwriteend=function(){setTimeout((()=>{window.requestAnimFrame((()=>{lns.render.update("cap")}))}),100)}}));else{const e=n.canvas.toDataURL("image/png").replace("image/png","image/octet-stream");window.location.href=e}},this.videoLoop=function(){lns.anim.isPlaying=!1,lns.anim.frame=0,lns.ui.faces.videoLoop.addClass("progress"),s=+prompt("Number of loops?",1),lns.anim.onDraw=function(){lns.ui.faces.videoLoop.setProp("--progress-percent",Math.round(100*lns.anim.currentFrame/lns.anim.endFrame))},lns.anim.onPlayedState=function(){s>1?s--:n.isVideo&&(n.video(),n.isVideo=!1,lns.anim.isPlaying=!1,lns.anim.onPlayedState=void 0,lns.ui.faces.videoLoop.removeClass("progress"),lns.anim.onDraw=void 0)},n.isVideo=!0,n.bg=!0,n.video(),lns.anim.isPlaying=!0},this.videoFrames=function(e){let t=+prompt("Number of frames?",48);n.frames=t,lns.anim.isPlaying=!1,e&&(lns.anim.frame=0),n.video(!0);const a="videoFrame"+(e?"s":"");lns.ui.faces[a].addClass("progress"),lns.anim.onDraw=function(){n.frames>0?(n.frames--,lns.ui.faces[a].setProp("--progress-percent",Math.round(100*(1-n.frames/t)))):n.isVideo&&(n.video(),e&&lns.anim.currentFrame<lns.anim.endFrame?(n.frames=t,lns.ui.play.next(1),n.video(!0)):(lns.anim.onDraw=void 0,lns.ui.faces[a].removeClass("progress")))}},this.video=function(t){if(n.isReady){if(e.captureSettings)for(const t in e.captureSettings)lns.ui.faces[t].update(n[t]);lns.ui.faces.onionSkinIsVisible.update(!1),n.isReady=!1,n.isVideo=!0;const a=lns.canvas.canvas.captureStream(lns.render.dps);n.rec=new MediaRecorder(a,{videoBitsPerSecond:n.videoBitsPerSecond,mimeType:"video/webm;codecs=vp8,opus"}),n.rec.start(),n.rec.addEventListener("dataavailable",(e=>{const n=new Blob([e.data],{type:"video/webm"}),a=URL.createObjectURL(n),s=document.createElement("a");document.body.appendChild(s),s.href=a;let i=`${lns.ui.faces.title.value}`||"lines";t&&(i=prompt("Title?",lns.ui.faces.title.value)),s.download=`${i}.webm`,s.click()}))}else n.isVideo=!1,n.isReady=!0,n.rec.stop()}}function Drawings(){const e=this;function n(e){const n=lns.anim.layers.filter(((n,t)=>t<lns.anim.layers.length-1&&n.drawingIndex==e));if(n.length>0){for(let e=0;e<n.length;e++)if(n[e].isInFrame(lns.anim.currentFrame))return n[e];for(let e=0;e<n.length;e++)if(n[e].isInFrame(lns.anim.currentFrame+1)||n[e].isInFrame(lns.anim.currentFrame-1))return n[e];return n[0]}return!1}this.update=function(){e.panel.drawings.clear();for(let t=0;t<lns.anim.drawings.length-1;t++)if(lns.anim.drawings[t]){let a=n(t);e.panel.drawings.append(new UIToggle({text:t,isOn:!!a&&a.isInFrame(lns.anim.currentFrame),callback:function(e){let a=n(t);if(e)if(a)if(a.isInFrame(lns.anim.currentFrame)||a.isInFrame(lns.anim.currentFrame-1)||a.isInFrame(lns.anim.currentFrame+1))a.addIndex(lns.anim.currentFrame);else{const e=a.getCloneProps();e.startFrame=e.endFrame=lns.anim.currentFrame,lns.anim.addLayer(new Layer(e))}else lns.anim.addLayer(new Layer({drawingIndex:t,linesInterval:+lns.ui.faces.linesInterval.value,segmentNum:+lns.ui.faces.segmentNum.value,jiggleRange:+lns.ui.faces.jiggleRange.value,wiggleRange:+lns.ui.faces.wiggleRange.value,wiggleSpeed:+lns.ui.faces.wiggleSpeed.value,color:lns.ui.faces.color.value,startFrame:lns.anim.currentFrame}));else if(a&&a.isInFrame(lns.anim.currentFrame)){const e=a.removeIndex(lns.anim.currentFrame,(function(){lns.anim.removeLayer(a)}));e&&lns.anim.addLayer(e)}lns.ui.update()}}),t)}},this.clear=function(){e.panel.drawings.clear()}}function Palette(){const e=this;this.palettes={};let n=1;this.add=function(){lns.draw.reset();const n=e.current=prompt("Name this palette.");n&&(e.palettes[n]={color:lns.draw.layer.color,segmentNum:lns.draw.layer.segmentNum,jiggleRange:lns.draw.layer.jiggleRange,wiggleRange:lns.draw.layer.wiggleRange,wiggleSpeed:lns.draw.layer.wiggleSpeed,wiggleSegments:lns.draw.layer.wiggleSegments,breaks:lns.draw.layer.breaks,linesInterval:lns.draw.layer.linesInterval,lineWidth:lns.canvas.ctx.lineWidth,mouseInterval:lns.draw.mouseInterval,brush:lns.draw.brush,brushSpread:lns.draw.brushSpread,dots:lns.draw.dots,grass:lns.draw.grass},e.addUI(n))},this.addUI=function(t){e.panel.addRow(t);const a=new UIButton({text:t,callback:function(){e.load(t)}});e.panel.add(a);let s="+";n<10&&(lns.ui.keys[n]=a,s=n+"",n++);const i=new UIText({text:s,callback:function(e){lns.ui.keys[+e].key.value="",lns.ui.keys[+e].key.el.placeholder="+",lns.ui.keys[+e]=a}});a.key=i,e.panel.add(i),e.panel.add(new UIButton({text:"✎",callback:function(){const n=prompt("Rename: ");e.palettes[n]=_.cloneDeep(e.palettes[t]),e.addUI(n),e.remove(t)}})),e.panel.add(new UIButton({text:"X",callback:function(){e.remove(t)}}))},this.remove=function(n){delete e.palettes[n],e.panel[n].clear()},this.setup=function(n){for(const t in n)"current"!=t&&(e.addUI(t),e.palettes[t]=n[t]);n.current&&e.load(n.current)},this.load=function(n){lns.draw.reset(),e.palettes.current=n;const t=e.palettes[n];for(prop in t)void 0!==lns.ui.faces[prop]&&lns.ui.faces[prop].update(t[prop])},this.buildFromAnimation=function(){for(let n=0;n<lns.anim.layers.length;n++){const t=`Layer ${n}`,a=lns.anim.layers[n],s={color:a.color,segmentNum:a.segmentNum,jiggleRange:a.jiggleRange,wiggleRange:a.wiggleRange,wiggleSpeed:a.wiggleSpeed,wiggleSegments:a.wiggleSegments,linesInterval:lns.draw.layer.linesInterval,breaks:a.breaks,lineWidth:lns.canvas.ctx.lineWidth,mouseInterval:lns.draw.mouseInterval,brush:0,brushSpread:lns.draw.brushSpread,dots:lns.draw.dots,grass:lns.draw.grass};let i=!1;for(const n in e.palettes){const t=e.palettes[n];let a=!0;for(const e in t)t[e]!==s[e]&&(a=!1);a&&(i=!0)}i||(e.palettes[t]=s,e.addUI(t))}},this.quickSelect=function(n){const t=new UIModal({title:"Select Pallette",app:lns,position:lns.mousePosition});for(const n in e.palettes)"current"!==n&&t.add(new UIButton({text:n,callback:function(){e.load(n),t.clear()}}))},this.saveFile=function(){const n=JSON.stringify(e.palettes),t=prompt("Name:"),a=new Blob([n],{type:"application/x-download;charset=utf-8"});saveAs(a,`${t}.json`)},this.loadFile=function(){const n=document.createElement("input");n.type="file",n.click(),n.onchange=function(){for(let t,a=0;t=n.files[a];a++){if(!t.type.match("application/json"))continue;const n=new FileReader;n.onload=function(n){console.log(n.target.result),e.setup(JSON.parse(n.target.result))},n.readAsText(t)}}}}function Play(){const e=this;this.setFrame=function(e){+e<=lns.anim.endFrame+1&&+e>=0?(lns.anim.frame!==+e&&lns.draw.reset(),lns.anim.frame=+e,lns.draw.layer.startFrame=lns.anim.currentFrame,lns.draw.layer.endFrame=lns.anim.currentFrame,lns.ui.update()):lns.ui.faces.frameDisplay.update(lns.anim.currentFrame,!0)},this.checkEnd=function(){lns.anim.currentFrame!=lns.anim.endFrame||lns.draw.hasDrawing()||e.next(-1)},this.next=function(e){const n=lns.anim.currentFrame+e;lns.anim.isPlaying&&lns.ui.faces.play.update(),lns.draw.isDrawing=!1,lns.draw.drawing.length>0?(lns.draw.reset(n),lns.anim.frame=n):(e>0&&(lns.anim.currentFrame<lns.anim.state.end||"default"==lns.anim.stateName&&lns.draw.hasDrawing())&&(lns.draw.layer.startFrame=n,lns.draw.layer.endFrame=n,lns.anim.frame=n),e<0&&lns.anim.currentFrame>lns.anim.state.start&&(lns.draw.layer.startFrame=n,lns.draw.layer.endFrame=n,lns.anim.frame=n)),lns.data.saveState(),lns.ui.update()},this.plus=function(){e.setFrame(lns.anim.endFrame),e.next(1)}}function States(){const e=this;this.update=function(){for(const n in lns.anim.states){const t=lns.anim.states[n],a=e.panel[n]?e.panel[n]:e.addUI(n,t,!1);for(const e in t)a[e].value!==t[e]&&(a[e].value=t[e])}},this.addUI=function(n,t,a){const s=e.panel.addRow(n);return lns.anim.states[n]=t,lns.ui.faces.stateSelector.addOption(n),s.append(new UILabel({text:n})),s.append(new UINumber({value:t.start,callback:function(e){t.start=+e}}),"start"),s.append(new UINumber({value:t.end,callback:function(e){t.end=+e}}),"end"),s.append(new UIButton({text:"x",callback:function(){delete lns.anim.states[n],e.panel.removeRow(s),lns.ui.faces.stateSelector.removeOption(n),lns.anim.state="default",lns.ui.faces.stateSelector.value="default"}})),s},this.set=function(e){if(e)lns.anim.state=e,lns.ui.update();else{const e=new UIModal({app:lns,title:"Choose State",position:lns.mousePosition});for(const n in lns.anim.states)e.add(new UIButton({text:n,callback:()=>{lns.anim.state=n,lns.ui.faces.stateSelector.value=n,e.clear(),lns.ui.update()}}))}},this.create=function(){const n=prompt("Name?");n&&(e.addUI(n,{start:lns.anim.currentFrame,end:lns.anim.currentFrame},!0),lns.anim.state=n,lns.ui.faces.stateSelector.value=n)}}function Timeline(){const e=this;this.frameWidth=120,this.autoFit=!1,this.viewLayers=!0,this.viewActiveLayers=!1,this.viewGroups=!0,this.updateDuringPlay=!1,this.useScrollToFrame=!0,this.groups=[],this.init=function(){e.panel.el.addEventListener("wheel",(n=>{if(n.preventDefault(),n.shiftKey){let t=e.panel.timeline.el,a=t.scrollLeft;t.scrollTo(a+20*Math.sign(n.deltaX),0)}else e.frameWidth+=(n.deltaY>0?1:-1)*(n.altKey?5:1),e.panel.timeline.setProp("--frame-width",e.frameWidth)})),e.panel.el.addEventListener("mousedown",(e=>{})),e.panel.el.addEventListener("mouseup",(e=>{e.preventDefault()})),e.panel.el.addEventListener("mousemove",(e=>{1==e.which&&e.target.classList.contains("frame")&&lns.anim.currentFrame!=+e.target.textContent?(lns.draw.reset(),lns.ui.play.setFrame(+e.target.textContent),lns.ui.update()):e.which})),e.panel.el.oncontextmenu=function(){return!1}},this.fit=function(){const n=lns.anim.endFrame+1,t=lns.ui.timeline.panel.el.clientWidth-11;e.frameWidth=(t-2*n)/n,e.panel.timeline.setProp("--frame-width",e.frameWidth),e.frameClass(),e.drawLayers()},this.frameClass=function(){e.frameWidth<5?(e.panel.timeline.addClass("five"),e.panel.timeline.removeClass("ten")):e.frameWidth<10?(e.panel.timeline.addClass("ten"),e.panel.timeline.removeClass("five")):(e.panel.timeline.removeClass("ten"),e.panel.timeline.removeClass("five"))},this.fitFrame=function(){lns.ui.faces.timelineAutoFit.off(),e.autoFit=!1,e.frameWidth=120,e.panel.timeline.setProp("--frame-width",e.frameWidth),e.frameClass(),e.update(),e.scrollToFrame(),e.drawLayers()},this.scrollToFrame=function(){e.useScrollToFrame&&e.panel.timeline.el.scrollTo(lns.ui.panels.timeline.timeline[`frm-${lns.anim.currentFrame}`].el.offsetLeft-10,0)},this.update=function(){lns.ui.faces.frameDisplay.value=lns.anim.currentFrame,e.panel.timeline.setProp("--num-frames",lns.anim.endFrame+1),e.panel.timeline.setProp("--num-tweens",lns.anim.layers.reduce(((e,n)=>e+n.tweens.length),0)),e.panel.timeline.clear();const n=lns.anim.endFrame+1;for(let t=0;t<n;t++){const n=new UIButton({type:"frame",text:`${t}`,css:{gridColumnStart:1+2*t,gridColumnEnd:3+2*t},class:t==lns.anim.currentFrame?"current":"",callback:function(){lns.draw.reset(),lns.ui.play.setFrame(t),lns.ui.update()}});e.panel.timeline.append(n,`frm-${t}`)}!e.updateDuringPlay&&lns.anim.isPlaying||this.drawLayers(),e.scrollToFrame()},this.drawLayers=function(){let n=0;if(e.viewLayers){const t=e.viewActiveLayers?lns.anim.layers.filter((e=>e.isInFrame(lns.anim.currentFrame))):lns.anim.layers;let a=2,s=3;if(e.viewGroups)for(let i=0,r=e.groups.length;i<r;i++){let r=t.filter((e=>e.groupNumber===i));if(0===r.length)continue;const l=r.reduce(((e,n)=>e.startFrame<n.startFrame?e:n)).startFrame,o=r.reduce(((e,n)=>e.endFrame<n.endFrame?e:n)).endFrame;r.forEach((e=>{e.startFrame!==l&&(e.startFrame=l),e.endFrame!==l&&(e.endFrame=o)}));const d=new UITimelineGroup(r,{name:e.groups[i],index:i,type:"group",startFrame:l,endFrame:o,width:e.frameWidth*(o-l+1),css:{gridRowStart:a,gridRowEnd:s,gridColumnStart:2*l+1,gridColumnEnd:2*o+3}});a+=2,s+=2,n++,e.panel.timeline.append(d,`group-${i}`)}for(let i=0,r=lns.anim.layers.length-1;i<r;i++){const r=lns.anim.layers[i];if(r.groupNumber>=0&&e.viewGroups)continue;if(e.viewActiveLayers&&!r.isInFrame(lns.anim.currentFrame))continue;const l=new UILayer(r,{canMoveUp:i>0&&t.length>2,type:"layer",width:e.frameWidth*(r.endFrame-r.startFrame+1),css:{gridRowStart:a,gridRowEnd:s,gridColumnStart:2*r.startFrame+1,gridColumnEnd:2*r.endFrame+3},moveUp:function(){const n=lns.anim.layers.indexOf(r),t=n-1;t>=0&&([lns.anim.layers[t],lns.anim.layers[n]]=[lns.anim.layers[n],lns.anim.layers[t]]),e.update()},addToGroup(n){if(lns.draw.reset(),r.groupNumber<0)if(0===e.groups.length){let n=prompt("Name new group","New Group 0");e.groups.push(n),r.groupNumber=0,lns.ui.update()}else{let t=new UIModal({title:"Select Group",app:lns,position:n,callback:function(){r.groupNumber=+a.value,lns.ui.update()}});t.addBreak("Groups:");let a=new UISelect({});for(let n=0;n<e.groups.length;n++)a.addOption(n,0===n,e.groups[n]);t.add(a),t.addBreak(),t.add(new UIButton({text:"New Group",callback:function(){t.clear();let n=prompt("Name new group","New Group "+e.groups.length);e.groups.push(n),r.groupNumber=e.groups.length-1,lns.ui.update()}}))}}});a+=2,s+=2,n++,e.panel.timeline.append(l,`layer-${i}`);for(let n=0;n<r.tweens.length;n++){const t=r.tweens[n],l=new UITween({type:"tween",css:{gridRowStart:a,gridRowEnd:s,gridColumnStart:2*t.startFrame+1,gridColumnEnd:2*t.endFrame+3}},t,r);e.panel.timeline.append(l,`tween-${n}-layer-${i}`),a+=2,s+=2}}}e.panel.timeline.setProp("--num-layers",n)},this.toggleViewLayers=function(){e.viewLayers=!e.viewLayers,e.update()},this.toggleViewActiveLayers=function(){e.viewActiveLayers=!e.viewActiveLayers,e.update()},this.toggleViewGroups=function(){e.viewGroups=!e.viewGroups,e.update()},this.split=function(){for(let e=0,n=lns.anim.layers.length-1;e<n;e++){const n=lns.anim.layers[e];if(n.isInFrame(lns.anim.currentFrame)){const e=n.getCloneProps();e.startFrame=lns.anim.currentFrame+1,lns.anim.addLayer(new Layer(e)),n.endFrame=lns.anim.currentFrame}}lns.ui.play.setFrame(lns.anim.currentFrame+1)},this.select=function(n){for(let t=0,a=lns.anim.layers.length-1;t<a;t++){const a=lns.anim.layers[t];a.isInFrame(lns.anim.currentFrame)&&a.isToggled!==n&&(a.groupNumber>=0?e.panel.timeline[`group-${a.groupNumber}`].toggle.update(n):e.panel.timeline[`layer-${t}`].toggle.update(n))}},this.lock=function(n){for(let t=0,a=lns.anim.layers.length-1;t<a;t++){const a=lns.anim.layers[t];a.isInFrame(lns.anim.currentFrame)&&a.isLocked!==n&&e.panel.timeline[`layer-${t}`].lock.update(n)}},this.unlock=function(){e.lock(!1)},this.resetLayers=function(){for(let e=0,n=lns.anim.layers.length;e<n;e++){lns.anim.layers[e].reset()}e.drawLayers()}}function appSave(){return{palettes:lns.ui.palette.palettes}}function appLoad(e){lns.ui.palette.setup(e.palettes)}window.addEventListener("load",(function(){window.lns={},Object.assign(Layer.prototype,LayerMixin),Object.assign(Lines.prototype,LinesMixin);const e={};location.search.substr(1).split("&").map((n=>{let[t,a]=n.split("=");e[t]=a})),"pixel"===e.render&&Object.assign(Lines.prototype,PixelMixin),lns.canvas=new Canvas("lines",512,512,"#ffffff",!0),lns.render=new Render(30,!0),lns.anim=new Lines(lns.canvas.ctx,30,!0),lns.draw=new Draw({linesInterval:5,segmentNum:2,jiggleRange:1,wiggleRange:1,wiggleSpeed:.1,color:"#000000"}),lns.bgImage=new Background,lns.data=new Data,lns.files=new Files({fit:!1,save:!1,load:!0,reload:!1,bg:!0});lns.ui=new Interface(lns),lns.ui.capture=new Capture({useSequentialNumbering:!0,captureSettings:{lineWidth:1,canvasScale:2}}),lns.ui.states=new States,lns.ui.palette=new Palette,lns.ui.drawings=new Drawings,lns.ui.play=new Play,lns.ui.timeline=new Timeline,lns.ui.animator=new AnimatorInterface,lns.ui.settings=new Settings(lns,"lns",appSave),lns.ui.load("./interface/interface.json",(function(){lns.draw.setDefaults(),lns.ui.settings.load(appLoad),e.src&&lns.files.loadFile(e.src.split(".")[0]),lns.ui.update(),lns.render.start(),lns.ui.timeline.init(),lns.render.toggleStats()})),lns.uiUpdate=function(){lns.ui.timeline.update(),lns.ui.drawings.update(),lns.ui.states.update()}}));
//# sourceMappingURL=src_maps/animate.min.js.map
