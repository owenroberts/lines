!function(){"use strict";const e={updateProperty(e,a){for(let t=0;t<this.layers.length-1;t++)this.layers[t].isToggled&&(this.layers[t][e]=a)},addLayer(e){-1==this.layers.indexOf(e)&&this.layers.splice(k.anim.layers.length-1,0,e)},removeLayer(e){const a=this.layers.indexOf(e);a>=0&&this.layers.splice(a,1)},updateStates(){for(const e in this.states)this.states[e].end>this.endFrame&&(this.states[e].end=this.endFrame)},merge(e,a,t){const n=k.anim.drawings[e],r=k.anim.drawings[a];for(let e=0,a=r.length;e<a;e++)n.add(r.pop());t||console.warn("No layer"),k.anim.drawings[a]=null,t.drawingEndIndex=n.length},getDrawLayer(){return this.layers[this.layers.length-1]}},a={init(e){this.isToggled=!1,this.isLocked=!1,this.isHighlighted=!1,this.groupNumber=void 0!==e.groupNumber?e.groupNumber:-1},reset(){this.isToggled=!1,this.isLocked=!1,this.isHighlighted=!1,this.highlightColor="#94dfe3"},toggle(){this.isToggled=!this.isToggled},isInFrame(e){return e>=this.startFrame&&e<=this.endFrame&&!this.dontDraw},addTween(e){this.tweens.push(e),e.startFrame<this.startFrame&&(this.startFrame=e.startFrame),e.endFrame>this.endFrame&&(this.endFrame=e.endFrame),"default"==k.anim.stateName&&k.anim.state.end<this.endFrame&&(k.anim.state.end=this.endFrame)},resetTweens(){for(let e=0;e<this.tweens.length;e++){const a=this.tweens[e];a.startFrame<this.startFrame&&(a.startFrame=this.startFrame),a.endFrame>this.endFrame&&(a.endFrame=this.endFrame)}},addIndex(e){if(!this.isInFrame(e))if(this.startFrame-1==e)this.startFrame-=1;else{if(this.endFrame+1!=e)return new i({...this.getCloneProps(),startFrame:e,endFrame:e});this.endFrame+=1}return this},removeIndex(e,a){if(this.startFrame===e&&this.endFrame===e)a();else if(this.startFrame===e)this.startFrame+=1;else{if(this.endFrame!==e){if(e>this.startFrame&&e<this.endFrame){const a=new i(this.getCloneProps());return a.startFrame=e+1,a.endFrame=this.endFrame,a.resetTweens(),this.endFrame=e-1,this.resetTweens(),a}return this}this.endFrame-=1}this.resetTweens()},shiftIndex(e,a){return a||(a=-1),this.startFrame>=e&&(this.startFrame+=a),this.endFrame>=e&&(this.endFrame+=a),this.resetTweens(),this},resetDrawingEndIndex(e){this.drawingEndIndex=e},getSaveProps(){const e={n:this.segmentNum,r:this.jiggleRange,w:this.wiggleRange,v:this.wiggleSpeed,ws:this.wiggleSegments,c:this.color,f:[this.startFrame,this.endFrame],d:this.drawingIndex,b:this.breaks,l:this.linesInterval,g:this.groupNumber};return this.x&&(e.x=this.x),this.y&&(e.y=this.y),this.tweens&&(e.t=this.tweens.map((e=>[e.prop,e.startFrame,e.endFrame,e.startValue,e.endValue]))),e},getEditProps(){return{segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,linesInterval:this.linesInterval,breaks:this.breaks,color:this.color}},getTweenProps(){return{segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,linesInterval:this.linesInterval,startIndex:this.drawingStartIndex,endIndex:this.drawingEndIndex}},getCloneProps(){return props={drawingIndex:this.drawingIndex,segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,breaks:this.breaks,linesInterval:this.linesInterval,x:this.x,y:this.y,color:this.color,drawingStartIndex:this.drawingStartIndex,drawingEndIndex:this.drawingEndIndex,startFrame:this.startFrame,endFrame:this.endFrame,groupNumber:this.groupNumber}}},{Animation:t,Animator:n,Drawing:r,Layer:i,AntiMixin:s,PixelMixin:l}=Lines,{Interface:o,Settings:c}=UI,{UIFile:d,UILabel:m,UIModal:u,UIButton:g,UINumberStep:p,UICollection:h,UIColor:w,UIToggle:b,UIDragButton:y,UISelect:v}=UI.Elements,k={};Object.assign(i.prototype,a),Object.assign(t.prototype,e);const F={};location.search.substr(1).split("&").map((e=>{let[a,t]=e.split("=");F[a]=t})),"pixel"===F.render&&Object.assign(Lines.prototype,l),k.canvas=function(e,a=512,t=512,n="#ffffff",r=!0){const i=document.getElementById(e);let s=r&&window.devicePixelRatio||1,l=1,o=1;const c=i.getContext("2d");function d(){c.miterLimit=1,c.lineCap="round",c.lineJoin="round"}function m(e){i.style.backgroundColor=e}function u(e){c.lineWidth=o=+e,d()}function g(e){l=e,p(a),f(t)}function p(e){a=e,i.width=e*s*l,w()}function f(e){t=e,i.height=e*s*l,w()}function h(e){e?i.classList.add("no-cursor"):i.classList.remove("no-cursor")}function w(){c.scale(1,1),c.scale(s*l,s*l),i.style.zoom=1/s,c.lineWidth=o,d()}function b(){k.draw.reset();let e=0,a={x:1e4,y:1e4},t={x:0,y:0};for(let n=0;n<k.anim.layers.length;n++){const r=k.anim.layers[n],i=k.anim.drawings[r.drawingIndex];for(let n=0;n<i.length;n++){const s=i.points[n];"end"!==s&&"add"!==s&&(e=Math.max(e,4*r.jiggleRange),a.x=Math.min(a.x,s[0]+r.x),a.y=Math.min(a.y,s[1]+r.y),t.x=Math.max(t.x,s[0]+r.x),t.y=Math.max(t.y,s[1]+r.y))}}k.ui.faces.width.update(Math.round(t.x-a.x+2*e)),k.ui.faces.height.update(Math.round(t.y-a.y+2*e));for(let t=0;t<k.anim.layers.length-1;t++)k.anim.layers[t].x-=a.x-e>0?a.x-e:0,k.anim.layers[t].y-=a.y-e>0?a.y-e:0}return c.miterLimit=1,c.lineCap="round",c.lineJoin="round",m(n),p(a),f(t),{connect:function(){k.ui.addCallback({callback:b,text:"Fit Canvas",key:"shift-f"},"canvas"),k.ui.addProps({width:{value:a,callback:e=>{p(e)}},height:{value:t,callback:e=>{f(e)}},lineWidth:{type:"UINumberStep",value:1,range:[1,100],callback:e=>{u(e)}},canvasScale:{type:"UINumberStep",value:1,range:[.5,4],step:.05,callback:e=>{g(e)}},bgColor:{type:"UIColor",value:n,callback:e=>{m(e)}},hideCursor:{type:"UIToggleCheck",key:"alt-m",callback:e=>{h(e)}}},"canvas")},canvas:i,ctx:c,fitCanvasToDrawing:b,setWidth:p,setHeight:f,setBGColor:m,getScale:()=>l,getWidth:()=>a,getHeight:()=>t,getLineWidth:()=>o,getBGColor:()=>n}}("lines",512,512,"#ffffff",!0),k.render=function(e=30,a=!1){window.drawCount=0;let t,n,r,i=1e3/e,s=performance.now(),l=0,o=!1,c=0;function d(e){void 0!==e&&(a=e),!t&&a&&(t=new Stats,t.dom.style.position="absolute",t.dom.style.top="-48px",t.dom.style.right="0",t.dom.style.left="auto",n.el.appendChild(t.dom)),t?(t.dom.style.display=a?"block":"none",n.setProp("overflow","visible")):n.setProp("overflow","hidden")}function m(){if(k.anim.isPlaying){const e=k.draw.getDrawLayer();e.startFrame=k.anim.currentFrame,e.endFrame=k.anim.currentFrame}else g(),k.draw.reset();k.anim.isPlaying=!k.anim.isPlaying,k.timeline.update()}function u(e){+e<=k.anim.endFrame+1&&+e>=0?(k.anim.frame!==+e&&k.draw.reset(),k.anim.frame=+e,k.draw.getDrawLayer().startFrame=k.anim.currentFrame,k.draw.getDrawLayer().endFrame=k.anim.currentFrame,k.ui.update()):r.update(k.anim.currentFrame,!0)}function g(){k.anim.currentFrame!==k.anim.endFrame||k.draw.hasDrawing()||p(-1)}function p(e){const a=k.anim.currentFrame+e;if(k.anim.isPlaying&&k.ui.faces.play.update(),k.draw.stop(),k.draw.getCurrentDrawing().length>0)k.draw.reset(a),k.anim.frame=a;else{const t=k.draw.getDrawLayer();e>0&&(k.anim.currentFrame<k.anim.state.end||"default"==k.anim.stateName&&k.draw.hasDrawing())&&(t.startFrame=a,t.endFrame=a,k.anim.frame=a),e<0&&k.anim.currentFrame>k.anim.state.start&&(t.startFrame=a,t.endFrame=a,k.anim.frame=a)}k.data.saveState(),k.ui.update()}function f(){u(k.anim.endFrame),p(1)}function h(e){if(a&&t.begin(),performance.now()>i+s||"cap"==e){if(s=performance.now(),k.anim.isPlaying&&k.timeline.update(),0===c?(k.canvas.ctx.clearRect(0,0,k.canvas.getWidth(),k.canvas.getHeight()),c=0):c++,k.capture.bg&&(k.capture.frames>0||k.capture.isVideo)&&(k.canvas.ctx.fillStyle=k.canvas.getBGColor(),k.canvas.ctx.fillRect(0,0,k.canvas.getWidth(),k.canvas.getHeight())),k.bg.display(),l>0&&o){const e=k.anim.currentFrame;for(let a=1;a<=l;a++){const t=e-a;t>=0&&(k.anim.currentFrame=t,k.anim.overrideProperty("color",`rgba(105,150,255,${1.5-a/l})`),k.anim.draw())}k.anim.cancelOverride(),k.anim.currentFrame=e}if(k.anim.layers.some((e=>e.isHighlighted))){k.anim.overrideProperty("color","#94dfe3");for(let e=0,a=k.anim.layers.length-1;e<a;e++){const a=k.anim.layers[e];a.isInFrame(k.anim.currentFrame)&&a.isHighlighted||(a.dontDraw=!0)}k.canvas.ctx.lineWidth=5,k.anim.draw(0,0,!0),k.anim.cancelOverride(),k.canvas.ctx.lineWidth=k.canvas.getLineWidth(),k.anim.layers.filter((e=>e.dontDraw)).forEach((e=>{e.dontDraw=!1}))}k.anim.update(),k.anim.draw(),window.drawCount++}k.capture.isCapturing()||window.requestAnimFrame(h),a&&t.end()}return{connect:function(){n=k.ui.getPanel("play",{label:"Play Back"}),k.ui.addCallbacks([{callback:u,key:"0",text:"0",args:[0]},{callback:p,key:"w",text:"<",args:[-1]},{callback:m,type:"UIToggle",value:!1,text:"Play",onText:"❚❚",offText:"▶",key:"space"},{callback:p,key:"e",text:">",args:[1]},{callback:f,key:"+",text:"+"}],"play"),r=k.ui.addUI({type:"UINumberStep",callback:u,face:"frameDisplay",key:"f",value:0},"play"),k.ui.addCallbacks([{callback:h,text:"↻",key:"u"}]),k.ui.addProps({fps:{type:"UINumberStep",key:";",value:k.anim.fps,callback:e=>{!function(e){k.anim.fps=e,k.ui.faces.fps.value=k.anim.fps,k.ui.faces.dpf.value=k.anim.dpf}(e)},min:1,prompt:"Set Frames/Second"},dpf:{type:"UINumberStep",value:k.anim.dpf,callback:e=>{!function(e){k.anim.dpf=e,k.ui.faces.fps.value=k.anim.fps}(e)},min:1,prompt:"Set Draws/Frame"},dps:{type:"UINumberStep",key:"'",value:e,callback:a=>{!function(a){i=1e3/(e=a),k.anim.drawsPerFrame=Math.max(1,Math.round(e/k.anim.fps)),k.ui.faces.fps.value=k.anim.fps,k.ui.faces.dpf.value=k.anim.dpf}(a)},prompt:"Set Draw/Second"},onionSkinIsVisible:{type:"UIToggleCheck",value:o,label:"Onion Skin",key:"n",callback:e=>{o=e}},onionSkinNum:{type:"UINumberStep",value:l,label:"Frames",key:"l",callback:e=>{l=e}},viewStats:{type:"UIToggleCheck",value:a,callback:e=>{d(e)}}})},reset:function(){k.anim.frame=0,k.anim.isPlaying=!1,k.ui.update()},start:function(){window.requestAnimFrame(h)},toggleStats:d,setFrame:u,checkEnd:g}}(30,!1),k.anim=new t(k.canvas.ctx,30,!0),k.draw=function(e,a){function t(){return e.anim.getDrawLayer()}function n(){return e.anim.drawings[e.anim.drawings.length-1]}function s(a,n){for(const r in a)void 0!==t()[r]&&(t()[r]=a[r],e.ui.faces[r]&&e.ui.faces[r].update(a[r],n))}function l(a,n){e.anim.updateProperty(a,n),t()[a]=n}function o(){s(a)}function c(a){let s=n(),l=!s;s.length>0&&(l=!0),l&&(e.anim.drawings.push(new r),e.ui.faces.color.addColor(t().color),e.anim.layers.push(new i({linesInterval:+e.ui.faces.linesInterval.value,segmentNum:+e.ui.faces.segmentNum.value,jiggleRange:+e.ui.faces.jiggleRange.value,wiggleRange:+e.ui.faces.wiggleRange.value,wiggleSpeed:+e.ui.faces.wiggleSpeed.value,color:e.ui.faces.color.value,drawingIndex:e.anim.drawings.length-1,startFrame:+a||e.anim.currentFrame})),e.data.saveState()),e.ui.update()}function d(){return e.anim.layers.some((a=>a.isInFrame(e.anim.currentFrame)&&e.anim.drawings[a.drawingIndex].length>0))}function m(){const a=new u({title:"Select Color",app:e,position:e.mousePosition});a.add(new w({callback:a=>{l(a,"color"),e.ui.faces.color.el.value=a}})),e.ui.faces.color.colors.forEach((t=>{a.add(new g({text:t,css:{background:t},value:t,callback:()=>{l("color",t),e.ui.faces.color.el.value=t,a.clear()}}))}))}function p(){const a="#"+Math.floor(16777215*Math.random()).toString(16);l(a,"color"),e.ui.faces.color.el.value=a}function f(){let a=parseInt(t().color.substr(1),16);a+=Cool.randomInt(-500,500),a=Math.max(0,a);const n="#"+a.toString(16);l(n,"color"),e.ui.faces.color.el.value=n}e.anim.drawings.push(new r),e.anim.layers.push(new i({...a,drawingIndex:Math.max(e.anim.drawings.length-1,0),startFrame:e.anim.currentFrame}));let h=!1,b=0,y=0,v=0,k=1,F=0,x=0,I=1,S=3,C=!1,N=10,P=performance.now(),L=30,R=2,U=!1,T=new Cool.Vector;e.mousePosition=new Cool.Vector;let D=!1,E="points";function M(a){a.toElement!==e.canvas.canvas&&(U&&c(),U=!1)}function V(a,t){const r=n();let i=new Cool.Vector(a,t);i.divide(e.canvas.getScale()),r.add(i.round());const s=Cool.randomInt(I,S);for(let n=1;n<=s;n++){let i=Cool.random(-b,y)*k*(n/s)*(1-Cool.random(F)),l=Cool.random(-0,v)*k*(n/s)*(1-Cool.random(x)),o=new Cool.Vector(a+i,t-l);o.divide(e.canvas.getScale()),o.x>0&&o.x<e.canvas.getWidth()&&o.y>0&&o.y<e.canvas.getHeight()&&r.add(o.round())}r.add("end")}function B(a,t){n().add(new Cool.Vector(a,t).divide(e.canvas.getScale()).round())}function j(a){performance.now()>L+P&&(P=performance.now(),e.mousePosition.x=a.pageX,e.mousePosition.y=a.pageY,U?h?V(Math.round(a.offsetX),Math.round(a.offsetY)):e.mousePosition.distance(T)>R&&(B(Math.round(a.offsetX),Math.round(a.offsetY)),T=e.mousePosition.clone()):D&&function(a,t){let n=new Cool.Vector(a,t).divide(e.canvas.getScale()).round();for(let a=e.anim.layers.length-1;a>=0;a--){const t=e.anim.layers[a];if(t.isLocked)continue;if(!t.isInFrame(e.anim.currentFrame))continue;const r=e.anim.drawings[t.drawingIndex];for(let e=r.points.length-1;e>=0;e--){const a=new Cool.Vector(r.points[e]);if(n.distance(a)<10)if("lines"===E){let a=e,t=e;for(;"end"!==r.points[a]&&a>0;)a--;for(;"end"!==r.points[t]&&t<r.length;)t++;r.points.splice(a,t)}else"points"===E&&(r.points[e]="end")}if("points"===E)for(let e=r.points.length-1;e>=0;e--)"end"===r.points[e]&&"end"===r.points[e-1]&&r.points.splice(e,1),"end"===r.points[e+1]&&"end"===r.points[e-1]&&r.points.splice(e,1),"end"===r.points[e]&&0===e&&r.points.splice(e,1);0===r.points.length&&a!==e.anim.layers.length-1?t.removeIndex(e.anim.currentFrame,(function(){e.anim.layers.splice(a,1),c()})):r.update(t.drawProps)}}(Math.round(a.offsetX),Math.round(a.offsetY)))}function O(a){a.preventDefault(),a.which>=2&&(D=!0),1!=a.which||e.render.isPlaying||a.altKey?a.altKey&&(C=new Cool.Vector(Math.round(a.offsetX),Math.round(a.offsetY))):a.ctrlKey?D=!0:(U=!0,P=performance.now(),h?V(Math.round(a.offsetX),Math.round(a.offsetY)):(B(Math.round(a.offsetX),Math.round(a.offsetY)),T=e.mousePosition.clone()))}function $(e){if(D=!1,C){const a=n(),t=Math.abs(C.x-e.offsetX),r=Math.abs(C.y-e.offsetY),i=t/r,s=t/(i*N/2),l=r/(1/i*N/2);let[o,c]=C.x<e.offsetX?[C.x,e.offsetX]:[e.offsetX,C.x],[d,m]=C.y<e.offsetY?[C.y,e.offsetY]:[e.offsetY,C.y];for(let e=o;e<c;e+=s)for(let t=d;t<m;t+=l){const n=Math.round(e)+Cool.randomInt(-s/2,s/2),r=Math.round(t)+Cool.randomInt(-l/2,l/2),i=Cool.randomInt(1,3);for(let e=0;e<i;e++)a.add(new Cool.Vector(n+Cool.randomInt(-1,1),r+Cool.randomInt(-1,1)));a.add("end")}C=!1}else if(1===e.which){U=!1;const a=n();let t=a.get(-2);"end"!==t&&"add"!==t&&a.length>1?a.add(e.shiftKey?"add":"end"):a.pop()}T=void 0}if(window.navigator.platform.includes("iPad")){const W={which:1},X=window.devicePixelRatio;function A(e,a){if(e.preventDefault(),e.touches[0]){const t=e.target.getBoundingClientRect();W.offsetX=e.targetTouches[0].pageX-t.left/X,W.offsetY=e.targetTouches[0].pageY-t.top/X,W.which=1,a(W)}}e.canvas.canvas.addEventListener("touchstart",(e=>{A(e,O)})),e.canvas.canvas.addEventListener("touchmove",(e=>{A(e,j)})),e.canvas.canvas.addEventListener("touchend",(e=>{$(W)}))}else window.PointerEvent?(e.canvas.canvas.addEventListener("pointermove",j),e.canvas.canvas.addEventListener("pointerdown",O),e.canvas.canvas.addEventListener("pointerup",$)):(e.canvas.canvas.addEventListener("mousemove",j),e.canvas.canvas.addEventListener("mousedown",O),e.canvas.canvas.addEventListener("mouseup",$));function G(){e.ui.addProps({mouseInterval:{type:"UINumberRange",key:"m",value:L,callback:e=>{L=e},range:[0,100]},distanceThreshold:{type:"UINumberStep",key:"shift-m",range:[0,30],value:R,callback:e=>{R=e}}},"mouse");e.ui.getPanel("draw",{label:"Lines"});e.ui.addCallbacks([{callback:m,key:"g",text:"Quick Color"},{callback:p,key:"shift-g",text:"Random Color"},{callback:f,key:"alt-g",text:"Color Variation"}],"draw"),e.ui.addProps({color:{type:"UIColor",value:a.color,callback:e=>{l("color",e)}},linesInterval:{type:"UINumberStep",value:a.linesInterval,range:[1,10],callback:e=>{l("linesInterval",e)}},segmentNum:{type:"UINumberStep",value:a.segmentNum,range:[1,10],callback:e=>{l("segmentNum",e)}},jiggleRange:{type:"UINumberStep",value:a.jiggleRange,range:[0,10],callback:e=>{l("jiggleRange",e)}},wiggleRange:{type:"UINumberStep",value:a.wiggleRange,range:[0,16],callback:e=>{l("wiggleRange",e)}},wiggleSpeed:{type:"UINumberStep",value:a.wiggleSpeed,range:[0,8],step:.005,callback:e=>{l("wiggleSpeed",e)}},wiggleSegments:{type:"UIToggleCheck",value:a.wiggleSegments,callback:e=>{l("wiggleSegments",e)}},breaks:{type:"UIToggleCheck",value:a.breaks,callback:e=>{l("breaks",e)}}},"draw"),e.ui.addCallbacks([{callback:c,key:"r",text:"Save Lines"},{callback:o,text:"Reset Defaults"}],"draw"),e.ui.addProp("eraseMethod",{type:"UISelect",option:["points","lines"],callback:e=>{E=e}},"erase"),e.ui.addProps({isBrush:{type:"UIToggleCheck",value:h,label:"Use Brush",key:"b",callback:e=>{h=e}},dots:{type:"UINumberRange",range:[10,50],value:10,callback:e=>{N=e}},brushSpreadXLeft:{row:!0,type:"UINumberRange",range:[0,50],callback:e=>{b=e}},brushSpreadXRight:{type:"UINumberRange",range:[0,50],callback:e=>{y=e}},brushSpreadYDown:{type:"UINumberRange",range:[0,50],callback:e=>{v=e}},brushRandomX:{type:"UINumberRange",range:[0,1],step:.01,callback:e=>{F=e}},brushRandomY:{type:"UINumberRange",range:[0,1],step:.01,callback:e=>{x=e}},brushSegmentsMin:{type:"UINumberStep",range:[1,5],value:1,callback:e=>{I=e}},brushSegmentsMax:{type:"UINumberStep",range:[1,5],value:3,callback:e=>{S=e}},brushSpreadMultiplier:{type:"UINumberStep",range:[1,5],value:1,callback:e=>{k=e}}},"brush")}return document.addEventListener("mousemove",M),{connect:G,reset:c,setDefaults:o,getDrawLayer:t,getCurrentDrawing:n,hasDrawing:d,setProperties:s,isDrawing:()=>U,stop(){U=!1}}}(k,{linesInterval:5,segmentNum:2,jiggleRange:1,wiggleRange:1,wiggleSpeed:.1,color:"#000000"}),k.bg=function(){let e=new Image,a=!0,t=0,n=0,r=0,i=0,s=1,l=0,o=!1,c=!1,d=1,m=1,u="#808080",g=2,p=!0;return{connect:function(){k.ui.addProps({bgImage:{type:"UIText",placeholder:"URL",css:{"flex-basis":"100%"},callback:a=>{var t;t=a,e.src=t,e.onload=function(){r=e.width,i=e.height}}},showBG:{value:a,key:"alt-b",onText:"Hide",offText:"Show",callback:e=>{a=e}},bgX:{row:!0,type:"UINumberRange",value:t,label:"X",range:[-1024,1024],callback:e=>{t=e}},bgY:{row:!0,type:"UINumberRange",value:n,label:"Y",range:[-1024,1024],callback:e=>{n=e}},bgSize:{row:!0,type:"UINumberRange",value:s,label:"Size",range:[.1,2],step:.1,callback:e=>{s=e}},bgRotation:{row:!0,type:"UINumberRange",value:l,label:"Rotation",range:[0,360],callback:e=>{l=e}},dotGrid:{type:"UIToggleCheck",value:o,callback:e=>{o=e}},dotEdges:{type:"UIToggleCheck",value:p,callback:e=>{p=e}},lineGrid:{type:"UIToggleCheck",value:c,callback:e=>{c=e}},gridColumns:{type:"UINumberStep",value:d,callback:e=>{d=e}},gridRows:{type:"UINumberStep",value:m,callback:e=>{m=e}},dotSize:{type:"UINumberStep",value:g,callback:e=>{g=e}},gridColor:{type:"UIColor",value:u,callback:e=>{u=e}}},"background")},display:function(){if(e.src&&a&&(l>0&&(k.canvas.ctx.save(),k.canvas.ctx.rotate(l*Math.PI/180)),k.canvas.ctx.drawImage(e,t,n,s*r,i*s),l>0&&k.canvas.ctx.restore()),o||c){let e=k.canvas.getWidth(),a=k.canvas.getHeight(),t=e/d,n=a/m;for(let e=0;e<=d;e++)for(let a=0;a<=m;a++){let r=e*t,i=a*n;c&&a>0&&a<m&&(k.canvas.ctx.strokeStyle=u,k.canvas.ctx.beginPath(),k.canvas.ctx.moveTo(r,i),k.canvas.ctx.lineTo(r+t,i),k.canvas.ctx.stroke()),c&&e>0&&e<d&&(k.canvas.ctx.beginPath(),k.canvas.ctx.moveTo(r,i),k.canvas.ctx.lineTo(r,i+n),k.canvas.ctx.stroke()),o&&(!p||0!==e&&e!==d)&&(!p||0!==a&&a!==m)&&(k.canvas.ctx.fillStyle=u,k.canvas.ctx.beginPath(),k.canvas.ctx.arc(r,i,g,0,2*Math.PI),k.canvas.ctx.fill())}}}}}(),k.data=function(e){let a=[],t=[],n=[],i={current:{drawings:void 0,layers:void 0},prev:{drawings:void 0,layers:void 0}};function s(){i.current.drawings?(i.prev.drawings=_.cloneDeep(i.current.drawings),i.prev.layers=_.cloneDeep(i.current.layers)):(i.prev.drawings=_.cloneDeep(e.anim.drawings),i.prev.layers=_.cloneDeep(e.anim.layers)),i.current.drawings=_.cloneDeep(e.anim.drawings),i.current.layers=_.cloneDeep(e.anim.layers)}function l(){i.prev.drawings?(e.anim.drawings=_.cloneDeep(i.prev.drawings),e.anim.layers=_.cloneDeep(i.prev.layers),i.current.drawings=_.cloneDeep(i.prev.drawings),i.current.layers=_.cloneDeep(i.prev.layers),i.prev.drawings=void 0,i.prev.layers=void 0):console.log("%c Can't undo ","color:lightblue;background:gray;"),e.drawings.clear(),e.ui.update()}function o(){e.draw.reset(),a=[];for(let t=0;t<e.anim.layers.length-1;t++)e.anim.layers[t].isInFrame(e.anim.currentFrame)&&a.push(e.anim.layers[t])}function c(){s(),0==n.length&&n.push(e.anim.currentFrame);for(let t=0;t<n.length;t++)for(let r=0;r<a.length;r++){const i=a[r].addIndex(n[t]);i&&e.anim.addLayer(i)}n=[],e.draw.reset(),e.ui.update()}function d(){a=[];let t=+prompt("Number of copies: ",1);if(o(),t)for(let a=0;a<t;a++)e.render.next(1),c();e.ui.update()}function m(){const a=+prompt("Start frame:"),n=+prompt("end frame:");t=[];for(let r=a;r<=n;r++){t[r]=[];for(let a=0;a<e.anim.layers.length-1;a++)e.anim.layers[a].isInFrame(r)&&t[r].push(e.anim.layers[a])}}function u(){for(let a=0;a<t.length;a++){const n=t[a];if(n)for(let a=0;a<n.length;a++){const t=n[a].addIndex(e.anim.currentFrame);t&&e.anim.addLayer(t)}e.render.next(1)}e.draw.reset(),e.ui.update()}function g(){e.draw.drawing=new r}function p(){for(let a=e.anim.layers.length-2;a>=0;a--)if(e.anim.layers[a].isInFrame(e.anim.currentFrame)&&!(e.anim.layers[a].groupNumber>=0)){e.anim.layers[a].removeIndex(e.anim.currentFrame,(()=>{e.anim.layers.splice(a,1)}));break}e.ui.update()}function f(){for(let a=0;a<e.anim.layers.length-1;a++)if(e.anim.layers[a].isInFrame(e.anim.currentFrame)&&!(e.anim.layers[a].groupNumber>=0)){e.anim.layers[a].removeIndex(e.anim.currentFrame,(function(){e.anim.layers.splice(a,1)}));break}e.ui.update()}function h(){g(),function(){s();for(let a=e.anim.layers.length-2;a>=0;a--)e.anim.layers[a].isInFrame(e.anim.currentFrame)&&e.anim.layers[a].removeIndex(e.anim.currentFrame,(()=>{e.anim.layers.splice(a,1)}));e.ui.update()}()}function w(a){void 0!==a||e.anim.currentFrame;s();const t=e.anim.currentFrame;for(let a=e.anim.layers.length-2;a>=0;a--){const n=e.anim.layers[a];n.endFrame<t||(n.startFrame===t&&n.endFrame===t?e.anim.removeLayer(n):n.endFrame>t&&n.startFrame>t?(n.startFrame-=1,n.endFrame-=1):n.endFrame>t&&(n.endFrame-=1),n.resetTweens())}e.anim.updateStates(),e.ui.update()}function b(){s();const a=+prompt("Start frame:"),t=+prompt("End frame:");if(t>0){for(let e=t;e>=a;e--)w(e);e.draw.cutEnd(),e.render.setFrame(0)}}function y(){e.draw.pop()}function v(){e.draw.popOff()}function k(a){e.draw.reset(),s();for(let t=0,n=e.anim.layers.length-1;t<n;t++)e.anim.layers[t].shiftIndex(e.anim.currentFrame+a,1),e.anim.addLayer(e.anim.layers[t].removeIndex(e.anim.currentFrame+a));e.render.next(a),e.ui.update()}function F(a){e.draw.reset();const t=+prompt("Number of frames?");for(let n=0;n<e.anim.layers.length-1;n++){const r=e.anim.layers[n];if(r.isInFrame(e.anim.currentFrame))switch(r.endFrame=r.startFrame+t,e.anim.state.end<r.endFrame&&(e.anim.state.end=r.endFrame),a){case"Draw":r.addTween({prop:"endIndex",startFrame:r.startFrame,endFrame:r.endFrame,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length});break;case"Reverse":r.addTween({prop:"startIndex",startFrame:r.startFrame,endFrame:r.endFrame,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length});break;case"DrawReverse":const a=Math.floor(t/2);r.addTween({prop:"endIndex",startFrame:r.startFrame,endFrame:r.startFrame+a,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length}),r.addTween({prop:"startIndex",startFrame:r.startFrame+a,endFrame:r.endFrame,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length})}}e.ui.update()}function x(a){let t=e.anim.layers.filter((e=>e.isToggled));if(0==t.length&&(t=e.anim.layers.filter((a=>a.isInFrame(e.anim.currentFrame)))),e.draw.reset(),t){if(s(),a||(a=new Cool.Vector(+prompt("x"),+prompt("y"))),a)for(let e=0;e<t.length;e++)t[e].x+=a.x,t[e].y+=a.y}else console.log("%c No layers in frame ","color:yellow; background:black;")}function I(){for(let a=0;a<e.anim.layers.length;a++){const t=e.anim.layers[a],n=e.anim.drawings[t.drawingIndex];for(let e=0;e<n.length;e++)n.points[e][0]+=t.x,n.points[e][1]+=t.y;t.x=0,t.y=0}}function S(){const a=[];for(let t=0;t<e.anim.drawings.length;t++){e.anim.drawings[t]&&a.push(t)}for(let t=0;t<e.anim.layers.length;t++){const n=e.anim.layers[t],r=a.indexOf(n.drawingIndex);n.drawingIndex=r}for(let a=e.anim.drawings.length;a>=0;a--)null==e.anim.drawings[a]&&e.anim.drawings.splice(a,1)}return{connect:function(){e.ui.getPanel("copy",{label:"Copy / Paste"}),e.ui.addCallbacks([{callback:o,key:"c",text:"Copy"},{callback:d,key:"shift-c",text:"Multi Copy"},{callback:c,key:"v",text:"Paste"},{callback:m,key:"alt-c",text:"Copy Range"},{callback:u,key:"alt-v",text:"Paste Range"}]),e.ui.getPanel("cut",{label:"Cut"}),e.ui.addCallbacks([{callback:g,key:"x",text:"Clear Lines"},{callback:v,key:"z",text:"Cut Last Line"},{callback:y,key:"shift-z",text:"Cut Last Segment"},{callback:w,key:"d",text:"Delete Frame"},{callback:b,key:"shift-d",text:"Delete Frame Range"},{callback:p,key:"ctrl-x",text:"Cut Top Layer"},{callback:f,key:"alt-x",text:"Cut Bottom Layer"},{callback:h,key:"shift-x",text:"Clear Frame"}]),e.ui.getPanel("data"),e.ui.addCallbacks([{callback:l,key:"ctrl-z",text:"Undo"},{callback:x,key:"shift-o",text:"Offset"},{callback:k,key:"i",text:"Insert Before",args:[0]},{callback:k,key:"shift-i",text:"Insert After",args:[1]},{callback:I,text:"Apply Offset"},{callback:S,text:"Prune Drawings"}]),e.ui.getPanel("animate"),e.ui.addCallbacks([{callback:F,key:"a",text:"Draw",args:["Draw"]},{callback:F,key:"shift-a",text:"Reverse",args:["Reverse"]},{callback:F,key:"ctrl-a",text:"Draw + Reverse",args:["DrawReverse"]}])},saveState:s}}(k),k.fio=function(e,a){let n,r=a.save||!1,i=!1;function s(t,r){e.draw.reset(),e.render.checkEnd(),e.anim.drawings.pop(),e.anim.layers.pop(),n=e.ui.faces.title.value||prompt("Name this file:"),a.fit&&confirm("Fit canvas?")&&e.canvas.fitCanvasToDrawing();const i={v:"2.5",w:+e.canvas.getWidth(),h:+e.canvas.getHeight(),fps:+e.anim.fps,mc:[...new Set(e.anim.layers.map((e=>e.color)))].length>1};a.bg&&(i.bg=e.canvas.getBGColor()),t?(i.l=_.cloneDeep(e.anim.layers.filter((a=>a.isInFrame(e.anim.currentFrame)))),i.l=i.l.map((e=>(e.startFrame=0,e.endFrame=0,e.getSaveProps())))):i.l=e.anim.layers.map((e=>e.getSaveProps()));const s=new Set(i.l.map((e=>e.d)));i.d=[];for(let a=0;a<e.anim.drawings.length;a++)i.d[a]=s.has(a)?e.anim.drawings[a].points.map((e=>"end"===e?0:"add"===e?1:[Math.round(e[0]),Math.round(e[1])])):null;const l=e.timeline.getGroups();if(l.length>0&&(i.g=[...l]),Object.keys(e.anim.states).length>1){i.s={};for(const a in e.anim.states)"default"!=a&&(i.s[a]=[e.anim.states[a].start,e.anim.states[a].end])}const o=JSON.stringify(i);if(n){const a=new Blob([o],{type:"application/x-download;charset=utf-8"});saveAs(a,`${n}${t?"-"+e.anim.frame:""}.json`),setTimeout(r,500),e.ui.faces.title.value=n}}function l(){let a=0;!function t(){a<=e.anim.endFrame&&(e.anim.frame=a,s(!0,(()=>{a++,t()})))}()}function o(e,a){"string"==typeof e?(n=e,n&&(".json"!==n.slice(n.length-5)&&(n+=".json"),fetch(n).then((e=>e.json())).then((e=>{console.log(e),c(e,n.split("/").pop())})).catch((e=>{console.error(e)})))):(n=f.name.split(".")[0],c(e,a))}function c(a,n){console.log(a,n),e.anim=new t(e.canvas.ctx,e.render.dps,!0),e.anim.loadData(a,(function(){e.canvas.setWidth(a.w),e.canvas.setHeight(a.h),e.ui.faces.fps.update(a.fps),a.bg&&e.canvas.setBGColor(a.bg),a.g&&e.timeline.setGroups([...a.g]),e.draw.reset()})),e.ui.faces.title.value=n,e.ui.faces.fps.value=a.fps,document.title=n+" ~ animate",console.log(a.w,a.h),e.ui.faces.width.value=a.w,e.ui.faces.height.value=a.h,e.anim.layers.forEach((a=>{a&&(e.ui.faces.color.addColor(a.color),e.ui.faces.color.value=a.color)})),a.bg&&(e.ui.faces.bgColor.value=a.bg),e.ui.update()}function m(){s({},(e=>{location.href+=`?src=/${prompt("Enter location:")}/${e}.json`}))}function u(e,a){for(let a,t=0;a=e[t];t++){if(!a.type.match("application/json"))continue;const e=new FileReader;e.onload=function(e){n=a.name.split(".")[0],c(JSON.parse(e.target.result),n)},e.readAsText(a)}}window.File&&window.FileReader&&window.FileList&&window.Blob&&(i=!0,console.log("%c Save file enabled ","color:lightgreen;background:black;"),e.canvas.canvas.addEventListener("dragover",(function(e){e.preventDefault()})),e.canvas.canvas.addEventListener("drop",(function(a){a.preventDefault(),a.stopPropagation(),u(a.dataTransfer.files,e.ui.updateFIO)})));function g(){e.ui.getPanel("fio",{label:"Files IO"});e.ui.addUIs({title:{id:"title",value:n,type:"UIText"}}),e.ui.addCallbacks([{callback:s,key:"s",text:"Save File",args:[!1]},{callback:s,key:"shift-s",text:"Save Frame",args:[!0]},{callback:l,key:"shift-e",text:"Save Frames to Files"},{callback:m,key:"shift-o",text:"Re-Open"}]);new d({text:"Open",key:"o",callback:(e,a,t)=>{o(e,a)}})}return window.addEventListener("beforeunload",(function(t){r&&e.ui.settings.saveSettings(),a.reload&&(t.returnValue="Did you save dumbhole?")})),{connect:g,loadFile:o}}(k,{fit:!1,save:!1,load:!0,reload:!1,bg:!0}),k.capture=function(e,a){let t,n=a.useSequentialNumbering||!1,r=0,i=a.videoBitsPerSecond||8e6,s=!0,l={f:void 0,n:0},o=0,c=!0,d=!1,u=!1,g=0,p=a.captureSettings.lineWidth||e.canvas.getLineWidth(),f=a.captureSettings.canvasScale||e.canvas.getScale();function h(){o=1,b()}function w(){o=+prompt("Capture how many frames?"),b()}function b(){r=0,e.anim.onDraw=function(){o>0?(!function(){if(e.files.saveFilesEnabled)e.canvas.canvas.toBlob((a=>{const t=e.ui.faces.title.value,i=Cool.padNumber(e.anim.currentFrame,3);let s;n?(s=`${t}-${Cool.padNumber(r,4)}.png`,r++):(i===l.f?l.n+=1:l.n=0,s=`${t}-${i}-${l.n}.png`,l.f=i);saveAs(a,s).onwriteend=function(){setTimeout((()=>{window.requestAnimFrame((()=>{e.render.update("cap")}))}),100)}}));else{const e=canvas.toDataURL("image/png").replace("image/png","image/octet-stream");window.location.href=e}}(),o--,d=!0):d&&(d=!1,e.anim.isPlaying=!1,e.anim.onDraw=void 0)}}function y(){e.draw.reset(),e.anim.frame=e.anim.endFrame,e.anim.isPlaying=!0,o=e.anim.endFrame*Math.max(1,e.render.dps/e.anim.fps)+1,b()}function v(){e.anim.isPlaying=!1,e.anim.frame=0,e.ui.faces.videoLoop.addClass("progress"),g=+prompt("Number of loops?",1),e.anim.onDraw=function(){e.ui.faces.videoLoop.setProp("--progress-percent",Math.round(100*e.anim.currentFrame/e.anim.endFrame))},e.anim.onPlayedState=function(){g>1?g--:u&&(F(),u=!1,e.anim.isPlaying=!1,e.anim.onPlayedState=void 0,e.ui.faces.videoLoop.removeClass("progress"),e.anim.onDraw=void 0)},u=!0,c=!0,F(),e.anim.isPlaying=!0}function k(a){let t=+prompt("Number of frames?",48);o=t,e.anim.isPlaying=!1,a&&(e.anim.frame=0),F(!0);const n="videoFrame"+(a?"s":"");e.ui.faces[n].addClass("progress"),e.anim.onDraw=function(){o>0?(o--,e.ui.faces[n].setProp("--progress-percent",Math.round(100*(1-o/t)))):u&&(F(),a&&e.anim.currentFrame<e.anim.endFrame?(o=t,e.render.next(1),F(!0)):(e.anim.onDraw=void 0,e.ui.faces[n].removeClass("progress")))}}function F(n){if(s){if(a.captureSettings)for(const t in a.captureSettings)e.ui.faces[t].update(self[t]);e.ui.faces.onionSkinIsVisible.update(!1),s=!1,u=!0;const r=e.canvas.canvas.captureStream(e.render.dps);t=new MediaRecorder(r,{videoBitsPerSecond:i,mimeType:"video/webm;codecs=vp8,opus"}),t.start(),t.addEventListener("dataavailable",(a=>{const t=new Blob([a.data],{type:"video/webm"}),r=URL.createObjectURL(t),i=document.createElement("a");document.body.appendChild(i),i.href=r;let s=`${e.ui.faces.title.value}`||"lines";n&&(s=prompt("Title?",e.ui.faces.title.value)),i.download=`${s}.webm`,i.click()}))}else u=!1,s=!0,t.stop()}return{connect:function(){const a=e.ui.getPanel("capture");e.ui.addCallbacks([{callback:h,key:"k",text:"Frame"},{callback:w,key:"shift-k",text:"Frames"},{callback:y,key:"ctrl-k",text:"Cycle"},{callback:k,key:"alt-j",text:"Video Frames",args:[!0],row:!0},{callback:v,key:"j",text:"Video Loops",class:"progress"}]),e.ui.addUIs([{value:!1,key:"alt-k",onText:"Start Video",offText:"Stop Video",callback:()=>{F()}},{value:c,row:!0,key:"shift-b",onText:"With BG",offText:"No BG",callback:e=>{c=e}}]),a.addRow(),a.add(new m({text:"Capture Settings"})),e.ui.addProps({videoBitsPerSecond:{value:i,label:"Bitrate",callback:e=>{i=e}},captureLineWidth:{value:p,callback:e=>{p=e}},captureCanvasScale:{value:f,callback:e=>{f=e}}})},isCapturing:()=>d}}(k,{useSequentialNumbering:!0,captureSettings:{lineWidth:1,canvasScale:2}}),k.states=function(e){let a,t;function n(n,r,i){const s=a.addRow(n,"break");return e.anim.states[n]=r,t.addOption(n),s.append(new m({text:n})),s.append(new p({value:r.start,callback:e=>{r.start=e}}),"start"),s.append(new p({value:r.end,callback:e=>{r.end=e}}),"end"),s.append(new g({text:"x",callback:function(){delete e.anim.states[n],a.removeRow(s),t.removeOption(n),e.anim.state="default",t.value="default"}})),s}function r(a){if(a)return e.anim.state=a,void e.ui.update();const n=new u({app:e,title:"Choose State",position:e.mousePosition});for(const a in e.anim.states)n.add(new g({text:a,callback:()=>{e.anim.state=a,t.value=a,n.clear(),e.ui.update()}}))}function i(){const a=prompt("Name?");a&&(n(a,{start:e.anim.currentFrame,end:e.anim.currentFrame}),e.anim.state=a,t.value=a)}return{connect:function(){a=e.ui.getPanel("states"),t=e.ui.addProp("stateSelect",{type:"UISelect",key:"ctrl-t",callback:e=>{r(e)}}),e.ui.addCallbacks([{callback:i,key:"t",text:"+"},{callback:r,key:"shift-t",text:"Set Default",args:["default"]}]),a.addRow(void 0,"break")},update:function(){for(const t in e.anim.states){const r=e.anim.states[t],i=a[t]?a[t]:n(t,r);for(const e in r)i[e].value!==r[e]&&(i[e].value=r[e])}}}}(k),k.palette=function(e){let a;const t={};let n,r=1;function i(){e.draw.reset();const a=n=prompt("Name this palette.");a&&(t[a]={color:e.draw.layer.color,segmentNum:e.draw.layer.segmentNum,jiggleRange:e.draw.layer.jiggleRange,wiggleRange:e.draw.layer.wiggleRange,wiggleSpeed:e.draw.layer.wiggleSpeed,wiggleSegments:e.draw.layer.wiggleSegments,breaks:e.draw.layer.breaks,linesInterval:e.draw.layer.linesInterval,lineWidth:e.canvas.ctx.lineWidth,mouseInterval:e.draw.mouseInterval,brush:e.draw.brush,brushSpread:e.draw.brushSpread,dots:e.draw.dots,grass:e.draw.grass},s(a))}function s(n){a.addRow(n);const i=a.add(new g({text:n,callback:()=>{o(n)}}));let c="+";r<10&&(e.ui.keys[r]=i,c=r+"",r++);const d=new UIText({text:c,callback:a=>{e.ui.keys[+a].key.value="",e.ui.keys[+a].key.el.placeholder="+",e.ui.keys[+a]=i}});i.key=d,a.add(d),a.add(new g({text:"✎",callback:function(){const e=prompt("Rename: ");t[e]=_.cloneDeep(t[n]),s(e),l(n)}})),a.add(new g({text:"X",callback:()=>{l(n)}}))}function l(e){delete t[e],a[e].clear()}function o(a){e.draw.reset(),t.current=a;const n=t[a];for(prop in n)void 0!==e.ui.faces[prop]&&e.ui.faces[prop].update(n[prop])}function c(){for(let a=0;a<e.anim.layers.length;a++){const n=`Layer ${a}`,r=e.anim.layers[a],i={color:r.color,segmentNum:r.segmentNum,jiggleRange:r.jiggleRange,wiggleRange:r.wiggleRange,wiggleSpeed:r.wiggleSpeed,wiggleSegments:r.wiggleSegments,linesInterval:e.draw.layer.linesInterval,breaks:r.breaks,lineWidth:e.canvas.ctx.lineWidth,mouseInterval:e.draw.mouseInterval,brush:0,brushSpread:e.draw.brushSpread,dots:e.draw.dots,grass:e.draw.grass};let l=!1;for(const e in t){const a=t[e];let n=!0;for(const e in a)a[e]!==i[e]&&(n=!1);n&&(l=!0)}l||(t[n]=i,s(n))}}function m(a){const n=new u({title:"Select Pallette",app:e,position:e.mousePosition});for(const e in t)"current"!==e&&n.add(new g({text:e,callback:()=>{o(e),n.clear()}}))}function p(){const e=JSON.stringify(t),a=prompt("Name:"),n=new Blob([e],{type:"application/x-download;charset=utf-8"});saveAs(n,`${a}.json`)}return{connect:function(){a=e.ui.getPanel("palette"),e.ui.addCallbacks([{callback:p,text:"Save File"},{callback:c,key:"shift-p",text:"Build"},{callback:i,key:"p",text:"+"},{callback:m,key:"q",text:"Quick Select"}]),a.add(new d({text:"Load File",callback:e=>{!function(e){for(const a in e)"current"!==a&&(s(a),t[a]=e[a]);e.current&&o(e.current)}(e)}}))},getPalettes:()=>t}}(k),k.drawings=function(e){let a;function t(a){const t=e.anim.layers.filter(((t,n)=>n<e.anim.layers.length-1&&t.drawingIndex==a));if(t.length>0){for(let a=0;a<t.length;a++)if(t[a].isInFrame(e.anim.currentFrame))return t[a];for(let a=0;a<t.length;a++)if(t[a].isInFrame(e.anim.currentFrame+1)||t[a].isInFrame(e.anim.currentFrame-1))return t[a];return t[0]}return!1}return{connect:function(){a=e.ui.getPanel("drawings"),a.addRow("drawings")},update:function(){a.drawings.clear();for(let n=0;n<e.anim.drawings.length-1;n++)if(e.anim.drawings[n]){let r=t(n);a.append(new b({text:n,isOn:!!r&&r.isInFrame(e.anim.currentFrame),callback:function(a){let r=t(n);if(a)if(r)if(r.isInFrame(e.anim.currentFrame)||r.isInFrame(e.anim.currentFrame-1)||r.isInFrame(e.anim.currentFrame+1))r.addIndex(e.anim.currentFrame);else{const a=r.getCloneProps();a.startFrame=a.endFrame=e.anim.currentFrame,e.anim.addLayer(new i(a))}else e.anim.addLayer(new i({drawingIndex:n,linesInterval:+e.ui.faces.linesInterval.value,segmentNum:+e.ui.faces.segmentNum.value,jiggleRange:+e.ui.faces.jiggleRange.value,wiggleRange:+e.ui.faces.wiggleRange.value,wiggleSpeed:+e.ui.faces.wiggleSpeed.value,color:e.ui.faces.color.value,startFrame:e.anim.currentFrame}));else if(r&&r.isInFrame(e.anim.currentFrame)){const a=r.removeIndex(e.anim.currentFrame,(()=>{e.anim.removeLayer(r)}));a&&e.anim.addLayer(a)}e.ui.update()}}),n)}}}}(k),k.timeline=function(){let e,a,t=120,n=!0,r=!1,s=0,l=!0,o=!1,c=[];function d(){const n=k.anim.endFrame+1,r=e.el.clientWidth-11;t=(r-2*n)/n,a.setProp("--frame-width",t),f()}function m(){t=140,a.setProp("--frame-width",t),t<5?(a.addClass("five"),a.removeClass("ten")):t<10?(a.addClass("ten"),a.removeClass("five")):(a.removeClass("ten"),a.removeClass("five")),f(),p(),h()}function p(){o&&a.el.scrollTo(a[`frm-${k.anim.currentFrame}`].el.offsetLeft-10,0)}function f(){k.ui.faces.frameDisplay.value=k.anim.currentFrame,a.setProp("--num-frames",k.anim.endFrame+1),a.setProp("--num-tweens",k.anim.layers.reduce(((e,a)=>e+a.tweens.length),0)),a.clear();const e=k.anim.endFrame+1;for(let t=0;t<e;t++){const e=new g({text:`${t}`,css:{gridColumnStart:1+2*t,gridColumnEnd:3+2*t},class:"frame",callback:function(){k.draw.reset(),k.render.setFrame(t),k.ui.update()}});t==k.anim.currentFrame&&e.addClass("current"),e.removeClass("btn"),a.append(e,`frm-${t}`)}k.anim.isPlaying||h(),p()}function h(){let e=0;if(n){const n=r?k.anim.layers.filter((e=>{const a=k.anim.currentFrame;for(let t=a-s;t<=a+s;t++)if(e.isInFrame(t))return!0;return!1})):k.anim.layers;let i=2,o=3;if(l)for(let r=0,s=c.length;r<s;r++){let s=n.filter((e=>e.groupNumber===r));if(0===s.length)continue;const l=s.reduce(((e,a)=>e.startFrame<a.startFrame?e:a)).startFrame,d=s.reduce(((e,a)=>e.endFrame<a.endFrame?e:a)).endFrame;s.forEach((e=>{e.startFrame!==l&&(e.startFrame=l),e.endFrame!==l&&(e.endFrame=d)}));const m=new I(s,{name:c[r],index:r,type:"group",startFrame:l,endFrame:d,width:t*(d-l+1),css:{gridRowStart:i,gridRowEnd:o,gridColumnStart:2*l+1,gridColumnEnd:2*d+3}});i+=2,o+=2,e++,a.append(m,`group-${r}`)}for(let s=0,d=k.anim.layers.length-1;s<d;s++){const d=k.anim.layers[s];if(d.groupNumber>=0&&l)continue;if(r&&!n.includes(d))continue;const m=new x(d,{group:l?void 0:c[d.groupNumber],canMoveUp:s>0&&n.length>2,type:"layer",width:t*(d.endFrame-d.startFrame+1),css:{gridRowStart:i,gridRowEnd:o,gridColumnStart:2*d.startFrame+1,gridColumnEnd:2*d.endFrame+3},moveUp:function(){const e=k.anim.layers.indexOf(d),a=e-1;a>=0&&([k.anim.layers[a],k.anim.layers[e]]=[k.anim.layers[e],k.anim.layers[a]]),f()},addToGroup(e){if(k.draw.reset(),0===c.length){let e=prompt("Name new group","New Group 0");c.push(e),d.groupNumber=0,k.ui.update()}else{let a=new u({title:"Select Group",app:k,position:e,callback:function(){d.groupNumber=+t.value,k.ui.update()}});a.addBreak("Groups:");let t=new v({});for(let e=0;e<c.length;e++)t.addOption(e,0===e,c[e]);a.add(t),a.addBreak(),a.add(new g({text:"New Group",callback:function(){a.clear();let e=prompt("Name new group","New Group "+c.length);c.push(e),d.groupNumber=c.length-1,k.ui.update()}}))}},setLinesProperties:function(){k.draw.setProperties(d.getEditProps(),!0)}});i+=2,o+=2,e++,a.append(m,`layer-${s}`);for(let e=0;e<d.tweens.length;e++){const t=d.tweens[e],n=new S({type:"tween",css:{gridRowStart:i,gridRowEnd:o,gridColumnStart:2*t.startFrame+1,gridColumnEnd:2*t.endFrame+3}},t,d);a.append(n,`tween-${e}-layer-${s}`),i+=2,o+=2}}}a.setProp("--num-layers",e)}function w(){for(let e=0,a=k.anim.layers.length-1;e<a;e++){const a=k.anim.layers[e];if(a.isInFrame(k.anim.currentFrame)){const e=a.getCloneProps();e.startFrame=k.anim.currentFrame+1,k.anim.addLayer(new i(e)),a.endFrame=k.anim.currentFrame}}k.render.setFrame(k.anim.currentFrame+1)}function b(e){for(let t=0,n=k.anim.layers.length-1;t<n;t++){const n=k.anim.layers[t];n.isInFrame(k.anim.currentFrame)&&n.isToggled!==e&&(n.groupNumber>=0?a[`group-${n.groupNumber}`].toggle.update(e):a[`layer-${t}`].toggle.update(e))}}function y(e){for(let t=0,n=k.anim.layers.length-1;t<n;t++){const n=k.anim.layers[t];n.isInFrame(k.anim.currentFrame)&&n.isLocked!==e&&a[`layer-${t}`].lock.update(e)}}return{connect:function(){e=k.ui.getPanel("timeline"),k.ui.addProps({viewGroups:{value:l,text:"G",noLabel:!0,callback:e=>{l=e,f()}},viewLayers:{value:n,key:"ctrl-l",text:"V",class:"left-end",noLabel:!0,callback:e=>{n=e,f()}},viewActiveLayers:{value:r,key:"ctrl-l",text:"V",class:"right-end",noLabel:!0,callback:e=>{r=e,f()}},viewLayerRange:{type:"UINumberStep",value:s,noLabel:!0,callback:e=>{s=e},range:[0,10]},useScrollToFrame:{type:"UIToggle",text:"Follow",noLabel:!0,value:o,callback:e=>{o=e}}}),k.ui.addCallbacks([{callback:d,text:"⇿",key:"alt-f",class:"left-end"},{callback:m,text:"⏛",key:"ctrl-f",class:"right-end"},{callback:b,text:"Select",key:"shift-v",class:"left-end",args:[!0]},{callback:b,text:"Deselect",key:"alt-d",class:"right-end",args:[!1]},{callback:y,text:"Lock",key:"shift-l",class:"left-end",args:[!0]},{callback:y,text:"Unlock",key:"alt-l",class:"right-end",args:[!1]},{callback:w,text:"Split"}]),a=e.addRow("timeline")},update:f,init:function(){e.el.addEventListener("mousemove",(e=>{1==e.which&&e.target.classList.contains("frame")&&k.anim.currentFrame!=+e.target.textContent?(k.draw.reset(),k.render.setFrame(+e.target.textContent),k.ui.update()):e.which}))},getGroups:()=>c,setGroups(e){c=e}}}(),k.animator=function(){let e,a;function t(){a=new n(k.anim),k.anim.onPlayedState=()=>{a.update()},function(){for(const t in a.params){const n=e.addRow(),r=a.params[t];e.add(new m({text:t}),n);const i=e.addRow();e.add(new UINumber({text:"Min",value:r[0],callback:function(e){r[0]=+e}}),i,"min"),e.add(new UINumber({text:"Max",value:r[1],callback:function(e){r[1]=+e}}),i,"max")}}()}function r(){a=void 0,k.anim.onPlayedState=void 0;for(let a=e.rows.length-1;a>0;a--)e.rows[a].clear(),e.removeRow(e.rows[a])}return{connect:function(){e=k.ui.getPanel("animator"),k.ui.addCallbacks([{callback:t,text:"Add"},{callback:r,text:"Remove"}])}}}(),k.ui=o(k,{useMain:!1}),k.ui.setup(),k.canvas.connect(),k.render.connect(),k.draw.connect(),k.bg.connect(),k.data.connect(),k.fio.connect(),k.capture.connect(),k.states.connect(),k.palette.connect(),k.drawings.connect(),k.animator.connect(),k.timeline.connect(),k.ui.update=function(){k.timeline.update(),k.drawings.update(),k.states.update()},k.ui.update(),k.ui.settings=new c(k,{name:"lns",workspaceFields:["hideCursor"],workspaces:[{text:"Animation",url:"/animate/workspaces/Animation.json"},{text:"Drawing",url:"/animate/workspaces/Drawing.json"}],appSave:()=>({palettes:k.palette.getPalettes()}),addLoad(e){k.palette.setup(e.palettes)}}),k.ui.settings.load(),k.draw.setDefaults(),F.src&&k.fio.loadFile(F.src),k.render.start(),k.timeline.init(),k.render.toggleStats(),console.log(k);class x extends h{constructor(e,a){super(a),this.addClass("layer"),this.layer=e,a.canMoveUp&&(this.canMoveUp=a.canMoveUp);const t=a.width,n=new b({btnClass:"layer-toggle",class:"timeline-btn",text:`${e.drawingIndex}`,isOn:e.isToggled,callback:t=>{e.isToggled=t,e.isToggled&&a.setLinesProperties&&a.setLinesProperties(),r.update(e.isToggled)}}),r=new b({btnClass:"layer-highlight",class:"timeline-btn",text:"*",isOn:e.isHighlighted,callback:a=>{e.isHighlighted=a}}),i=new g({btnClass:"layer-edit",class:"timeline-btn",text:"E",callback:()=>{this.editModal(e,a)}});a.group&&(this.groupLabel=new m({text:a.group}));const s=this.getPropUIs(e,a,!1);t>40&&this.append(s.startFrameNumber),this.append(n),this.append(r),t>20&&this.append(i),t>50&&this.append(s.lock),t>60&&this.append(s.tween),t>70&&this.append(s.remove),t>80&&this.append(s.addToGroup),t>90&&this.append(s.merge),t>90&&this.canMoveUp&&this.append(s.moveUp),t>100&&this.groupLabel&&this.append(this.groupLabel),t>80&&(this.append(s.endFrameNumber),s.endFrameNumber.addClass("right-margin"))}getPropUIs(e,a,t){const n={},r=t?"btn":"timeline-btn";n.tween=new g({text:t?"Add Tween":"T",class:r,btnClass:"layer-tween",callback:()=>{this.tweenModal(e)}}),n.remove=new g({btnClass:"remove",text:t?"Remove":"X",class:r,callback:()=>{k.anim.removeLayer(e),k.ui.update()}}),n.startFrameNumber=new p({value:e.startFrame,class:t?"":r,min:0,max:k.anim.endFrame+1,callback:a=>{e.startFrame=+a,+a>e.endFrame&&(e.endFrame=+a),k.ui.update()}}),n.endFrameNumber=new p({value:e.endFrame,class:t?"":r,min:0,callback:a=>{e.endFrame=+a,+a<e.startFrame&&(e.startFrame=+a),k.ui.update()}}),n.lock=new b({btnClass:"layer-lock",text:t?"Lock":"L",class:r,isOn:e.isLocked,callback:function(a){e.isLocked=a}}),n.moveUp=new g({text:t?"Move Up":"^",btnClass:"move-up",class:r,callback:a.moveUp}),n.addToGroup=new g({text:t?"Add to Group":"G",btnClass:"add-to-group",class:r,callback:()=>{a.addToGroup(this.position)}});const i=function(){k.timeline.resetLayers(),k.ui.update()};return n.merge=new g({text:t?"Merge Layer":"M",class:r,btnClass:"merge-layer",callback:()=>{const a=new u({text:"Merge Layer",app:k,position:this.position,callback:i,clearFunc:i});for(let t=0,n=k.anim.layers.length-1;t<n;t++){const n=k.anim.layers[t];n!==e&&(n.isInFrame(k.anim.currentFrame)&&(a.add(new m({text:`Layer ${t}, Drawing ${n.drawingIndex}`})),a.add(new b({text:"*",class:"left-end",isOn:n.isHighlighted,callback:e=>{n.isHighlighted=e}})),a.add(new g({text:"Merge",class:"right-end",callback:()=>{k.anim.merge(e.drawingIndex,n.drawingIndex,e),k.anim.removeLayer(n),i(),a.clear()}}))))}}}),n}editModal(e,a){const t=new u({title:"Edit Layer",app:k,position:this.position,callback:()=>{k.ui.update()}}),n=this.getPropUIs(e,a,!0);for(const e in n)"startFrameNumber"===e&&t.addBreak("Start Frame:"),"endFrameNumber"===e&&t.addBreak("End Frame:"),t.add(n[e]),"endFrameNumber"===e&&t.addBreak();t.add(new g({text:"Cut Segment",callback:()=>{const a=k.anim.drawings[e.drawingIndex];a.pop(),a.pop(),a.add("end"),e.resetDrawingEndIndex(a.length)}})),t.add(new g({text:"Cut Line",callback:()=>{const a=k.anim.drawings[e.drawingIndex];a.pop();for(let e=a.length-1;e>0&&"end"!==a.get(e)[0];e--)a.pop();e.resetDrawingEndIndex(a.length)}})),t.add(new g({text:"Line to Layer",callback:()=>{k.draw.reset();const a=k.anim.drawings[e.drawingIndex];a.pop();for(let e=a.length-1;e>0;e--){const e=a.pop();if("end"===e)break;k.draw.drawing.add(e)}k.draw.reset(),k.ui.update()}})),t.add(new g({text:"Clone Layer",callback:()=>{const a=e.getCloneProps();a.startFrame=a.endFrame=e.endFrame+1,k.anim.addLayer(new i(a)),k.render.setFrame(e.endFrame+1)}})),t.add(new g({text:"Split",callback:()=>{const a=e.getCloneProps();a.startFrame=k.anim.currentFrame+1,e.endFrame=k.anim.currentFrame,k.anim.addLayer(new i(a)),k.render.setFrame(e.endFrame+1)}})),t.adjustPosition()}tweenModal(e){const a={prop:"endIndex",startFrame:k.anim.currentFrame,endFrame:k.anim.currentFrame+10,startValue:0,endValue:"end"},t=new u({title:"Add Tween",app:k,position:this.position,callback:()=>{a.endValue=k.anim.drawings[e.drawingIndex].length,e.addTween(a),k.ui.update()}});t.addBreak("Property:"),t.add(new v({options:Object.keys(e.getTweenProps()),value:"endIndex",selected:"endIndex",callback:function(e){a.prop=e}})),t.addBreak("Start Frame:"),t.add(new UINumber({value:a.startFrame,callback:function(e){a.startFrame=+e}})),t.addBreak("End Frame:"),t.add(new UINumber({value:a.endFrame,callback:function(e){a.endFrame=+e}})),t.addBreak("Start Value:"),t.add(new UINumber({value:a.startValue,callback:function(e){a.startValue=+e}})),t.addBreak("End Value:"),t.add(new UINumber({value:a.endValue,callback:function(e){a.endValue=+e}}))}}class I extends h{constructor(e,a){super(a),this.index=a.index,this.layers=e,this.addClass("group"),this.startFrame=a.startFrame,this.endFrame=a.endFrame;const t=a.width;this.isToggled=!1;const n=new b({type:"group-toggle",class:"timeline-btn",text:a.name,isOn:this.isToggled,callback:a=>{this.isToggled=a,r.update(a),e.forEach((e=>{e.toggle(this.isToggled)}))}}),r=new b({type:"group-highlight",class:"timeline-btn",text:"*",isOn:!1,callback:a=>{e.forEach((e=>{e.isHighlighted=a}))}}),i=new g({type:"layer-edit",class:"timeline-btn",text:"E",callback:()=>{this.editModal(e,a)}}),s=this.getPropUIs(e,a,!1);t>30&&this.append(s.startFrameNumber),this.append(n),this.append(r),t>20&&this.append(i),t>50&&this.append(s.lock),t>60&&this.append(s.breakUp),t>70&&this.append(s.removeLayer),t>80&&(this.append(s.endFrameNumber),s.endFrameNumber.addClass("right-margin"))}getPropUIs(e,a,t){const n={},r=t?"btn":"timeline-btn";return n.lock=new b({type:"group-lock",text:t?"Lock":"L",class:r,isOn:!1,callback:function(){e.forEach((e=>{e.isLocked=!e.isLocked}))}}),n.breakUp=new g({type:"group-breakup",class:r,text:t?"Break up":"X",callback:function(){e.forEach((e=>{e.groupNumber=-1})),k.ui.update()}}),n.removeLayer=new g({type:"group-remove-layer",class:r,text:t?"Remove Layer":"R",callback:()=>{const e=function(){k.timeline.resetLayers(),k.ui.update()},a=new u({title:"Remove Layers",app:k,position:this.position,callback:e,onClear:e});for(let e=0,t=k.anim.layers.length;e<t;e++){if(k.anim.layers[e].groupNumber!==this.index)continue;const t=k.anim.layers[e],n=new g({text:`Layer ${e}, Drawing ${t.drawingIndex}`,callback:function(){t.groupNumber=-1,a.remove(n)}});a.add(n)}}}),n.startFrameNumber=new p({value:this.startFrame,class:t?"":r,min:0,callback:a=>{e.forEach((e=>{e.startFrame=+a,+a>e.endFrame&&(e.endFrame=+a)})),k.ui.update()}}),n.endFrameNumber=new p({value:this.endFrame,class:t?"":r,min:0,callback:a=>{e.forEach((e=>{e.endFrame=+a,+a<e.startFrame&&(e.startFrame=+a)})),k.ui.update()}}),n}editModal(e,a){const t=new u({title:"Edit Group",app:k,position:this.position,callback:()=>{k.ui.update()}}),n=this.getPropUIs(e,a,!0);for(const e in n)"startFrameNumber"===e&&t.addBreak("Start Frame:"),"endFrameNumber"===e&&t.addBreak("End Frame:"),t.add(n[e]);t.adjustPosition()}}class S extends h{constructor(e,a,t){super(e),this.addClass("tween"),this.tween=a,this.edit=new g({text:"✎",type:"tween-edit",callback:()=>{const e=new u({title:"Edit Tween",app:k,position:this.position,callback:function(){k.ui.update()}});e.addBreak("Start Frame:"),e.add(new UINumber({value:a.startFrame,callback:function(e){a.startFrame=+e}})),e.addBreak("End Frame:"),e.add(new UINumber({value:a.endFrame,callback:function(e){a.endFrame=+e}})),e.addBreak("Start Value:"),e.add(new UINumber({value:a.startValue,callback:function(e){a.startValue=+e}})),e.addBreak("End Value:"),e.add(new UINumber({value:a.endValue,callback:function(e){a.endValue=+e}}))}}),this.left=new y({text:"⬗",type:"left",callback:(e,t)=>{a.startFrame+=(e||-1)*(t||1),k.ui.update()}}),this.right=new y({text:"⬖",type:"right",callback:(e,a)=>{this.tween.endFrame+=(e||1)*(a||1),k.ui.update()}}),this.remove=new g({type:"remove",text:"🗑",callback:()=>{t.tweens.splice(t.tweens.indexOf(this),1),k.ui.update()}}),this.append(this.edit),this.append(this.remove),this.append(this.left),this.append(this.right)}get html(){return this.el}}}();
//# sourceMappingURL=src_maps/animate.min.js.map
