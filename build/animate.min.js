function Background(){const e=this;this.show=!0,this.img=new Image,this.x=0,this.y=0,this.width=0,this.height=0,this.size=1,this.loadImage=function(n){e.img.src=n,e.img.onload=function(){e.width=e.img.width,e.height=e.img.height}},this.toggle=function(){e.show=!e.show},this.display=function(){this.img.src&&this.show&&lns.canvas.ctx.drawImage(this.img,this.x,this.y,this.size*this.width,this.height*this.size)}}function Canvas(e,n,t,s,a){const i=this;this.canvas=document.getElementById(e),this.dpr=a&&window.devicePixelRatio||1,this.scale=1,this.ctx=this.canvas.getContext("2d"),this.ctx.miterLimit=1,this.lineWidth=1,this.setBGColor=function(e){i.bgColor=e,i.canvas.style.backgroundColor=e},this.setBGColor(s),this.setLineWidth=function(e){i.ctx.lineWidth=i.lineWidth=+e,i.ctx.miterLimit=1},this.setScale=function(e){i.scale=+e,i.setWidth(i.width),i.setHeight(i.height)},this.setWidth=function(e){i.width=+e,i.canvas.width=+e*i.dpr*i.scale,i.reset()},this.setHeight=function(e){i.height=+e,i.canvas.height=+e*i.dpr*i.scale,i.reset()},this.reset=function(){i.ctx.scale(1,1),i.ctx.scale(this.dpr*i.scale,i.dpr*i.scale),i.canvas.style.zoom=1/i.dpr,i.ctx.lineWidth=i.lineWidth,i.ctx.miterLimit=1},this.setWidth(n),this.setHeight(t),this.fitCanvasToDrawing=function(){lns.draw.reset();let e=0,n={x:1e4,y:1e4},t={x:0,y:0};for(let s=0;s<lns.anim.layers.length;s++){const a=lns.anim.layers[s],i=lns.anim.drawings[a.d];for(let s=0;s<i.length;s++){const l=i[s];"end"!=l&&(e=Math.max(e,4*a.r),n.x=Math.min(n.x,l.x+a.x),n.y=Math.min(n.y,l.y+a.y),t.x=Math.max(t.x,l.x+a.x),t.y=Math.max(t.y,l.y+a.y))}}lns.ui.faces.width.update(t.x-n.x+2*e),lns.ui.faces.height.update(t.y-n.y+2*e);for(let t=0;t<lns.anim.layers.length-1;t++)lns.anim.layers[t].x-=n.x-e>0?n.x-e:0,lns.anim.layers[t].y-=n.y-e>0?n.y-e:0}}function Data(e){const n=this;this.copyFrame=[],this.pasteFrames=[],this.saveStates={current:{drawings:void 0,layers:void 0},prev:{drawings:void 0,layers:void 0}},this.saveState=function(){n.saveStates.current.drawings?(n.saveStates.prev.drawings=_.cloneDeep(n.saveStates.current.drawings),n.saveStates.prev.layers=_.cloneDeep(n.saveStates.current.layers)):(n.saveStates.prev.drawings=_.cloneDeep(e.drawings),n.saveStates.prev.layers=_.cloneDeep(e.layers)),n.saveStates.current.drawings=_.cloneDeep(e.drawings),n.saveStates.current.layers=_.cloneDeep(e.layers)},this.undo=function(){n.saveStates.prev.drawings?(e.drawings=_.cloneDeep(n.saveStates.prev.drawings),e.layers=_.cloneDeep(n.saveStates.prev.layers),n.saveStates.current.drawings=_.cloneDeep(n.saveStates.prev.drawings),n.saveStates.current.layers=_.cloneDeep(n.saveStates.prev.layers),n.saveStates.prev.drawings=void 0,n.saveStates.prev.layers=void 0):console.log("%c Can't undo ","color:lightblue;background:gray;"),lns.ui.drawings.clear(),lns.ui.update()},this.copy=function(){lns.draw.reset(),n.copyFrame=[];for(let t=0;t<e.layers.length-1;t++)e.layers[t].isInFrame(e.currentFrame)&&n.copyFrame.push(e.layers[t])},this.paste=function(){n.saveState(),0==n.pasteFrames.length&&n.pasteFrames.push(e.currentFrame);for(let t=0;t<n.pasteFrames.length;t++)for(let s=0;s<n.copyFrame.length;s++){const a=n.copyFrame[s].addIndex(n.pasteFrames[t]);a&&e.addLayer(a)}n.clearSelected(),lns.draw.reset(),lns.ui.update()},this.selectFrame=function(e){e.classList.contains("selected")?(n.pasteFrames.splice(n.pasteFrames.indexOf(+e.textContent),1),e.classList.remove("selected")):(e.classList.add("selected"),n.pasteFrames.push(+e.textContent))},this.selectAll=function(){const e=Array.from(lns.ui.frames.children).filter(e=>e.classList.contains("selected")).length<lns.ui.frames.children.length-1;lns.ui.frames.looper(t=>{e&&t.classList.remove("selected"),n.selectFrame(t)})},this.selectRange=function(){const e=prompt("Start frame:"),t=prompt("end frame:");lns.ui.frames.looper(e=>{n.selectFrame(e)},e,t)},this.clearSelected=function(){n.pasteFrames=[];const e=document.getElementsByClassName("selected");for(let n=e.length-1;n>=0;n--)e[n].classList.remove("selected")},this.clearLines=function(){lns.draw.drawing=[]},this.clearLayers=function(){n.saveState();for(let n=e.layers.length-2;n>=0;n--)e.layers[n].isInFrame(e.currentFrame)&&(e.layers[n].removeIndex(e.currentFrame,(function(){e.layers.splice(n,1)})),lns.ui.update())},this.cutTopLayer=function(){for(let n=e.layers.length-2;n>=0;n--){e.layers[n].isInFrame(e.currentFrame)&&(e.layers[n].removeIndex(e.currentFrame,(function(){e.layers.splice(n,1)})),lns.ui.update());break}},this.cutBottomLayer=function(){for(let n=0;n<e.layers.length-1;n++){e.layers[n].isInFrame(e.currentFrame)&&(e.layers[n].removeIndex(e.currentFrame,(function(){e.layers.splice(n,1)})),lns.ui.update());break}},this.clearFrame=function(){n.clearLines(),n.clearLayers()},this.deleteFrame=function(t){const s=void 0!==t?t:lns.anim.currentFrame;n.saveState();for(let n=e.layers.length-2;n>=0;n--)e.layers[n].removeIndex(e.currentFrame,(function(){e.layers.splice(n,1)}));for(let n=e.layers.length-2;n>=0;n--)e.layers[n].shiftIndex(s,-1);lns.ui.update()},this.deleteFrameRange=function(){n.saveState();const e=+prompt("Start frame:"),t=+prompt("End frame:");if(t>0){for(let s=t;s>=e;s--)n.deleteFrame(s);lns.draw.cutEnd(),lns.ui.setFrame(0)}},this.cutLastSegment=function(){lns.draw.pop()},this.cutLastLine=function(){lns.draw.popOff()},this.insert=function(t){lns.draw.reset(),n.saveState();for(let n=0,s=e.layers.length-1;n<s;n++)e.layers[n].shiftIndex(e.currentFrame+t,1),e.addLayer(e.layers[n].removeIndex(e.currentFrame+t)),e.frame=e.currentFrame+t;lns.ui.update()},this.addMultipleCopies=function(){n.copyFrame=[],n.clearSelected();let e=+prompt("Number of copies: ");if(n.copy(),e)for(let t=0;t<e;t++)lns.ui.play.next(1),n.paste();lns.ui.update()},this.offsetDrawing=function(t){let s=e.layers.filter(e=>e.toggled);if(0==s.length&&(s=lns.anim.layers.filter(e=>e.isInFrame(lns.anim.currentFrame))),lns.draw.reset(),s){if(n.saveState(),t||(t=new Cool.Vector(+prompt("x"),+prompt("y"))),t)for(let e=0;e<s.length;e++)s[e].x+=t.x,s[e].y+=t.y}else console.log("%c No layers in frame ","color:yellow; background:black;")},this.quickAnimate=function(n){lns.draw.reset();const t=+prompt("Number of frames?");for(let s=0;s<e.layers.length-1;s++){const a=e.layers[s];if(a.isInFrame(e.currentFrame))switch(a.endFrame=a.startFrame+t,e.state.end<a.endFrame&&(e.state.end=a.endFrame),n){case"Draw":a.addTween({prop:"e",sf:a.f.s,ef:a.f.e,sv:0,ev:e.drawings[a.d].length});break;case"Reverse":a.addTween({prop:"s",sf:a.f.s,ef:a.f.e,sv:0,ev:e.drawings[a.d].length});break;case"DrawReverse":const n=Math.floor(t/2);a.addTween({prop:"e",sf:a.f.s,ef:a.f.s+n,sv:0,ev:e.drawings[a.d].length}),a.addTween({prop:"s",sf:a.f.s+n,ef:a.f.e,sv:0,ev:e.drawings[a.d].length})}}lns.ui.update()}}function Draw(e){const n=this;if(Object.defineProperty(this,"layer",{get:function(){return lns.anim.layers[lns.anim.layers.length-1]}}),Object.defineProperty(this,"drawing",{get:function(){return lns.anim.drawings[lns.anim.drawings.length-1]},set:function(e){lns.anim.drawings[lns.anim.drawings.length-1]=e}}),lns.anim.drawings.push(new Drawing),lns.anim.layers.push(new Layer({...e,d:Math.max(lns.anim.drawings.length-1,0),f:{s:lns.anim.currentFrame,e:lns.anim.currentFrame}})),this.setProperties=function(e){for(const t in e)void 0!==n.layer[t]&&(n.layer[t]=e[t],lns.ui.faces[t]&&lns.ui.faces[t].update(e[t]))},this.setProperty=function(e,t){lns.anim.updateProperty(e,t),n.layer[e]=t},this.setDefaults=function(){n.setProperties(e)},this.reset=function(e){n.drawing.length>0&&(lns.anim.drawings.push(new Drawing),lns.anim.layers.push(new Layer({n:+lns.ui.faces.n.value,r:+lns.ui.faces.r.value,w:+lns.ui.faces.w.value,v:+lns.ui.faces.v.value,c:lns.ui.faces.c.value,d:lns.anim.drawings.length-1,f:{s:+e||lns.anim.currentFrame,e:+e||lns.anim.currentFrame}})),lns.data.saveState()),lns.ui.update()},this.cutEnd=function(){let e=0;for(let n=0;n<lns.anim.layers.length-1;n++){const t=lns.anim.layers[n];t.endFrame>e&&(e=t.endFrame)}lns.draw.layer.endFrame>e&&(lns.draw.layer.endFrame=e)},this.hasDrawing=function(){return lns.anim.layers.some(e=>e.isInFrame(lns.anim.currentFrame)&&lns.anim.drawings[e.d].length>0)},this.brush=0,this.brushSpread=1,this.startDots=!1,this.dots=10,this.grass=0,this.mouseTimer=performance.now(),this.mouseInterval=30,this.isDrawing=!1,this.outSideCanvas=function(e){e.toElement!=lns.canvas.canvas&&(n.isDrawing&&n.reset(),n.isDrawing=!1)},this.pop=function(){n.drawing.length>0&&("end"==n.drawing.pop()&&n.drawing.pop(),n.drawing.add("end"))},this.popOff=function(){if(n.drawing.length>0){n.drawing.pop();for(let e=n.drawing.length-1;e>0&&"end"!=n.drawing.get(e);e--)n.drawing.pop()}},this.addBrush=function(e,t){const s=n.brush*n.brush*n.brushSpread;let a=1;n.grass>0&&(a*=n.grass);let i=new Cool.Vector(e,t);for(let l=0;l<n.brush;l++){let l=new Cool.Vector(e+Cool.randomInt(-s,s),t+Cool.randomInt(-s,s));for(;l.dist(i)>s;)l=new Cool.Vector(e+Cool.randomInt(-s,s),t+Cool.randomInt(-s,s));l.divide(lns.canvas.scale),l.x>0&&l.x<lns.canvas.width&&l.y>0&&l.y<lns.canvas.height&&n.drawing.add(l);const r=Cool.randomInt(1,3);for(let e=0;e<r;e++)l.x>0&&l.x<lns.canvas.width&&l.y>0&&l.y<lns.canvas.height&&n.drawing.add(new Cool.Vector(l.x+Cool.randomInt(-1,1),l.y+Cool.randomInt(a)));n.drawing.add("end")}},this.addLine=function(e,t){n.drawing.add(new Cool.Vector(e,t).divide(lns.canvas.scale))},this.update=function(e){performance.now()>n.mouseInterval+n.mouseTimer&&(n.mouseTimer=performance.now(),n.isDrawing&&(n.brush<=0?n.addLine(Math.round(e.offsetX),Math.round(e.offsetY)):n.addBrush(Math.round(e.offsetX),Math.round(e.offsetY))))},this.start=function(e){1!=e.which||lns.render.isPlaying||e.altKey?e.altKey&&(n.startDots=new Cool.Vector(Math.round(e.offsetX),Math.round(e.offsetY))):(n.isDrawing=!0,n.mouseTimer=performance.now(),n.brush<=0?n.addLine(Math.round(e.offsetX),Math.round(e.offsetY)):n.addBrush(Math.round(e.offsetX),Math.round(e.offsetY)))},this.end=function(e){if(n.startDots){const t=Math.abs(n.startDots.x-e.offsetX),s=Math.abs(n.startDots.y-e.offsetY),a=t/s,i=t/(a*n.dots/2),l=s/(1/a*n.dots/2);let[r,o]=n.startDots.x<e.offsetX?[n.startDots.x,e.offsetX]:[e.offsetX,n.startDots.x],[c,d]=n.startDots.y<e.offsetY?[n.startDots.y,e.offsetY]:[e.offsetY,n.startDots.y];for(let e=r;e<o;e+=i)for(let t=c;t<d;t+=l){const s=Math.round(e)+Cool.randomInt(-i/2,i/2),a=Math.round(t)+Cool.randomInt(-l/2,l/2),r=Cool.randomInt(1,3);for(let e=0;e<r;e++)n.drawing.add(new Cool.Vector(s+Cool.randomInt(-1,1),a+Cool.randomInt(-1,1)));n.drawing.add("end")}n.startDots=!1}else 1==e.which&&(n.isDrawing=!1,"end"!==n.drawing.get(-2)&&n.drawing.length>1?n.drawing.add("end"):n.drawing.pop())},window.PointerEvent)lns.canvas.canvas.addEventListener("pointermove",n.update),lns.canvas.canvas.addEventListener("pointerdown",n.start),lns.canvas.canvas.addEventListener("pointerup",n.end);else{lns.canvas.canvas.addEventListener("mousemove",n.update),lns.canvas.canvas.addEventListener("mousedown",n.start),lns.canvas.canvas.addEventListener("mouseup",n.end);const e={which:1};function t(n,t){if(n.preventDefault(),n.touches[0]){const s=n.target.getBoundingClientRect();e.offsetX=n.targetTouches[0].pageX-s.left-window.scrollX,e.offsetY=n.targetTouches[0].pageY-s.top-window.scrollY,e.which=1,t(e)}}lns.canvas.canvas.addEventListener("touchstart",e=>{t(e,n.start)}),lns.canvas.canvas.addEventListener("touchmove",e=>{t(e,n.update)}),lns.canvas.canvas.addEventListener("touchend",t=>{n.end(e)})}document.addEventListener("mousemove",n.outSideCanvas)}function Files(e){const n=this;this.saveFilesEnabled=!1,this.saveSettingsOnUnload=e.save||!1,this.fileName=void 0,this.saveFile=function(t,s){lns.draw.reset(),lns.ui.play.checkEnd(),lns.anim.drawings.pop(),lns.anim.layers.pop(),n.fileName=lns.ui.faces.title.value||prompt("Name this file:"),e.fit&&confirm("Fit canvas?")&&lns.canvas.fitCanvasToDrawing();const a={v:"2.4"};a.w=+lns.canvas.width,a.h=+lns.canvas.height,a.fps=+lns.anim.fps,e.bg&&(a.bg=lns.canvas.bgColor);let i=lns.anim.layers.map(e=>e.c);i=[...new Set(i)],a.mc=i.length>1;let l=[];if(t){for(let e=0;e<lns.anim.layers.length;e++)if(lns.anim.layers[e].isInFrame(lns.anim.currentFrame)){const n=_.cloneDeep(lns.anim.layers[e]);n.startFrame=0,n.endFrame=0,l.push(n)}}else l=lns.anim.layers;for(let e=0;e<l.length;e++)l[e].clean();a.l=l;const r=[];for(let e=0;e<l.length;e++){const n=l[e].d;r.includes(n)||r.push(n)}a.d=[];for(let e=0;e<r.length;e++){const n=r[e],t=lns.anim.drawings[n],s=[];for(let e=0;e<t.length;e++){const n=t.get(e);"end"==n?s.push(0):s.push([n.x,n.y])}a.d[n]=s}Object.keys(lns.anim.states).length>1&&(a.s=_.cloneDeep(lns.anim.states),delete a.s.default);const o=JSON.stringify(a);if(n.fileName){const e=new Blob([o],{type:"application/x-download;charset=utf-8"});saveAs(e,n.fileName+".json"),lns.ui.faces.title.value=n.fileName}},this.loadFile=function(e,t){n.fileName=e,n.fileName&&(".json"!=n.fileName.slice(n.fileName.length-5)&&(n.fileName+=".json"),fetch(n.fileName).then(e=>e.json()).then(e=>{n.loadJSON(e,t)}).catch(e=>{alert("File not found: "+e.message),console.error(e)}))},this.loadJSON=function(n,t){lns.anim.drawings=[],lns.anim.layers=[],lns.anim.loadData(n,(function(){for(let e=0;e<n.l.length;e++)lns.anim.layers[e]=new Layer(n.l[e]);lns.canvas.setWidth(n.w),lns.canvas.setHeight(n.h),lns.ui.faces.fps.update(n.fps),n.bg&&lns.canvas.setBGColor(n.bg),lns.draw.reset(),t&&t(n,e)}))},this.reOpenFile=function(){n.saveFile({},(function(e){location.href+=`?src=/${prompt("Enter location:")}/${e}.json`}))},this.openFile=function(){const e=document.createElement("input");e.type="file",e.click(),e.onchange=function(){n.readFile(e.files,lns.ui.updateFIO)}},this.readFile=function(e,t){for(let s,a=0;s=e[a];a++){if(!s.type.match("application/json"))continue;const e=new FileReader;e.onload=function(e){n.fileName=s.name.split(".")[0],n.loadJSON(JSON.parse(e.target.result),t)},e.readAsText(s)}},window.File&&window.FileReader&&window.FileList&&window.Blob&&(n.saveFilesEnabled=!0,console.log("%c Save file enabled ","color:lightgreen;background:black;"),lns.canvas.canvas.addEventListener("dragover",(function(e){e.preventDefault()})),lns.canvas.canvas.addEventListener("drop",(function(e){e.preventDefault(),e.stopPropagation(),n.readFile(e.dataTransfer.files,lns.ui.updateFIO)}))),window.addEventListener("beforeunload",(function(t){n.saveSettingsOnUnload&&lns.ui.settings.saveSettings(),e.reload&&(t.returnValue="Did you save dumbhole?")}))}function Render(e,n){const t=this;this.lps=e||12,this.interval=1e3/this.lps,this.timer=performance.now(),this.onionSkinNum=0,this.onionSkinIsVisible=!1,this.setOnionSkin=function(e){t.onionSkinNum=+e,t.onionSkinIsVisible=+e>0},this.reset=function(){lns.anim.frame=0,lns.anim.isPlaying=!1,lns.canvas.ctx.miterLimit=1,lns.ui.update()},this.toggle=function(){lns.anim.isPlaying||(lns.ui.play.checkEnd(),lns.ui.timeline.update()),lns.anim.isPlaying=!lns.anim.isPlaying},this.setLps=function(e){t.lps=+e,t.interval=1e3/t.lps,lns.anim.lps=t.lps},this.update=function(e){if(performance.now()>t.interval+t.timer||"cap"==e){if(t.timer=performance.now(),lns.anim.isPlaying&&lns.ui.timeline.update(),lns.canvas.ctx.clearRect(0,0,lns.canvas.width,lns.canvas.height),lns.ui.capture.bg&&(lns.ui.capture.frames>0||lns.ui.capture.isVideo)&&(lns.canvas.ctx.fillStyle=lns.canvas.bgColor,lns.canvas.ctx.fillRect(0,0,lns.canvas.width,lns.canvas.height)),lns.bgImage.display(),t.onionSkinNum>0&&t.onionSkinIsVisible){const e=lns.anim.currentFrame;for(let n=1;n<=t.onionSkinNum;n++){const s=e-n;if(s>=0){const e=`rgba(105,150,255,${1.5-n/t.onionSkinNum})`;lns.anim.currentFrame=s,lns.anim.overrideProperty("c",e),lns.anim.draw()}}lns.anim.cancelOverride(),lns.anim.currentFrame=e}lns.anim.draw(),lns.anim.update()}lns.ui.capture.isCapturing||window.requestAnimFrame(t.update)},this.start=function(){window.requestAnimFrame(t.update)}}class Layer{constructor(e){this.d=e.d,this.x=e.x||0,this.y=e.y||0,this.f=e.f,this.t=e.t||[],this.n=e.n,this.r=e.r,this.w=e.w,this.v=e.v,this.c=e.c,this.ws=e.ws||!1,this.l=e.l||4,this.lc=0,this.toggled=!1,this.resetTweens()}clean(){delete this.toggled,delete this.pc}toggle(){this.toggled?"#00CC96"==this.c&&(this.c=this.pc):(this.pc=this.c,this.c="#00CC96"),this.toggled=!this.toggled}remove(){lns.anim.layers.splice(lns.anim.layers.indexOf(this),1)}addTween(e){this.t.push(e),e.sf<this.startFrame&&(this.startFrame=e.sf),e.ef>this.endFrame&&(this.endFrame=e.ef)}get startFrame(){return this.f.s}set startFrame(e){this.f.s=Math.max(0,+e),this.resetTweens()}get endFrame(){return this.f.e}set endFrame(e){this.f.e=Math.max(0,+e),this.resetTweens()}addIndex(e){if(!this.isInFrame(e))if(this.f.s-1==e)this.f.s-=1;else{if(this.f.e+1!=e)return new Layer({...this,f:{s:e,e:e}});this.f.e+=1}return this}removeIndex(e,n){if(this.startFrame==e&&this.endFrame==e)n();else if(this.startFrame==e)this.startFrame+=1;else{if(this.endFrame!=e){if(e>this.startFrame&&e<this.endFrame){const n=_.cloneDeep(this);return n.startFrame=e+1,n.endFrame=this.endFrame,n.resetTweens(),this.endFrame=e-1,this.resetTweens(),n}return this}this.endFrame-=1}this.resetTweens()}shiftIndex(e,n){return n||(n=-1),this.startFrame>=e&&(this.startFrame+=n),this.endFrame>=e&&(this.endFrame+=n),this.resetTweens(),this}isInFrame(e){return-1!=lns.anim.layers.indexOf(this)&&(e>=this.f.s&&e<=this.f.e)}get props(){return{n:this.n,r:this.r,w:this.w,v:this.v,ws:this.ws,x:this.x,y:this.y,l:this.l,lc:this.lc,c:this.toggled?this.pc:this.c}}resetTweens(){for(let e=0;e<this.t.length;e++){const n=this.t[e];n.sf<this.startFrame&&(n.sf=this.startFrame),n.ef>this.endFrame&&(n.ef=this.endFrame)}}}class LnsAnim extends LinesAnimation{updateProperty(e,n){for(let t=0;t<this.layers.length-1;t++)this.layers[t].toggled&&(this.layers[t][e]=n)}addLayer(e){-1==this.layers.indexOf(e)&&this.layers.splice(lns.anim.layers.length-1,0,e)}removeLayer(e){const n=this.layers.indexOf(e);n>=0&&this.layers.splice(n,1)}}class UILayer extends UICollection{constructor(e,n){super(e),this.addClass("layer"),this.layer=n,this.toggle=new UIToggle({type:"layer-toggle",text:""+n.d,callback:e.callback}),this.edit=new UIButton({type:"layer-edit",text:"✎",callback:()=>{const e=new UIModal("Edit Layer",lns,this.position,()=>{this.update(),lns.ui.update()});e.add(new UIButton({text:"Cut Segment",callback:()=>{const e=lns.anim.drawings[n.d];e.pop(),e.pop(),e.push("end")}})),e.add(new UIButton({text:"Cut Line",callback:()=>{const e=lns.anim.drawings[n.d];e.pop();for(let n=e.length-1;n>0&&"end"!=e[n];n--)e.pop()}})),e.add(new UIButton({text:"Clone",callback:()=>{const e=new Layer(_.cloneDeep(n));e.startFrame=e.endFrame=n.endFrame+1,lns.anim.layers.splice(lns.anim.layers.length-1,0,e),lns.ui.play.setFrame(n.endFrame+1)}})),e.add(new UIButton({text:"Split",callback:()=>{const e=new Layer(_.cloneDeep(n));e.startFrame=lns.anim.currentFrame+1,n.endFrame=lns.anim.currentFrame,lns.anim.layers.splice(lns.anim.layers.length-1,0,e),lns.ui.play.setFrame(n.endFrame+1)}})),e.add(new UIElement({class:"break"})),e.add(new UILabel({text:"Start Frame:"})),e.add(new UIBlur({value:n.startFrame,callback:function(e){n.startFrame=+e}})),e.add(new UIElement({class:"break"})),e.add(new UILabel({text:"End Frame:"})),e.add(new UIBlur({value:n.endFrame,callback:function(e){n.endFrame=+e}}))}}),this.tween=new UIButton({text:"⧉",type:"layer-tween",callback:()=>{const e={prop:"e",sf:lns.anim.currentFrame,ef:lns.anim.currentFrame+10,sv:0,ev:"end"},t=new UIModal("Add Tween",lns,this.position,(function(){e.ev=lns.anim.drawings[n.d].length,n.addTween(e),lns.ui.update()}));t.add(new UILabel({text:"Property:"})),t.add(new UISelect({options:["e","s","n","r","w","v","x","y"],value:"e",selected:"e",callback:function(n){e.prop=n}})),t.add(new UILabel({text:"Start Frame:"})),t.add(new UIBlur({value:e.sf,callback:function(n){e.sf=+n}})),t.add(new UILabel({text:"End Frame:"})),t.add(new UIBlur({value:e.ef,callback:function(n){e.ef=+n}})),t.add(new UILabel({text:"Start Value:"})),t.add(new UIBlur({value:e.sv,callback:function(n){e.sv=+n}})),t.add(new UILabel({text:"End Value:"})),t.add(new UIBlur({value:e.ev,callback:function(n){e.ev=+n}}))}}),this.remove=new UIButton({type:"remove",text:"🗑",callback:()=>{lns.anim.layers.splice(lns.anim.layers.indexOf(n),1),lns.ui.update()}}),this.left=new UIDragButton({text:"⬗",type:"left",callback:(e,t)=>{n.startFrame+=(e||-1)*(t||1),lns.ui.update()}}),this.right=new UIDragButton({text:"⬖",type:"right",callback:(e,t)=>{n.endFrame+=(e||1)*(t||1),lns.ui.update()}}),this.append(this.toggle),this.append(this.edit),this.append(this.tween),this.append(this.remove),this.append(this.left),this.append(this.right)}get html(){return this.el}}class UITween extends UICollection{constructor(e,n,t){super(e),this.addClass("tween"),this.tween=n,this.edit=new UIButton({text:"✎",type:"tween-edit",callback:()=>{const e=new UIModal("Edit Tween",lns,this.position,(function(){lns.ui.update()}));e.add(new UILabel({text:"Start Frame:"})),e.add(new UIBlur({value:n.sf,callback:function(e){n.sf=+e}})),e.add(new UILabel({text:"End Frame:"})),e.add(new UIBlur({value:n.ef,callback:function(e){console.log(n),n.ef=+e}})),e.add(new UILabel({text:"Start Value:"})),e.add(new UIBlur({value:n.sv,callback:function(e){n.sv=+e}})),e.add(new UILabel({text:"End Value:"})),e.add(new UIBlur({value:n.ev,callback:function(e){n.ev=+e}}))}}),this.left=new UIDragButton({text:"⬗",type:"left",callback:(e,t)=>{n.sf+=(e||-1)*(t||1),lns.ui.update()}}),this.right=new UIDragButton({text:"⬖",type:"right",callback:(e,n)=>{this.tween.ef+=(e||1)*(n||1),lns.ui.update()}}),this.remove=new UIButton({type:"remove",text:"🗑",callback:()=>{t.t.splice(t.t.indexOf(this),1),lns.ui.update()}}),this.append(this.edit),this.append(this.remove),this.append(this.left),this.append(this.right)}get html(){return this.el}}function Capture(){const e=this;this.ready=!0,this.prev={f:void 0,n:0},this.frames=0,this.bg=!0,this.isCapturing=!1,this.isVideo=!1,this.videoLoops=0,this.one=function(){e.frames=1,e.start()},this.multiple=function(){e.frames=+prompt("Capture how many frames?"),e.start()},this.start=function(){lns.anim.onDraw=function(){e.frames>0?(e.capture(),e.frames--,e.isCapturing=!0):e.isCapturing&&(e.isCapturing=!1,lns.anim.isPlaying=!1,lns.anim.onDraw=void 0)}},this.cycle=function(){lns.draw.reset(),lns.anim.frame=lns.anim.endFrame,lns.anim.isPlaying=!0,e.frames=lns.anim.endFrame*Math.max(1,lns.render.lps/lns.anim.fps)+1,e.start()},this.capture=function(){if(lns.files.saveFilesEnabled)lns.canvas.canvas.toBlob(n=>{const t=lns.ui.faces.title.value,s=Cool.padNumber(lns.anim.currentFrame,3);s==e.prev.f?e.prev.n+=1:e.prev.n=0;let a=`${t}-${s}-${e.prev.n}.png`;e.prev.f=s,saveAs(n,a).onwriteend=function(){setTimeout(()=>{window.requestAnimFrame(()=>{lns.render.update("cap")})},100)}});else{const n=e.canvas.toDataURL("image/png").replace("image/png","image/octet-stream");window.location.href=n}},this.startVideo=function(){lns.anim.isPlaying=!1,lns.anim.frame=0,e.videoLoops=+prompt("Number of loops?"),lns.anim.onPlayedState=function(){e.videoLoops>1?e.videoLoops--:e.isVideo&&(e.video(),e.isVideo=!1,lns.anim.isPlaying=!1,lns.anim.onPlayedState=void 0)},e.isVideo=!0,e.bg=!0,e.video(),lns.anim.isPlaying=!0},this.video=function(){e.ready?(e.ready=!1,e.isVideo=!0,e.stream=lns.canvas.canvas.captureStream(),e.rec=new MediaRecorder(e.stream),e.rec.start(),e.rec.addEventListener("dataavailable",e=>{const n=new Blob([e.data],{type:"video/webm"}),t=URL.createObjectURL(n),s=document.createElement("a");document.body.appendChild(s),s.href=t,s.download=lns.ui.faces.title.value+".webm"||"lines.webm",s.click()})):(e.isVideo=!1,e.ready=!0,e.rec.stop())}}function Drawings(){const e=this;this.getLayer=function(e){const n=[];for(let t=0;t<lns.anim.layers.length-1;t++)lns.anim.layers[t].d==e&&n.push(lns.anim.layers[t]);if(0==n.length)return!1;if(1==n.length)return n[0];for(let e=0;e<n.length;e++)if(n[e].isInFrame(lns.anim.currentFrame))return n[e];return n[0]},this.update=function(){e.panel.drawings.clear();for(let n=0;n<lns.anim.drawings.length-1;n++)if(lns.anim.drawings[n]){const t=lns.anim.drawings[n];let s=e.getLayer(n),a=!!s&&s.isInFrame(lns.anim.currentFrame);e.panel.drawings.append(new UIToggle({text:n,isOn:a,callback:function(){let s=e.getLayer(n);if(this.isOn){if(s&&s.isInFrame(lns.anim.currentFrame)){const e=s.removeIndex(lns.anim.currentFrame);"remove"==e?(t.props=s.props,lns.anim.removeLayer(s)):e&&lns.anim.addLayer(s)}}else s?s=s.addIndex(lns.anim.currentFrame):(s=new Layer({...t.props,d:n,f:{s:lns.anim.currentFrame,e:lns.anim.currentFrame}}),delete t.props,lns.anim.addLayer(s));lns.ui.update()}}),n)}},this.clear=function(){e.panel.drawings.clear()}}function Palette(){const e=this;this.palettes={},this.add=function(){lns.draw.reset();const n=e.current=prompt("Name this palette.");n&&(e.palettes[n]={c:lns.draw.layer.c,n:lns.draw.layer.n,r:lns.draw.layer.r,w:lns.draw.layer.w,v:lns.draw.layer.v,lineWidth:lns.canvas.ctx.lineWidth,mouseInterval:lns.draw.mouseInterval,brush:lns.draw.brush,brushSpread:lns.draw.brushSpread,dots:lns.draw.dots,grass:lns.draw.grass},e.addUI(n))},this.addUI=function(n){e.panel.add(new UIButton({text:n,callback:function(){e.load(n)}}))},this.setup=function(n){for(const t in n)"current"!=t&&(e.addUI(t),e.palettes[t]=n[t]);n.current&&e.load(n.current)},this.load=function(n){lns.draw.reset(),e.palettes.current=n;const t=e.palettes[n];for(prop in t)void 0!==lns.ui.faces[prop]?lns.ui.faces[prop].update(t[prop]):console.log(" no face",prop)},this.buildFromAnimation=function(){for(let n=0;n<lns.anim.layers.length;n++){const t="Layer "+n,s=lns.anim.layers[n],a={c:s.c,n:s.n,r:s.r,w:s.w,v:s.v,lineWidth:lns.canvas.ctx.lineWidth,mouseInterval:lns.draw.mouseInterval,brush:0,brushSpread:lns.draw.brushSpread,dots:lns.draw.dots,grass:lns.draw.grass};let i=!1;for(const n in e.palettes){const t=e.palettes[n];let s=!0;for(const e in t)t[e]!=a[e]&&(s=!1);s&&(i=!0)}i||(e.palettes[t]=a,e.addUI(t))}}}function Play(){const e=this;this.setFrame=function(e){+e<=lns.anim.endFrame+1&&+e>=0&&(lns.anim.frame=+e,lns.draw.layer.startFrame=lns.anim.currentFrame,lns.draw.layer.endFrame=lns.anim.currentFrame,lns.ui.update())},this.checkEnd=function(){lns.anim.currentFrame!=lns.anim.endFrame||lns.draw.hasDrawing()||e.next(-1)},this.next=function(e){const n=lns.anim.currentFrame+e;lns.anim.isPlaying&&lns.ui.faces.play.update(),lns.draw.isDrawing=!1,lns.draw.drawing.length>0?(lns.draw.reset(n),lns.anim.frame=n):(e>0&&(lns.anim.currentFrame<lns.anim.state.end||"default"==lns.anim.stateName&&lns.draw.hasDrawing())&&(lns.draw.layer.startFrame=n,lns.draw.layer.endFrame=n,lns.anim.frame=n),e<0&&lns.anim.currentFrame>lns.anim.state.start&&(lns.draw.layer.startFrame=n,lns.draw.layer.endFrame=n,lns.anim.frame=n)),lns.data.saveState(),lns.ui.update()},this.plus=function(){e.setFrame(lns.anim.endFrame),e.next(1)}}function setupAnimateInterface(e){e.toggleRL=function(){this.isOn?lns.canvas.canvas.parentElement.classList.add("right"):lns.canvas.canvas.parentElement.classList.remove("right")},e.cursorToggle=function(){lns.canvas.canvas.classList.contains("no-cursor")?lns.canvas.canvas.classList.remove("no-cursor"):lns.canvas.canvas.classList.add("no-cursor")},e.baseFontSize=11,e.updateScale=function(n){e.baseFontSize=+n,document.body.style.setProperty("--base-font-size",e.baseFontSize)},e.updateFIO=function(n,t){e.faces.title.value=lns.files.fileName.split("/").pop().replace(".json",""),e.faces.fps.value=n.fps,e.faces.width.value=n.w,e.faces.height.value=n.h,lns.anim.layers.forEach(n=>{n&&(e.faces.c.addColor(n.c),e.faces.c.value=n.c)}),n.bg&&(e.faces.bgColor.value=n.bg),e.update()},e.update=function(){e.timeline.update(),e.drawings.update(),e.states.update()}}function States(){const e=this;this.update=function(){for(const n in lns.anim.states){const t=lns.anim.states[n],s=e.panel[n]?e.panel[n]:e.addUI(n,t,!1);for(const e in t)s[e].value!=t[e]&&(s[e].value=t[e])}},this.addUI=function(n,t,s){const a=e.panel.addRow(n);return lns.anim.states[n]=t,lns.ui.faces.stateSelector.addOption(n),e.panel.add(new UILabel({text:n}),a),e.panel.add(new UIBlur({text:"Start",value:t.start,callback:function(e){t.start=+e}}),a,"start"),e.panel.add(new UIBlur({text:"End",value:t.end,callback:function(e){t.end=+e}}),a,"end"),e.panel.add(new UIButton({text:"x",callback:function(){delete lns.anim.states[n],e.panel.removeRow(a),lns.ui.faces.stateSelector.removeOption(n),lns.anim.state="default",lns.ui.faces.stateSelector.value="default"}}),a),a},this.set=function(e){lns.anim.state=e,lns.ui.update()},this.create=function(){const n=prompt("Name?");e.addUI(n,{start:lns.anim.currentFrame,end:lns.anim.currentFrame},!0),lns.anim.state=n,lns.ui.faces.stateSelector.value=n}}function Timeline(){const e=this;this.frameWidth=40,this.autoFit=!1,this.init=function(){e.panel.el.addEventListener("wheel",n=>{n.preventDefault(),e.frameWidth+=(n.deltaY>0?1:-1)*(n.altKey?20:1),e.panel.timeline.setProp("--frame-width",e.frameWidth)}),e.panel.el.addEventListener("mousedown",e=>{e.preventDefault()}),e.panel.el.addEventListener("mouseup",e=>{e.preventDefault()}),e.panel.el.addEventListener("mousemove",e=>{1==e.which&&e.target.classList.contains("frame")&&lns.anim.currentFrame!=+e.target.textContent?(lns.draw.reset(),lns.ui.play.setFrame(+e.target.textContent),lns.ui.update()):e.which}),e.panel.el.oncontextmenu=function(){return!1}},this.fit=function(){const n=lns.anim.endFrame+1,t=lns.ui.timeline.panel.el.clientWidth-11;e.frameWidth=(t-2*n)/n,e.panel.timeline.setProp("--frame-width",e.frameWidth),e.frameWidth<5?(e.panel.timeline.addClass("five"),e.panel.timeline.removeClass("ten")):e.frameWidth<10?(e.panel.timeline.addClass("ten"),e.panel.timeline.removeClass("five")):(e.panel.timeline.removeClass("ten"),e.panel.timeline.removeClass("five"))},this.update=function(){lns.ui.faces.frameDisplay.value=lns.anim.currentFrame,e.panel.timeline.setProp("--num-frames",lns.anim.endFrame+1),e.panel.timeline.setProp("--num-layers",lns.anim.layers.length-1),e.panel.timeline.setProp("--num-tweens",lns.anim.layers.reduce((e,n)=>e+n.t.length,0)),e.panel.timeline.clear();const n=lns.anim.endFrame+1;for(let t=0;t<n;t++){const n=new UIButton({type:"frame",text:""+t,css:{gridColumnStart:1+2*t,gridColumnEnd:3+2*t},class:t==lns.anim.currentFrame?"current":"",callback:function(){lns.draw.reset(),lns.ui.play.setFrame(t),lns.ui.update()}});e.panel.timeline.append(n,"frm-"+t)}let t=2,s=3;for(let n=0;n<lns.anim.layers.length-1;n++){const a=lns.anim.layers[n];a.toggled&&a.toggle();const i=new UILayer({type:"layer",css:{gridRowStart:t,gridRowEnd:s,gridColumnStart:2*a.startFrame+1,gridColumnEnd:2*a.endFrame+3},callback:function(){lns.draw.setProperties(a.props),a.toggle()}},a);t+=2,s+=2,e.panel.timeline.append(i,"layer-"+n);for(let i=0;i<a.t.length;i++){const l=a.t[i],r=new UITween({type:"tween",css:{gridRowStart:t,gridRowEnd:s,gridColumnStart:2*l.sf+1,gridColumnEnd:2*l.ef+3}},l,a);e.panel.timeline.append(r,`tween-${i}-layer-${n}`),t+=2,s+=2}}e.autoFit&&e.fit()},this.toggleLayerView=function(){e.panel.timeline.el.classList.contains("collapse")?e.panel.timeline.removeClass("collapse"):e.panel.timeline.addClass("collapse")},this.split=function(){for(let e=0,n=lns.anim.layers.length-1;e<n;e++){const n=lns.anim.layers[e];if(n.isInFrame(lns.anim.currentFrame)){const e=new Layer(_.cloneDeep(n));e.startFrame=lns.anim.currentFrame+1,n.endFrame=lns.anim.currentFrame,lns.anim.layers.splice(lns.anim.layers.length-1,0,e)}}lns.ui.play.setFrame(lns.anim.currentFrame+1)},this.select=function(){for(let n=0,t=lns.anim.layers.length-1;n<t;n++){const t=lns.anim.layers[n];t.isInFrame(lns.anim.currentFrame)&&(t.toggled||e.panel.timeline["layer-"+n].toggle.handler())}},this.selectAll=function(){const n=lns.anim.layers.filter(e=>e.toggled).length==lns.anim.layers.length-1;for(let t=0,s=lns.anim.layers.length-1;t<s;t++){const s=lns.anim.layers[t];n&&s.toggled?(e.panel.timeline["layer-"+t].toggle.on(),lns.anim.layers[t].toggle()):s.toggled||(lns.anim.layers[t].toggle(),e.panel.timeline["layer-"+t].toggle.off())}}}function appSave(){return{canvasColor:lns.canvas.bgColor,lineWidth:lns.canvas.ctx.lineWidth,c:lns.draw.layer.c,width:lns.canvas.width,height:lns.canvas.height,fps:lns.anim.fps,lps:lns.render.lps,onionSkinIsVisible:lns.render.onionSkinIsVisible,onionSkinNum:lns.render.onionSkinNum,mouseInterval:lns.draw.mouseInterval,palettes:lns.ui.palette.palettes,rl:lns.ui.faces.rl.value,timelineView:lns.ui.faces.timelineView.value,timelineAutoFit:lns.ui.faces.timelineAutoFit.value,canvasScale:lns.ui.faces.canvasScale.value,interfaceScale:lns.ui.faces.interfaceScale.value,quickRefScale:lns.ui.faces.quickRefScale.value,quickRefList:lns.ui.panels.quickRef.list}}function appLoad(e){lns.ui.faces.lps.update(e.lps),lns.ui.faces.onionSkinNum.update(e.onionSkinNum),lns.ui.faces.mouseInterval.update(e.mouseInterval),lns.ui.faces.width.update(e.width),lns.ui.faces.height.update(e.height),lns.ui.faces.bgColor.update(e.canvasColor),lns.ui.faces.timelineView.update(e.timelineView),lns.ui.faces.timelineAutoFit.update(e.timelineAutoFit),lns.ui.faces.canvasScale.update(e.canvasScale),lns.ui.faces.interfaceScale.update(e.interfaceScale),lns.ui.faces.quickRefScale.update(e.quickRefScale),e.quickRefList.forEach(e=>{lns.ui.createUI(e,e.mod,e.sub,lns.ui.panels.quickRef)}),lns.ui.panels.quickRef.list=e.quickRefList,lns.ui.faces.lineWidth.update(e.lineWidth),lns.ui.faces.fps.update(e.fps),lns.ui.faces.c.update(e.c),lns.ui.palette.setup(e.palettes),lns.ui.faces.rl.update(e.rl)}window.addEventListener("load",(function(){window.lns={},lns.canvas=new Canvas("lines",512,512,"#ffffff",!0),lns.render=new Render(30),lns.anim=new LnsAnim(lns.canvas.ctx),lns.draw=new Draw({l:4,n:2,r:1,w:1,v:.1,c:"#000000"}),lns.bgImage=new Background,lns.data=new Data(lns.anim),lns.files=new Files({fit:!1,save:!1,load:!0,reload:!1,bg:!0}),lns.ui=new Interface(lns),lns.ui.capture=new Capture,lns.ui.states=new States,lns.ui.palette=new Palette,lns.ui.drawings=new Drawings,lns.ui.play=new Play,lns.ui.timeline=new Timeline,setupAnimateInterface(lns.ui),lns.ui.settings=new Settings(lns,"lns",appSave),lns.ui.load("./interface/interface.json",(function(){lns.draw.setDefaults(),lns.ui.settings.load(appLoad);const e=location.search.split("=")[1];e&&lns.files.loadFile(e.split(".")[0],lns.ui.updateFIO),lns.ui.update(),lns.render.start(),lns.ui.timeline.init()}))}));
//# sourceMappingURL=src_maps/animate.min.js.map
