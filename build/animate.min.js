!function(){"use strict";const e={updateProperty(e,a){for(let t=0;t<this.layers.length-1;t++)this.layers[t].isToggled&&(this.layers[t][e]=a)},addLayer(e){-1==this.layers.indexOf(e)&&this.layers.splice(L.anim.layers.length-1,0,e)},removeLayer(e){const a=this.layers.indexOf(e);a>=0&&this.layers.splice(a,1)},updateStates(){for(const e in this.states)this.states[e].end>this.endFrame&&(this.states[e].end=this.endFrame)},merge(e,a,t){const n=L.anim.drawings[e],r=L.anim.drawings[a];for("end"!==n.points[n.points.length-1]&&n.add("end");r.length>0;)n.add(r.shift());t||console.warn("No layer"),L.anim.drawings[a]=null,t.drawingEndIndex=n.length},getDrawLayer(){return this.layers[this.layers.length-1]},getCurrentDrawing(){return this.drawings[L.anim.drawings.length-1]},addDrawing(e){this.drawings.splice(L.anim.drawings.length-1,0,e)},newDrawing(){this.drawings.push(new s)},isDrawingInFrame(){return this.layers.some((e=>e.isInFrame(this.currentFrame)&&this.drawings[e.drawingIndex].length>0))},getLayersInFrame(e){return this.layers.filter((a=>a.isInFrame(e)))},shiftStates(e){for(const a in this.states){const t=this.states[a];t.start>=e&&t.start++,t.end>=e&&t.end++}}},a={init(e){this.isToggled=!1,this.isLocked=!1,this.isHighlighted=!1,this.groupNumber=void 0!==e.groupNumber?e.groupNumber:-1},reset(){this.isToggled=!1,this.isLocked=!1,this.isHighlighted=!1,this.highlightColor="#94dfe3"},toggle(){this.isToggled=!this.isToggled},isInFrame(e){return e>=this.startFrame&&e<=this.endFrame&&!this.dontDraw},addTween(e){this.tweens.push(e),e.startFrame<this.startFrame&&(this.startFrame=e.startFrame),e.endFrame>this.endFrame&&(this.endFrame=e.endFrame),"default"==L.anim.stateName&&L.anim.state.end<this.endFrame&&(L.anim.state.end=this.endFrame)},resetTweens(){for(let e=0;e<this.tweens.length;e++){const a=this.tweens[e];a.startFrame<this.startFrame&&(a.startFrame=this.startFrame),a.endFrame>this.endFrame&&(a.endFrame=this.endFrame),a.endFrame<a.startFrame&&(a.endFrame=a.startFrame)}},addIndex(e){if(!this.isInFrame(e))if(this.startFrame-1==e)this.startFrame-=1;else{if(this.endFrame+1!=e)return new l({...this.getCloneProps(),startFrame:e,endFrame:e});this.endFrame+=1}return this},removeIndex(e,a){if(this.startFrame===e&&this.endFrame===e)a();else if(this.startFrame===e)this.startFrame+=1;else{if(this.endFrame!==e){if(e>this.startFrame&&e<this.endFrame){const a=new l(this.getCloneProps());return a.startFrame=e+1,a.endFrame=this.endFrame,a.resetTweens(),this.endFrame=e-1,this.resetTweens(),a}return this}this.endFrame-=1}this.resetTweens()},shiftIndex(e,a){return a||(a=-1),this.startFrame>=e&&(this.startFrame+=a),this.endFrame>=e&&(this.endFrame+=a),this.resetTweens(),this},resetDrawingEndIndex(e){this.drawingEndIndex=e},getSaveProps(){const e={n:this.segmentNum,r:this.jiggleRange,w:this.wiggleRange,v:this.wiggleSpeed,ws:this.wiggleSegments,c:this.color,lw:this.lineWidth,f:[this.startFrame,this.endFrame],d:this.drawingIndex,b:this.breaks,l:this.linesInterval,g:this.groupNumber};return this.x&&(e.x=this.x),this.y&&(e.y=this.y),this.tweens&&(e.t=this.tweens.map((e=>[e.prop,e.startFrame,e.endFrame,e.startValue,e.endValue]))),e},getEditProps(){return{segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,linesInterval:this.linesInterval,breaks:this.breaks,color:this.color,lineWidth:this.lineWidth}},getTweenProps(){return{segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,linesInterval:this.linesInterval,startIndex:this.drawingStartIndex,endIndex:this.drawingEndIndex}},getCloneProps(){return{drawingIndex:this.drawingIndex,segmentNum:this.segmentNum,jiggleRange:this.jiggleRange,wiggleRange:this.wiggleRange,wiggleSpeed:this.wiggleSpeed,wiggleSegments:this.wiggleSegments,breaks:this.breaks,linesInterval:this.linesInterval,x:this.x,y:this.y,color:this.color,lineWidth:this.lineWidth,drawingStartIndex:this.drawingStartIndex,drawingEndIndex:this.drawingEndIndex,startFrame:this.startFrame,endFrame:this.endFrame,groupNumber:this.groupNumber}},setParams(e){const a=this.loadParams(e);for(const e in a)this[e]=a[e]}},t={getData(){return this.points.map((e=>"end"===e?0:"add"===e?1:[...e]))},reset(){this.points=[],this.offsets=[]},popPoint(){this.length>0&&("end"===this.pop()&&this.pop(),this.add("end"))},popLine(){if(this.length>0){this.pop();for(let e=this.length-1;e>=0&&("end"!==this.points[e]&&"add"!==this.points[e]);e--)this.pop()}}},{Renderer:n,Animation:r,Animator:i,Drawing:s,Layer:l,AntiMixin:o,PixelMixin:c}=Lines,{Interface:d,Settings:u}=UI,{UIFile:m,UILabel:p,UIModal:g,UIButton:h,UINumberStep:f,UICollection:w,UIColor:b,UIToggle:k,UIDragButton:v,UISelect:F,UINumber:I,UIText:S,UIElement:C,UIRow:P}=UI.Elements,L={};Object.assign(l.prototype,a),Object.assign(r.prototype,e),Object.assign(s.prototype,t);const U={};location.search.substr(1).split("&").map((e=>{let[a,t]=e.split("=");U[a]=t})),"pixel"===U.render&&Object.assign(Lines.prototype,c),L.renderer=n({width:512,height:512,bgColor:"#ffffff",retina:!0,dps:30,lineWidth:1}),L.anim=new r(L.renderer.ctx,30,!0,!0),L.playback=function(e,a){const{canvas:t,ctx:n}=e.renderer;let r,i,s,l=0,o=!1,c=a.showStats||!1;function d(e){if(void 0!==e&&(c=e),!r&&c){r=new Stats,r.dom.style.position="absolute",r.dom.style.top="-48px",r.dom.style.right="0",r.dom.style.left="auto",i.el.appendChild(r.dom);const e=r.dom.getBoundingClientRect();e.y<0&&(r.dom.style.top=`-${48+Math.ceil(e.y)}px`)}r?(r.dom.style.display=c?"block":"none",i.setProp("overflow","visible")):i.setProp("overflow","hidden")}function u(){e.anim.frame=0,e.anim.isPlaying=!1,e.ui.update()}function m(){if(e.anim.isPlaying){const a=e.anim.getDrawLayer();a.startFrame=e.anim.currentFrame,a.endFrame=e.anim.currentFrame}else g(),e.draw.reset();e.anim.isPlaying=!e.anim.isPlaying,e.timeline.update()}function p(a){if(+a<=e.anim.endFrame+1&&+a>=0){e.anim.frame!==+a&&e.draw.reset(),e.anim.frame=+a;const t=e.anim.getDrawLayer();t.startFrame=e.anim.currentFrame,t.endFrame=e.anim.currentFrame,e.ui.update()}else s.update(e.anim.currentFrame,!0)}function g(){e.anim.currentFrame!==e.anim.endFrame||e.anim.isDrawingInFrame()||h(-1)}function h(a){const t=e.anim.currentFrame+a;if(e.anim.isPlaying&&e.ui.faces.play.update(),e.events.stop(),e.anim.getCurrentDrawing().length>0)e.draw.reset(t),e.anim.frame=t;else{const n=e.anim.getDrawLayer();a>0&&(e.anim.currentFrame<e.anim.state.end||"default"==e.anim.stateName&&e.anim.isDrawingInFrame())&&(n.startFrame=t,n.endFrame=t,e.anim.frame=t),a<0&&e.anim.currentFrame>e.anim.state.start&&(n.startFrame=t,n.endFrame=t,e.anim.frame=t)}e.data.saveState(),e.ui.update()}function f(){p(e.anim.endFrame),h(1)}function w(){e.anim.isPlaying&&e.timeline.update();const{width:a,height:t,bgColor:r}=e.renderer.getProps();if(e.capture.isActive())e.capture.withBackground()&&(n.fillStyle=r,n.fillRect(0,0,a,t));else{if(e.bg.display(a,t),l>0&&o){const a=e.anim.currentFrame;for(let t=1;t<=l;t++){const n=a-t;n>=0&&(e.anim.currentFrame=n,e.anim.overrideProperty("color",`rgba(105,150,255,${1.5-t/l})`),e.anim.draw())}e.anim.cancelOverride(),e.anim.currentFrame=a}if(e.anim.layers.some((e=>e.isHighlighted))){e.anim.overrideProperty("color","#94dfe3"),e.anim.overrideProperty("lineWidth",5);for(let a=0,t=e.anim.layers.length-1;a<t;a++){const t=e.anim.layers[a];t.isInFrame(e.anim.currentFrame)&&t.isHighlighted||(t.dontDraw=!0)}e.anim.draw(0,0,!0),e.anim.cancelOverride(),e.anim.layers.filter((e=>e.dontDraw)).forEach((e=>{e.dontDraw=!1}))}e.eraser.display()}if(e.sequencer.isActive()){const a=e.sequencer.getFrame();e.anim.frame=a,s.value=a,e.sequencer.isPlaying()&&e.timeline.update()}else e.anim.update();e.anim.draw()}function b(){i=e.ui.getPanel("play",{label:"Play Back"}),e.ui.addCallbacks([{callback:p,key:"0",text:"0",args:[0]},{callback:h,key:"w",text:"◀",args:[-1]},{callback:m,type:"UIToggle",value:!1,text:"Play",onText:"❚❚",offText:"▶",key:"space"},{callback:h,key:"e",text:"▶",args:[1]},{callback:f,key:"+",text:"+"}],"play"),s=e.ui.addUI({type:"UINumberStep",callback:p,face:"frameDisplay",key:"f",value:0,prompt:"Set Frame"},"play"),e.ui.addCallbacks([{callback:w,text:"↻",key:"u"}]),e.ui.addProps({fps:{type:"UINumberStep",key:";",value:e.anim.fps,callback:a=>{!function(a){e.anim.fps=a,e.ui.faces.fps.value=e.anim.fps,e.ui.faces.dpf.value=e.anim.dpf}(a)},min:1,prompt:"Set Frames/Second"},dpf:{type:"UINumberStep",value:e.anim.dpf,callback:a=>{!function(a){e.anim.dpf=a,e.ui.faces.fps.value=e.anim.fps}(a)},min:1,prompt:"Set Draws/Frame"},dps:{type:"UINumberStep",key:"'",value:e.renderer.getProps().dps,callback:a=>{!function(a){e.renderer.setDPS(a),e.anim.drawsPerFrame=Math.max(1,Math.round(e.renderer.getProps().dps/e.anim.fps)),e.ui.faces.fps.value=e.anim.fps,e.ui.faces.dpf.value=e.anim.dpf}(a)},prompt:"Set Draw/Second"},onionSkinIsVisible:{type:"UIToggleCheck",value:o,label:"Onion Skin",key:"n",callback:e=>{o=e}},onionSkinNum:{type:"UINumberStep",value:l,label:"Frames",key:"shift-n",prompt:"Onion Skin Frames",callback:e=>{l=e}},viewStats:{type:"UIToggleCheck",value:a.showStats,callback:e=>{d(e)}}})}return e.renderer.addCallback(w),e.renderer.addCallback((function(){c&&r.begin()}),"pre"),e.renderer.addCallback((function(){c&&r.end()}),"post"),{connect:b,reset:u,update:w,toggleStats:d,setFrame:p,checkEnd:g,next:h,getDPS:()=>e.renderer.getProps().dps}}(L,{stats:!1}),L.canvas=function(e,a){const{canvas:t,ctx:n}=e.renderer;let{width:r,height:i,scale:s,lineWidth:l,bgColor:o}=e.renderer.getProps(),c=1;function d(e){o=e,t.style.backgroundColor=o}function u(){e.draw.reset();let a=0,t={x:1e4,y:1e4},n={x:0,y:0};for(let r=0;r<e.anim.layers.length;r++){const i=e.anim.layers[r],s=e.anim.drawings[i.drawingIndex];for(let e=0;e<s.length;e++){const r=s.points[e];"end"!==r&&"add"!==r&&(a=Math.max(a,4*i.jiggleRange),t.x=Math.min(t.x,r[0]+i.x),t.y=Math.min(t.y,r[1]+i.y),n.x=Math.max(n.x,r[0]+i.x),n.y=Math.max(n.y,r[1]+i.y))}}e.ui.faces.width.update(Math.round(n.x-t.x+2*a)),e.ui.faces.height.update(Math.round(n.y-t.y+2*a));for(let n=0;n<e.anim.layers.length-1;n++)e.anim.layers[n].x-=t.x-a>0?t.x-a:0,e.anim.layers[n].y-=t.y-a>0?t.y-a:0}function m(){e.ui.addCallback({callback:u,text:"Fit Canvas",key:"shift-f"},"canvas"),e.ui.addProps({width:{value:r,callback:a=>{r=a,e.renderer.setWidth(a)}},height:{value:i,callback:a=>{i=a,e.renderer.setHeight(a)}},canvasScale:{type:"UINumberStep",value:s,range:[.5,10],step:.05,callback:a=>{s=a,e.renderer.setScale(a)}},bgColor:{type:"UIColor",value:o,callback:a=>{d(a),e.renderer.setBackgroundColor(a)}},hideCursor:{type:"UIToggleCheck",key:"alt-m",callback:e=>{!function(e){e?t.classList.add("no-cursor"):t.classList.remove("no-cursor")}(e)}}},"canvas"),e.ui.addCallback({type:"UIToggle",callback:a=>{const{container:t}=e.ui.getLayout();if(a){c=s;const a=window.innerWidth-32,n=window.innerHeight-32;if(r/i<a/n){let a=n>i?n/i:i/n;e.renderer.setScale(a),s=a}else{let t=a>r?a/r:r/a;e.renderer.setScale(t),s=t}t.addClass("full-size")}else e.ui.getLayout().container.removeClass("full-size"),e.renderer.setScale(c),s=c},text:"Full Size",key:"`"}),e.ui.addCallback({type:"UIToggle",callback:a=>{a?(c=s,e.renderer.setScale(1),s=1):(e.renderer.setScale(c),s=c)},text:"x1",key:"1"})}return d(o),{connect:m,canvas:t,ctx:n,fitCanvasToDrawing:u,setBackgroundColor:d,getScale:()=>e.renderer.getProps().scale,getWidth:()=>e.renderer.getProps().width,getHeight:()=>e.renderer.getProps().height,getLineWidth:()=>e.renderer.getProps().lineWidth,getBGColor:()=>o}}(L),L.draw=function(e,a){function t(a,t){for(const n in a){const r=e.anim.getDrawLayer();void 0!==r[n]&&(r[n]=a[n],e.ui.faces[n]&&e.ui.faces[n].update(a[n],t))}}function n(a,t){e.anim.updateProperty(a,t),e.anim.getDrawLayer()[a]=t}function r(){t(a)}function i(a){let t=e.anim.getCurrentDrawing();const n=e.anim.getDrawLayer();let r=!t;t&&t.length>0&&(r=!0),r&&(e.anim.newDrawing(),e.ui.faces.color.addColor(n.color),e.anim.layers.push(function(a){return new l({linesInterval:+e.ui.faces.linesInterval.value,segmentNum:+e.ui.faces.segmentNum.value,jiggleRange:+e.ui.faces.jiggleRange.value,wiggleRange:+e.ui.faces.wiggleRange.value,wiggleSpeed:+e.ui.faces.wiggleSpeed.value,color:e.ui.faces.color.value,lineWidth:e.ui.faces.lineWidth.value,drawingIndex:e.anim.drawings.length-1,startFrame:+a||e.anim.currentFrame})}(a)),e.data.saveState()),e.ui.update()}function o(){let a=0;for(let t=0;t<e.anim.layers.length-1;t++){const n=e.anim.layers[t];n.endFrame>a&&(a=n.endFrame)}const t=e.anim.getDrawLayer();t.endFrame>a&&(t.endFrame=a)}function c(){const a=new g({title:"Select Color",app:e,position:e.mousePosition});a.add(new b({callback(a){n("color",a),e.ui.faces.color.el.value=a}})),e.ui.faces.color.colors.forEach((t=>{a.add(new h({text:t,css:{background:t},value:t,callback(){n("color",t),e.ui.faces.color.el.value=t,a.clear()}}))}))}function d(){const a="#"+Math.floor(16777215*Math.random()).toString(16);n("color",a),e.ui.faces.color.el.value=a}function u(){let a=parseInt(e.anim.getDrawLayer().color.substr(1),16);a+=Cool.randomInt(-500,500),a=Math.max(0,a);const t="#"+a.toString(16);n("color",t),e.ui.faces.color.el.value=t}function m(){const t=e.ui.getPanel("draw",{label:"Lines"});e.ui.addUI({type:"UIToggleCheck",label:"Suspend",value:!1,key:"/",callback:a=>{e.anim.suspendUpdate=a}}),t.addRow(),e.ui.addCallbacks([{callback:i,key:"r",text:"Save Lines"},{callback:r,text:"Reset Defaults"}],"draw"),e.ui.addProps({linesInterval:{type:"UINumberStep",value:a.linesInterval,range:[1,10],callback:e=>{n("linesInterval",e)}},segmentNum:{type:"UINumberStep",value:a.segmentNum,range:[1,10],callback:e=>{n("segmentNum",e)}},jiggleRange:{type:"UINumberStep",value:a.jiggleRange,range:[0,10],callback:e=>{n("jiggleRange",e)}},wiggleRange:{type:"UINumberStep",value:a.wiggleRange,range:[0,16],callback:e=>{n("wiggleRange",e)}},wiggleSpeed:{type:"UINumberStep",value:a.wiggleSpeed,range:[0,8],step:.005,callback:e=>{n("wiggleSpeed",e)}},wiggleSegments:{type:"UIToggleCheck",value:a.wiggleSegments,callback:e=>{n("wiggleSegments",e)}},breaks:{type:"UIToggleCheck",value:a.breaks,callback:e=>{n("breaks",e)}},color:{type:"UIColor",value:a.color,callback:e=>{n("color",e)}},lineWidth:{type:"UINumberStep",type:"UINumberStep",value:a.lineWidth,callback:e=>{n("lineWidth",e)}}},"draw"),e.ui.addCallbacks([{callback:c,key:"g",text:"Quick Color",row:!0},{callback:d,key:"shift-g",text:"Random Color"},{callback:u,key:"alt-g",text:"Color Variation"}],"draw")}return e.anim.drawings.push(new s),e.anim.layers.push(new l({...a,drawingIndex:Math.max(e.anim.drawings.length-1,0),startFrame:e.anim.currentFrame})),{connect:m,reset:i,setDefaults:r,setProperties:t,cutEnd:o}}(L,{linesInterval:5,segmentNum:2,jiggleRange:1,wiggleRange:1,wiggleSpeed:.1,color:"#000000",lineWidth:1}),L.brush=function(e){let a,t=!1,n=!1,r=0,i=0,s=0,l=0,o=1,c=0,d=0,u=1,m=3,p=!1,g=10;return{connect:function(){e.ui.addProps({brushIsActive:{type:"UIToggleCheck",value:t,label:"Use Brush",key:"b",callback:e=>{t=e}},isGrass:{type:"UIToggleCheck",value:n,label:"Is Grass",key:"ctrl-b",callback:e=>{n=e}},brushSpreadXLeft:{row:!0,type:"UINumberRange",range:[0,10],callback:e=>{r=e}},brushSpreadXRight:{type:"UINumberRange",range:[0,10],callback:e=>{i=e}},brushSpreadYDown:{type:"UINumberRange",range:[0,10],callback:e=>{s=e}},brushSpreadYUp:{type:"UINumberRange",range:[0,10],callback:e=>{l=e}},brushRandomX:{type:"UINumberRange",range:[0,1],step:.01,callback:e=>{c=e}},brushRandomY:{type:"UINumberRange",range:[0,1],step:.01,callback:e=>{d=e}},brushSegmentsMin:{type:"UINumberStep",range:[1,5],value:1,callback:e=>{u=e}},brushSegmentsMax:{type:"UINumberStep",range:[2,5],value:3,callback:e=>{m=e}},brushSpreadMultiplier:{type:"UINumberStep",range:[1,32],value:1,callback:e=>{o=e}},brushFillArea:{type:"UINumberRange",range:[10,50],value:10,callback:e=>{g=e}}},"brush")},add:function(a,t){const p=Cool.randomInt(u,m),g=[Cool.random(-r,i)*o,Cool.random(-s,l)*o];for(let u=1;u<=p;u++){let m=(n?Cool.random(-r,i)*o*(1-Cool.random(c)):g[0])*(n?u/p:1),h=(n?Cool.random(-s,l)*o*(1-Cool.random(d)):g[1])*(n?u/p:1),f=[t[0]+Math.round(m),t[1]-Math.round(h)];f[0]>0&&f[0]<e.canvas.getWidth()&&f[1]>0&&f[1]<e.canvas.getHeight()&&a.add(f)}a.add("end")},startFill:function(e){a=e,p=!0},endFill:function(e,t){const n=Math.abs(a.x-t.x),r=Math.abs(a.y-t.y),i=n/r,s=n/(i*g/2),l=r/(1/i*g/2);let[o,c]=a.x<t.x?[a.x,t.x]:[x,a.x],[d,u]=a.y<t.y?[a.y,t.y]:[y,a.y];for(let a=o;a<c;a+=s)for(let t=d;t<u;t+=l){const n=Math.round(a)+Cool.randomInt(-s/2,s/2),r=Math.round(t)+Cool.randomInt(-l/2,l/2),i=Cool.randomInt(1,3);for(let a=0;a<i;a++)e.add(new Cool.Vector(n+Cool.randomInt(-1,1),r+Cool.randomInt(-1,1)));e.add("end")}p=!1},isActive:()=>t,fillActive:()=>p}}(L),L.eraser=function(e){let a,t=!1,n=10,r="points";return{connect:function(){e.ui.addProps({eraseMethod:{type:"UISelect",options:["points","lines"],value:r,callback:e=>{r=e}},eraseDistance:{type:"UINumberStep",value:n,callback:e=>{n=e}}},"erase")},erase:function(t){a=new Cool.Vector(t);for(let t=e.anim.layers.length-1;t>=0;t--){const i=e.anim.layers[t];if(i.isLocked)continue;if(!i.isInFrame(e.anim.currentFrame))continue;const s=e.anim.drawings[i.drawingIndex];for(let e=s.points.length-1;e>=0;e--){if("end"===s.points[e])continue;if("add"===s.points[e])continue;const t=new Cool.Vector(s.points[e]);if(a.distance(t)<n)if("lines"===r){let a=e,t=e;for(;"end"!==s.points[a]&&a>0;)a--;for(;"end"!==s.points[t]&&t<s.length;)t++;s.points.splice(a,t-a)}else"points"===r&&(s.points[e]="end")}if("points"===r)for(let e=s.points.length-1;e>=0;e--)"end"===s.points[e]&&"end"===s.points[e-1]&&s.points.splice(e,1),"end"===s.points[e+1]&&"end"===s.points[e-1]&&s.points.splice(e,1),"end"===s.points[e]&&0===e&&s.points.splice(e,1);0===s.points.length&&t!==e.anim.layers.length-1?i.removeIndex(e.anim.currentFrame,(function(){e.anim.layers.splice(t,1),e.draw.reset()})):s.update(i.drawProps)}},display:function(){t&&a&&(e.renderer.ctx.fillStyle="rgba(150, 50, 200, 0.25)",e.renderer.ctx.beginPath(),e.renderer.ctx.arc(a.x,a.y,n,0,2*Math.PI),e.renderer.ctx.fill())},start(e){t=!0,a=e},end(){t=!1},isActive:()=>t}}(L),L.events=function(e){let a=performance.now(),t=30,n=2,r=!1,i=new Cool.Vector;function s(a){a.toElement!==e.renderer.canvas&&r&&d(a)}function l(a,t){const n=e.renderer.getProps().scale;return[Math.round(a/n),Math.round(t/n)]}function o(s){if(performance.now()>t+a){a=performance.now(),e.mousePosition.x=Math.round(s.pageX),e.mousePosition.y=Math.round(s.pageY);const t=e.anim.getCurrentDrawing(),o=l(s.offsetX,s.offsetY);r?e.brush.isActive()?e.brush.add(t,o):e.mousePosition.distance(i)>n&&(t.add(o),i=e.mousePosition.clone()):e.eraser.isActive()&&e.eraser.erase(o)}}function c(t){t.preventDefault();const n=e.anim.getCurrentDrawing(),s=l(t.offsetX,t.offsetY);t.which>=2&&e.eraser.start(),1!=t.which||e.anim.isPlaying||t.altKey?t.altKey&&e.brush.startFill(s):t.ctrlKey?e.eraser.start(s):(r=!0,a=performance.now(),e.brush.isActive()?e.brush.add(n,s):(n.add(s),i=e.mousePosition.clone()))}function d(a){r=!1;const t=e.anim.getCurrentDrawing();let n=t.get(-2)[0];"end"!==n&&"add"!==n&&t.length>1?t.add(a.shiftKey?"add":"end"):t.popPoint()}function u(a){if(e.eraser.end(),e.brush.fillActive()){const t=e.anim.getCurrentDrawing(),n=l(a.offsetX,a.offsetY);e.brush.endFill(t,n)}else 1===a.which&&d(a);i=void 0}if(e.mousePosition=new Cool.Vector,window.navigator.platform.includes("iPad")){const p={which:1},g=window.devicePixelRatio;function h(e,a){if(e.preventDefault(),e.touches[0]){const t=e.target.getBoundingClientRect();p.offsetX=e.targetTouches[0].pageX-t.left/g,p.offsetY=e.targetTouches[0].pageY-t.top/g,p.which=1,a(p)}}e.renderer.canvas.addEventListener("touchstart",(e=>{h(e,c)})),e.renderer.canvas.addEventListener("touchmove",(e=>{h(e,o)})),e.renderer.canvas.addEventListener("touchend",(e=>{u(p)}))}else window.PointerEvent?(e.renderer.canvas.addEventListener("pointermove",o),e.renderer.canvas.addEventListener("pointerdown",c),e.renderer.canvas.addEventListener("pointerup",u)):(e.renderer.canvas.addEventListener("mousemove",o),e.renderer.canvas.addEventListener("mousedown",c),e.renderer.canvas.addEventListener("mouseup",u));function m(){e.ui.addProps({mouseInterval:{type:"UINumberRange",key:"m",value:t,callback:e=>{t=e},range:[0,100]},distanceThreshold:{type:"UINumberStep",key:"shift-m",range:[0,30],value:n,callback:e=>{n=e}}},"mouse")}return document.addEventListener("mousemove",s),{connect:m,isDrawing:()=>r,stop(){r=!1}}}(L),L.bg=function(e){const{canvas:a,ctx:t}=e.renderer;let n=new Image,r=!0,i=0,s=0,l=0,o=0,c=1,d=0,u=!1,m=!1,p=1,g=1,h="#808080",f=2,w=!0;return{connect:function(){e.ui.addProps({bgImage:{type:"UIText",css:{"flex-basis":"100%"},callback:e=>{var a;"URL"!==(a=e)&&(n.src=a,n.onload=function(){l=n.width,o=n.height})}},showBG:{value:r,key:"alt-b",onText:"Hide",offText:"Show",callback:e=>{r=e}},bgX:{row:!0,type:"UINumberRange",value:i,label:"X",range:[-1024,1024],callback:e=>{i=e}},bgY:{row:!0,type:"UINumberRange",value:s,label:"Y",range:[-1024,1024],callback:e=>{s=e}},bgSize:{row:!0,type:"UINumberRange",value:c,label:"Size",range:[.1,2],step:.1,callback:e=>{c=e}},bgRotation:{row:!0,type:"UINumberRange",value:d,label:"Rotation",range:[0,360],callback:e=>{d=e}}},"background"),e.ui.addProps({dotGrid:{type:"UIToggleCheck",value:u,callback:e=>{u=e}},dotEdges:{type:"UIToggleCheck",value:w,callback:e=>{w=e}},lineGrid:{type:"UIToggleCheck",value:m,callback:e=>{m=e}},gridColumns:{type:"UINumberStep",value:p,callback:e=>{p=e}},gridRows:{type:"UINumberStep",value:g,callback:e=>{g=e}},dotSize:{type:"UINumberStep",value:f,callback:e=>{f=e}},gridColor:{type:"UIColor",value:h,callback:e=>{h=e}}},"grid")},display:function(a,l){if(n.src&&r&&(d>0&&(t.save(),t.rotate(d*Math.PI/180)),t.drawImage(n,i,s,c*a,l*c),d>0&&t.restore()),u||m){let n=a/p,r=l/g;for(let a=0;a<=p;a++)for(let i=0;i<=g;i++){let s=a*n,l=i*r;const o=e.canvas.getLineWidth();if(t.lineWidth=1,t.strokeStyle=h,t.fillStyle=h,m&&i>0&&i<g&&(t.beginPath(),t.moveTo(s,l),t.lineTo(s+n,l),t.stroke()),m&&a>0&&a<p&&(t.beginPath(),t.moveTo(s,l),t.lineTo(s,l+r),t.stroke()),u){let e=!0;w||0!==a&&a!==p||(e=!1),w||0!==i&&i!==g||(e=!1),e&&(t.beginPath(),t.arc(s,l,f,0,2*Math.PI),t.fill())}t.lineWidth=o}}}}}(L),L.data=function(e){let a=[],t=[],n=[],r={current:{drawings:void 0,layers:void 0},prev:{drawings:void 0,layers:void 0}};function i(){r.current.drawings?(r.prev.drawings=_.cloneDeep(r.current.drawings),r.prev.layers=_.cloneDeep(r.current.layers)):(r.prev.drawings=_.cloneDeep(e.anim.drawings),r.prev.layers=_.cloneDeep(e.anim.layers)),r.current.drawings=_.cloneDeep(e.anim.drawings),r.current.layers=_.cloneDeep(e.anim.layers)}function s(){r.prev.drawings?(e.anim.drawings=_.cloneDeep(r.prev.drawings),e.anim.layers=_.cloneDeep(r.prev.layers),r.current.drawings=_.cloneDeep(r.prev.drawings),r.current.layers=_.cloneDeep(r.prev.layers),r.prev.drawings=void 0,r.prev.layers=void 0):console.log("%c Can't undo ","color:lightblue;background:gray;"),e.drawings.clear(),e.ui.update()}function l(){e.draw.reset(),a=[];for(let t=0;t<e.anim.layers.length-1;t++)e.anim.layers[t].isInFrame(e.anim.currentFrame)&&a.push(e.anim.layers[t])}function o(){i(),0==n.length&&n.push(e.anim.currentFrame);for(let t=0;t<n.length;t++)for(let r=0;r<a.length;r++){const i=a[r].addIndex(n[t]);i&&e.anim.addLayer(i)}n=[],e.draw.reset(),e.ui.update()}function c(){i(),a=[];let t=+prompt("Number of copies: ",1);if(l(),t)for(let a=0;a<t;a++)e.playback.next(1),o();e.ui.update()}function d(){i();const a=+prompt("Start frame:"),n=+prompt("end frame:");t=[];for(let r=a;r<=n;r++){t[r]=[];for(let a=0;a<e.anim.layers.length-1;a++)e.anim.layers[a].isInFrame(r)&&t[r].push(e.anim.layers[a])}}function u(){i();for(let a=0;a<t.length;a++){const n=t[a];if(n)for(let a=0;a<n.length;a++){const t=n[a].addIndex(e.anim.currentFrame);t&&e.anim.addLayer(t)}e.playback.next(1)}e.draw.reset(),e.ui.update()}function m(){i(),e.anim.getCurrentDrawing().reset()}function p(){i();for(let a=e.anim.layers.length-2;a>=0;a--)if(e.anim.layers[a].isInFrame(e.anim.currentFrame)&&!(e.anim.layers[a].groupNumber>=0)){e.anim.layers[a].removeIndex(e.anim.currentFrame,(()=>{e.anim.layers.splice(a,1)}));break}e.ui.update()}function g(){i();for(let a=0;a<e.anim.layers.length-1;a++)if(e.anim.layers[a].isInFrame(e.anim.currentFrame)&&!(e.anim.layers[a].groupNumber>=0)){e.anim.layers[a].removeIndex(e.anim.currentFrame,(function(){e.anim.layers.splice(a,1)}));break}e.ui.update()}function h(){i(),m(),function(){i();for(let a=e.anim.layers.length-2;a>=0;a--)e.anim.layers[a].isInFrame(e.anim.currentFrame)&&e.anim.layers[a].removeIndex(e.anim.currentFrame,(()=>{e.anim.layers.splice(a,1)}));e.ui.update()}()}function f(a){i();void 0!==a||e.anim.currentFrame;const t=e.anim.currentFrame;for(let a=e.anim.layers.length-2;a>=0;a--){const n=e.anim.layers[a];n.endFrame<t||(n.startFrame===t&&n.endFrame===t?e.anim.removeLayer(n):n.endFrame>t&&n.startFrame>t?(n.startFrame-=1,n.endFrame-=1):n.endFrame>t&&(n.endFrame-=1),n.resetTweens())}e.anim.updateStates(),e.ui.update()}function w(){i();const a=+prompt("Start frame:"),t=+prompt("End frame:");if(t>0){for(let e=t;e>=a;e--)f(e);e.draw.cutEnd(),e.playback.setFrame(0)}}function b(){i(),e.anim.getCurrentDrawing().popPoint()}function y(){i(),e.anim.getCurrentDrawing().popLine()}function k(a){e.draw.reset(),i();for(let t=0,n=e.anim.layers.length-1;t<n;t++)e.anim.layers[t].shiftIndex(e.anim.currentFrame+a,1),e.anim.addLayer(e.anim.layers[t].removeIndex(e.anim.currentFrame+a));e.anim.shiftStates(e.anim.currentFrame+a),e.playback.next(a),e.ui.update()}function v(a){e.draw.reset(),i();const t=+prompt("Number of frames?");if(t){for(let n=0;n<e.anim.layers.length-1;n++){const r=e.anim.layers[n];if(r.isInFrame(e.anim.currentFrame))switch(r.endFrame=r.startFrame+t,e.anim.state.end<r.endFrame&&(e.anim.state.end=r.endFrame),a){case"Draw":r.addTween({prop:"endIndex",startFrame:r.startFrame,endFrame:r.endFrame,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length});break;case"Reverse":r.addTween({prop:"startIndex",startFrame:r.startFrame,endFrame:r.endFrame,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length});break;case"DrawReverse":const a=Math.floor(t/2);r.addTween({prop:"endIndex",startFrame:r.startFrame,endFrame:r.startFrame+a,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length}),r.addTween({prop:"startIndex",startFrame:r.startFrame+a,endFrame:r.endFrame,startValue:0,endValue:e.anim.drawings[r.drawingIndex].length})}}e.ui.update()}}function F(a){i();let t=e.anim.layers.filter((e=>e.isToggled));if(0==t.length&&(t=e.anim.layers.filter((a=>a.isInFrame(e.anim.currentFrame)))),e.draw.reset(),t){if(i(),a||(a=new Cool.Vector(+prompt("x"),+prompt("y"))),a)for(let e=0;e<t.length;e++)t[e].x+=a.x,t[e].y+=a.y}else console.log("%c No layers in frame ","color:yellow; background:black;")}function x(){i();for(let a=0;a<e.anim.layers.length;a++){const t=e.anim.layers[a],n=e.anim.drawings[t.drawingIndex];for(let e=0;e<n.length;e++)"end"!==n.points[e]&&"add"!==n.points[e]&&(n.points[e][0]+=t.x,n.points[e][1]+=t.y);t.x=0,t.y=0}}function I(){i();const a=[];for(let t=0;t<e.anim.drawings.length;t++){e.anim.drawings[t]&&a.push(t)}for(let t=0;t<e.anim.layers.length;t++){const n=e.anim.layers[t],r=a.indexOf(n.drawingIndex);n.drawingIndex=r}for(let a=e.anim.drawings.length;a>=0;a--)null==e.anim.drawings[a]&&e.anim.drawings.splice(a,1)}return{connect:function(){e.ui.getPanel("copy",{label:"Copy / Paste"}),e.ui.addCallbacks([{callback:l,key:"c",text:"Copy"},{callback:c,key:"shift-c",text:"Multi Copy"},{callback:o,key:"v",text:"Paste"},{callback:d,key:"alt-c",text:"Copy Range"},{callback:u,key:"alt-v",text:"Paste Range"}]),e.ui.getPanel("cut",{label:"Cut"}),e.ui.addCallbacks([{callback:m,key:"x",text:"Clear Lines"},{callback:y,key:"z",text:"Cut Last Line"},{callback:b,key:"shift-z",text:"Cut Last Segment"},{callback:f,key:"d",text:"Delete Frame"},{callback:w,key:"shift-d",text:"Delete Frame Range"},{callback:p,key:"ctrl-x",text:"Cut Top Layer"},{callback:g,key:"alt-x",text:"Cut Bottom Layer"},{callback:h,key:"shift-x",text:"Clear Frame"}]),e.ui.getPanel("data"),e.ui.addCallbacks([{callback:s,key:"ctrl-z",text:"Undo"},{callback:F,key:"shift-o",text:"Offset"},{callback:k,key:"i",text:"Insert Before",args:[0]},{callback:k,key:"shift-i",text:"Insert After",args:[1]},{callback:x,text:"Apply Offset"},{callback:I,text:"Prune Drawings"}]),e.ui.getPanel("animate"),e.ui.addCallbacks([{callback:v,key:"a",text:"Draw",args:["Draw"]},{callback:v,key:"shift-a",text:"Reverse",args:["Reverse"]},{callback:v,key:"ctrl-a",text:"Draw + Reverse",args:["DrawReverse"]}])},saveState:i}}(L),L.fio=function(e,a){let t,n,i=a.save||!1,o=!1;function c(t){const r={title:n.value||prompt("Name this file:"),v:"2.5",w:+e.canvas.getWidth(),h:+e.canvas.getHeight(),fps:+e.anim.fps,mc:[...new Set(e.anim.layers.map((e=>e.color)))].length>1,mw:[...new Set(e.anim.layers.map((e=>e.lineWidth)))].length>1};if(a.bg&&(r.bg=e.canvas.getBGColor()),n.value||(n.value=r.title),e.draw.reset(),e.playback.checkEnd(),r.d=e.anim.drawings.map((e=>e?e.getData():null)),r.d.pop(),0===r.d.length)return;if(r.l=t?e.anim.layers.filter((a=>a.isInFrame(e.anim.currentFrame))).map((e=>({...e.getSaveProps(),f:[0,0]}))):e.anim.layers.map((e=>e.getSaveProps())),r.l.pop(),0===r.l.length)return;const i=e.timeline.getGroups();i.length>0&&(r.g=[...i]);const s=Object.keys(e.anim.states).filter((e=>"default"!==e));s.length>0&&(r.s={},s.forEach((a=>{r.s[a]=[e.anim.states[a].start,e.anim.states[a].end]})));const l=e.sequencer.getData();return l&&(r.q=l),r}function d(){const e=n.value;e||alert("No title"),localStorage.removeItem("lines-"+e),localStorage.removeItem("lines-title")}function u(){const e=c(!1);if(!e)return alert("No data.");try{localStorage.setItem("lines-"+e.title,JSON.stringify(e)),localStorage.setItem("lines-title",e.title)}catch(e){"QuotaExceededError"===e.name?alert("Local storage full"):alert(e.name)}}function m(a){let t=a||n.value;if(t||(t=localStorage.getItem("lines-title")),t||prompt("Search title"),!t)return alert("No title.");const r=localStorage.getItem("lines-"+t);if(!r)return alert("No data, Locals: "+Object.keys(localStorage).filter((e=>e.includes("lines"))));const i=JSON.parse(r);e.fio.loadJSON(i)}function p(){const a=new g({app:e,title:"Local Saves",position:{x:200,y:120}});Object.keys(localStorage).filter((e=>e.includes("lines"))).forEach((e=>{a.add(new h({text:e.replace("lines-",""),callback:()=>{m(e.replace("lines-","")),a.clear()}}))}))}function f(t,n){a.fit&&confirm("Fit canvas?")&&e.canvas.fitCanvasToDrawing();const r=c(t);if(!r)return alert("No data.");let i=r.l.map((e=>e.d));if(i=i.filter(((e,a)=>i.indexOf(e)===a)),r.d=r.d.map(((e,a)=>i.includes(a)?e:null)),r.d.includes(null)){const e=r.d.map(((e,a)=>{if(r.d[a])return a})).filter((e=>void 0!==e));r.l.forEach((a=>{a.d=e.indexOf(a.d)})),r.d=r.d.filter((e=>null!==e))}const s=JSON.stringify(r),l=new Blob([s],{type:"application/x-download;charset=utf-8"});saveAs(l,`${r.title}${t?"-"+e.anim.frame:""}.json`),setTimeout(n,500)}function w(){let a=0;!function t(){a<=e.anim.endFrame&&(e.anim.frame=a,f(!0,(()=>{a++,t()})))}()}function b(a,t){const{ctx:i,canvas:s}=e.renderer,{dps:l}=e.renderer.getProps();e.anim=new r(i,l,!0),e.anim.loadData(a,(()=>{e.ui.faces.width.update(a.w),e.ui.faces.height.update(a.h),e.ui.faces.fps.update(a.fps),a.bg&&e.ui.faces.bgColor.update(a.bg),a.g&&e.timeline.setGroups([...a.g]),e.draw.reset()})),n.value=a.title||prompt("Name animation?"),e.ui.faces.fps.value=a.fps,document.title=n.value+" ~ animate",e.ui.faces.width.value=a.w,e.ui.faces.height.value=a.h,e.anim.layers.forEach((a=>{a&&(e.ui.faces.color.addColor(a.color),e.ui.faces.color.value=a.color)})),a.bg&&(e.ui.faces.bgColor.value=a.bg),a.q&&e.sequencer.load(a.q),e.ui.update()}function y(a,t){const n=a.d,r=a.l,i=t?0:e.anim.endFrame+1;for(let a=0;a<r.length;a++){const t=e.anim.loadParams(r[a]);t.startFrame=t.startFrame+i,t.endFrame=t.endFrame+i;const o=e.anim.drawings.length-1,c=new s(n[t.drawingIndex]);e.anim.addDrawing(c),t.drawingIndex=o;const d=new l(t);e.anim.addLayer(d)}e.anim.getDrawLayer().drawingIndex=e.anim.drawings.length-1,e.draw.reset(),e.ui.update()}function k(e,a){for(let a,t=0;a=e[t];t++){if(!a.type.match("application/json"))continue;const e=new FileReader;e.onload=function(e){b(JSON.parse(e.target.result))},e.readAsText(a)}}window.File&&window.FileReader&&window.FileList&&window.Blob&&(o=!0,console.log("%c Save file enabled ","color:lightgreen;background:black;"),e.renderer.canvas.addEventListener("dragover",(function(e){e.preventDefault()})),e.renderer.canvas.addEventListener("drop",(function(a){a.preventDefault(),a.stopPropagation(),k(a.dataTransfer.files,e.ui.updateFIO)})));function v(){e.ui.getPanel("fio",{label:"Files IO"});n=e.ui.addUI({id:"title",value:t,type:"UIText"}),e.ui.addCallbacks([{callback:u,key:"s",text:"Save Local",args:[!1]},{callback:m,key:"l",text:"Load Local"},{callback:p,key:"ctrl-l",text:"List Local"},{callback:d,key:"alt-c",text:"Clear Local"},{callback:f,key:"alt-s",text:"Save File",args:[!1]},{callback:f,key:"shift-s",text:"Save Frame",args:[!0]},{callback:w,key:"shift-e",text:"Save Frames to Files"},{type:"UIFile",text:"Load File",key:"o",callback:(e,a,t)=>{b(e,0)}},{type:"UIFile",text:"Overlay Drawings",callback:e=>{y(e,!0)}},{type:"UIFile",text:"Append Drawings",callback:e=>{y(e,!1)}}])}return window.addEventListener("beforeunload",(function(t){i&&e.ui.settings.saveSettings(),a.reload&&(t.returnValue="Did you save dumbhole?")})),{connect:v,loadFile:function(e,a){fetch(e).then((e=>e.json())).then((e=>{b(e),a&&a()})).catch((e=>{console.error(e)}))},loadJSON:b,getTitle:()=>n.value}}(L,{fit:!1,save:!1,load:!0,reload:!1,bg:!0}),L.capture=function(e,a){let t,n,r,i,s=a.useSequentialNumbering||!1,l=0,o=a.videoBitsPerSecond||8e6,c=!0,d={f:void 0,n:0},u=0,m=!0,g=a.cycleCount||1,h=!1,f=0,w=0,b=a.captureSettings.lineWidth||e.canvas.getLineWidth(),y=a.captureSettings.canvasScale||e.canvas.getScale(),k=window.File&&window.FileReader&&window.FileList&&window.Blob,v={};function F(){a.captureSettings&&(v.lineWidth=e.ui.faces.lineWidth.value,v.canvasScale=e.ui.faces.canvasScale.value,e.ui.faces.canvasScale.update(y),e.ui.faces.lineWidth.update(b),e.playback.update())}function x(){console.log(v),e.ui.faces.lineWidth.update(v.lineWidth),e.ui.faces.canvasScale.update(v.canvasScale)}function I(){u=1,F(),C()}function S(){F(),u=+prompt("Capture how many frames?",24),C(!1)}function C(a){e.renderer.suspend();let t=!0;l=0,e.anim.onDraw=function(){if(t)return t=!1,void window.requestAnimFrame((()=>{e.renderer.update("capture")}));u>0?(!function(){if(k)e.canvas.canvas.toBlob((a=>{const t=e.fio.getTitle(),n=Cool.padNumber(e.anim.currentFrame,3);let r;s?(r=`${t}-${Cool.padNumber(l,4)}.png`,l++):(n===d.f?d.n+=1:d.n=0,r=`${t}-${n}-${d.n}.png`,d.f=n);saveAs(a,r).onwriteend=function(){setTimeout((()=>{window.requestAnimFrame((()=>{e.renderer.update("capture")}))}),100)}}));else{const e=canvas.toDataURL("image/png").replace("image/png","image/octet-stream");window.location.href=e}}(),u--):(x(),e.anim.isPlaying=!1,e.anim.onDraw=void 0,e.renderer.start())}}function P(){e.draw.reset(),F(),e.anim.frame=e.anim.state.start,e.anim.isPlaying=!0,u=e.anim.endFrame*Math.max(1,e.anim.dpf)*g,C()}function L(){e.anim.frame=0,f=+prompt("Number of loops?",1),e.anim.onDraw=function(){i.setProp("--progress-percent",Math.round(100*e.anim.currentFrame/e.anim.endFrame))},e.anim.onPlayedState=function(){f>1?f--:h&&(N(),h=!1,e.anim.isPlaying=!1,e.anim.onPlayedState=void 0,i.setProp("--progress-percent",0),e.anim.onDraw=void 0)},T(!1,(()=>{e.anim.isPlaying=!0}))}function U(a){let t=+prompt("Number of frames?",48);w=t,e.anim.isPlaying=!1,a&&(e.anim.frame=0),T(!0);let i=a?r:n;e.anim.onDraw=function(){w>0?(w--,i.setProp("--progress-percent",Math.round(100*(1-w/t)))):h&&(N(),a&&e.anim.currentFrame<e.anim.endFrame?(w=t,e.playback.next(1),T(!0)):(e.anim.onDraw=void 0,i.setProp("--progress-percent",0)))}}function N(){h=!1,c=!0,t.stop()}function T(a,n){if(c){c=!1,h=!0,F();const r=e.canvas.canvas.captureStream(e.renderer.getProps().dps);t=new MediaRecorder(r,{videoBitsPerSecond:o,mimeType:"video/webm;codecs=vp8,vp9,opus"}),e.anim.onDraw=function(){t.start(),n&&n(),e.anim.onDraw=void 0},t.addEventListener("dataavailable",(t=>{const n=new Blob([t.data],{type:"video/webm"}),r=URL.createObjectURL(n),i=document.createElement("a");document.body.appendChild(i),i.href=r;let s=`${e.fio.getTitle()}`||"lines";a&&(s=prompt("Title?",e.fio.getTitle())),i.download=`${s}.webm`,i.click(),x()}))}}return{connect:function(){const a=e.ui.getPanel("capture");e.ui.addCallbacks([{callback:I,key:"k",text:"Frame"},{callback:S,key:"shift-k",text:"Frames"},{callback:P,key:"ctrl-k",text:"Cycle"}]),e.ui.addProp("cycleCount",{type:"UINumberStep",label:"Cycle Count",value:g,callback:e=>{g=e}}),n=e.ui.addUI({row:!0,type:"UIButton",callback:U,key:"alt-j",text:"Video Frame",args:[!1],class:"progress"}),r=e.ui.addUI({type:"UIButton",callback:U,key:"alt-j",text:"Video Frames",args:[!0],class:"progress"}),i=e.ui.addUI({type:"UIButton",callback:L,key:"j",text:"Video Loops",class:"progress"}),e.ui.addUIs([{value:!1,key:"alt-k",onText:"Stop Video",offText:"Start Video",callback:e=>{e?T():N()}}]),e.ui.addProps({withBackground:{type:"UIToggleCheck",value:m,row:!0,key:"shift-b",label:"With BG",callback:e=>{m=e}}}),a.addRow(),a.add(new p({text:"Capture Settings"})),e.ui.addProps({videoBitsPerSecond:{value:o,label:"Bitrate",callback:e=>{o=e}},captureLineWidth:{value:b,label:"Line Width",callback:e=>{b=e}},captureCanvasScale:{value:y,label:"Canvas Scale",callback:e=>{y=e}}})},startVideo:T,stopVideo:N,withBackground:()=>m,isVideo:()=>h,isCapturing:()=>u>0,isActive:()=>h||u>0}}(L,{useSequentialNumbering:!0,captureSettings:{lineWidth:1,canvasScale:2}}),L.states=function(e){let a;function t(t,r,i){const s=a.addRow(t,"break");return e.anim.states[t]=r,e.ui.faces.stateSelect.addOption(t),s.append(new p({text:t})),s.append(new h({text:"⊙",callback(){n(t)}})),s.append(new f({value:r.start,callback:e=>{r.start=e}}),"start"),s.append(new f({value:r.end,callback:e=>{r.end=e}}),"end"),s.append(new h({text:"x",callback:function(){delete e.anim.states[t],a.removeRow(s),e.anim.state="default",e.ui.faces.stateSelect.value="default",e.ui.faces.stateSelect.removeOption(t)}})),s}function n(a){if(a){const t=e.anim.state.start;return e.anim.state=a,e.ui.faces.stateSelect.value=a,"default"===a&&(e.anim.currentFrame=t),void e.ui.update()}const t=new g({app:e,title:"Choose State",position:e.mousePosition});for(const a in e.anim.states)t.add(new h({text:a,callback:()=>{e.anim.state=a,e.ui.faces.stateSelect.value=a,t.clear(),e.ui.update()}}))}function r(){const a=prompt("Name?");a&&(t(a,{start:e.anim.currentFrame,end:e.anim.currentFrame}),e.anim.state=a,e.ui.faces.stateSelect.value=a)}return{connect:function(){a=e.ui.getPanel("states"),e.ui.addCallbacks([{callback:r,key:"t",text:"Create New"},{callback(){n("default")},key:"shift-t",text:"Default"}]),a.addRow(void 0,"break")},update:function(){for(const n in e.anim.states){const r=e.anim.states[n],i=a[n]?a[n]:t(n,r);for(const e in r)i[e].value!==r[e]&&(i[e].value=r[e])}},set:n}}(L),L.palette=function(e){const a={};let t,n,r,i=1,s=!0;const l=["linesInterval","segmentNum","jiggleRange","wiggleRange","wiggleSpeed","wiggleSegments","breaks","color","brushIsActive","brushSpreadXLeft","brushSpreadXRight","brushSpreadYDown","brushSpreadYUp","brushSpreadMultiplier","brushRandomX","brushRandomY","brushSegmentsMin","brushSegmentsMax","mouseInterval","distanceThreshold","lineWidth"];function o(){e.draw.reset();const n=prompt("Name this palette.");n&&(t=n,n&&(a[n]=c(),console.log("palettes",a),d(n)))}function c(a){const t={...a};return l.forEach((a=>{t[a]||(t[a]=e.ui.faces[a].value)})),t}function d(t){n.addRow(t);const r=n.add(new h({text:t,class:"left-end",callback:()=>{f(t)}}));n.add(new h({text:"✎",class:"right-end",callback:()=>{let e=prompt("Rename: ");e&&(a[e]=_.cloneDeep(a[t]),d(e),u(t))}}));let s="+";i<10&&(e.ui.keys[i]=r,s=i+"",i++);const l=new S({text:s,callback:a=>{e.ui.keys[+a].key.value="",e.ui.keys[+a].key.el.placeholder="+",e.ui.keys[+a]=r}});r.key=l,n.add(l),n.add(new h({text:"X",callback:()=>{u(t)}}))}function u(e){delete a[e],n[e].clear()}function p(e){for(const t in e)d(t),a[t]=e[t],r.addOption(t)}function f(t){s&&e.draw.reset();const n=a[t];for(const a in n)void 0!==e.ui.faces[a]&&e.ui.faces[a].update(n[a])}function w(){for(let t=0;t<e.anim.layers.length-1;t++){const n=`Layer ${t}`,r=c(e.anim.layers[t].getEditProps());let i=!1;for(const e in a){const t=a[e];let n=!0;for(const e in t)t[e]!==r[e]&&(n=!1);n&&(i=!0)}i||(a[n]=r,d(n))}}function b(t){const n=new g({title:"Select Pallette",app:e,position:e.mousePosition});for(const e in a)"current"!==e&&n.add(new h({text:e,callback:()=>{f(e),n.clear()}}))}function y(){const e=JSON.stringify(a),t=prompt("Name:"),n=new Blob([e],{type:"application/x-download;charset=utf-8"});saveAs(n,`${t}.json`)}return{connect:function(){n=e.ui.getPanel("palette"),r=e.ui.addProp("currentPalette",{type:"UISelect",value:"None",options:["None"],callback:e=>{t=e}}),e.ui.addProps({paletteResetOnChange:{type:"UIToggleCheck",value:s,label:"Reset",callback:e=>{s=e}}}),e.ui.addCallbacks([{callback:y,text:"Save File",row:!0},{callback:w,key:"shift-p",text:"Build"},{callback:b,key:"q",text:"Quick Select"}]),n.add(new m({text:"Load File",promptDefault:"palettes",callback:e=>{p(e)}})),e.ui.addCallbacks([{callback:o,key:"p",text:"+",row:!0}])},setup:p,getPalettes:()=>a}}(L),L.drawings=function(e){let a;function t(a){const t=e.anim.layers.filter(((t,n)=>n<e.anim.layers.length-1&&t.drawingIndex==a));if(t.length>0){for(let a=0;a<t.length;a++)if(t[a].isInFrame(e.anim.currentFrame))return t[a];for(let a=0;a<t.length;a++)if(t[a].isInFrame(e.anim.currentFrame+1)||t[a].isInFrame(e.anim.currentFrame-1))return t[a];return t[0]}return!1}function n(){a.drawings.clear()}return{connect:function(){a=e.ui.getPanel("drawings"),a.addRow("drawings")},update:function(){n();for(let n=0;n<e.anim.drawings.length-1;n++){if(!e.anim.drawings[n])continue;let r=t(n);a.drawings.append(new k({text:n,isOn:!!r&&r.isInFrame(e.anim.currentFrame),callback:a=>{let r=t(n);if(a)if(r)if(r.isInFrame(e.anim.currentFrame)||r.isInFrame(e.anim.currentFrame-1)||r.isInFrame(e.anim.currentFrame+1))r.addIndex(e.anim.currentFrame);else{const a=r.getCloneProps();a.startFrame=a.endFrame=e.anim.currentFrame,e.anim.addLayer(new l(a))}else e.anim.addLayer(new l({drawingIndex:n,linesInterval:+e.ui.faces.linesInterval.value,segmentNum:+e.ui.faces.segmentNum.value,jiggleRange:+e.ui.faces.jiggleRange.value,wiggleRange:+e.ui.faces.wiggleRange.value,wiggleSpeed:+e.ui.faces.wiggleSpeed.value,color:e.ui.faces.color.value,startFrame:e.anim.currentFrame}));else if(r&&r.isInFrame(e.anim.currentFrame)){const a=r.removeIndex(e.anim.currentFrame,(()=>{e.anim.removeLayer(r)}));a&&e.anim.addLayer(a)}e.ui.update()}}),n)}},clear:n}}(L),L.timeline=function(){let e,a,t,n,r=120,i=!0,o=!1,c=0,d=!0,u=!1,m=!1,p=[];const f=[1,2,4,5,6,10,12,20,30,40,50,100,200,500,1e3];let w,b,y=1;function k(){const t=L.anim.endFrame+1,n=e.el.clientWidth-11;r=(n-2*t)/t,a.setProp("--frame-width",r)}function v(){r=140,a.setProp("--frame-width",r),r<5?(a.addClass("five"),a.removeClass("ten")):r<10?(a.addClass("ten"),a.removeClass("five")):(a.removeClass("ten"),a.removeClass("five")),U(),x()}function x(e){(u||e)&&a.el.scrollTo(a[`frm-${L.anim.currentFrame}`].el.offsetLeft-10,0)}function I(){let n=L.ui.faces.frameDisplay.value;L.ui.faces.frameDisplay.value=L.anim.currentFrame,t.text=L.anim.currentFrame,L.anim.isPlaying?function(e){let t=Math.floor(e/y)*y,n=Math.floor(L.anim.currentFrame/y)*y;if(t===n)return;a["frm-"+t].removeClass("current"),a["frm-"+n].addClass("current")}(n):(a.clear(),m&&k(),function(){a.setProp("--num-frames",L.anim.endFrame+1);const t=L.anim.endFrame+1;w=e.el.clientWidth-11;const n=w/t;if(r=Math.floor(w/t),w<0)return;const i=24;let s=n,l=0;for(;s<i;)s=w/(t/f[l]),l++;y=f[l];const o=Math.floor(t/y)+1;b=Math.floor(w/o),a.setProp("--num-frames",o),a.setProp("--frame-width",b);for(let e=0;e<t;e+=y){const t=new h({text:`${e}`,css:{gridColumnStart:1+2*Math.floor(e/y),gridColumnEnd:3+2*Math.floor(e/y)},class:"frame",callback:function(){L.draw.reset(),L.playback.setFrame(e),L.ui.update()}});Math.floor(e/y)===Math.floor(L.anim.currentFrame/y)&&t.addClass("current"),t.removeClass("btn"),a.append(t,`frm-${e}`)}if("default"!==L.anim.stateName){a.setProp("--state-height",1);const e=new C({class:"state",css:{gridColumnStart:2*L.anim.state.start+1,gridColumnEnd:2*(L.anim.state.end+1)+1}});a.append(e)}else a.setProp("--state-height",0);x()}(),U())}function S(e,a){a<0||([L.anim.layers[a],L.anim.layers[e]]=[L.anim.layers[e],L.anim.layers[a]],I())}function P(e,a){if(a<0)return;const t=L.anim.layers.splice(e,1);L.anim.layers.splice(a,0,t[0]),I()}function U(){let e=0,t=0;if(i){const i=o?L.anim.layers.filter((e=>{const a=L.anim.currentFrame;for(let t=a-c;t<=a+c;t++)if(e.isInFrame(t))return!0;return!1})):L.anim.layers;let l=2,u=3;if(d)for(let t=0,n=p.length;t<n;t++){let n=i.filter((e=>e.groupNumber===t));if(0===n.length)continue;const s=n.reduce(((e,a)=>e.startFrame<a.startFrame?e:a)).startFrame,o=n.reduce(((e,a)=>e.endFrame<a.endFrame?e:a)).endFrame;n.forEach((e=>{e.startFrame!==s&&(e.startFrame=s),e.endFrame!==s&&(e.endFrame=o)}));const c=new R(n,{name:p[t],index:t,class:"group",startFrame:s,endFrame:o,width:r*(o-s+1),css:{gridRowStart:l,gridRowEnd:u,gridColumnStart:2*s+1,gridColumnEnd:2*o+3},update(){L.ui.update()},reset(){B()},moveUp(){n.forEach((e=>{const a=L.anim.layers.indexOf(e);S(a,a-1)}))},moveToBack(){for(let e=n.length-1;e>=0;e--){P(L.anim.layers.indexOf(n[e]),0)}}});l+=2,u+=2,e++,a.append(c,`group-${t}`)}for(let c=0,m=L.anim.layers.length-1;c<m;c++){const m=L.anim.layers[c];if(m.groupNumber>=0&&d)continue;if(o&&!i.includes(m))continue;const f=(b+2)*(Math.floor(m.endFrame/y)-Math.floor(m.startFrame/y)+1),w=new T(m,{group:d?void 0:p[m.groupNumber],canMoveUp:c>0&&i.length>2,type:"layer",width:f,css:{width:f+"px",gridRowStart:l,gridRowEnd:u,gridColumnStart:2*Math.floor(m.startFrame/y)+1,gridColumnEnd:2*Math.floor(m.endFrame/y)+3},moveUp(){const e=L.anim.layers.indexOf(m);S(e,e-1)},moveToBack(){P(L.anim.layers.indexOf(m),0)},addToGroup(e){if(L.draw.reset(),0===p.length){let e=prompt("Name new group","New Group 0");p.push(e),m.groupNumber=0,L.ui.update()}else{let a=new g({title:"Select Group",app:L,position:e,callback:function(){m.groupNumber=+t.value,n=+t.value,L.ui.update()}});a.addBreak("Groups:");let t=new F({});for(let e=0;e<p.length;e++)t.addOption(e,p[e]);n&&(t.value=n),a.add(t),a.addBreak(),a.add(new h({text:"New Group",callback:function(){a.clear();let e=prompt("Name new group","New Group "+p.length);p.push(e),m.groupNumber=p.length-1,n=m.groupNumber,L.ui.update()}}))}},setLinesProperties:function(){L.draw.setProperties(m.getEditProps(),!0)},update(){L.ui.update()},reset(){B()},lineToLayer(){L.draw.reset();const e=L.anim.drawings[m.drawingIndex],a=L.anim.getCurrentDrawing(),t=L.anim.getDrawLayer();t.startFrame=m.startFrame,t.endFrame=m.endFrame;e.pop();const n=[];for(let a=e.length-1;a>0;a--){const a=e.pop();if("end"===a)break;n.push(a)}for(let e=n.length-1;e>0;e--)a.add(n[e]);L.draw.reset(),B(),I()},remove(e){L.anim.removeLayer(e)},cloneDrawing(){const e=m.getCloneProps(),a=L.anim.drawings[e.drawingIndex],t=new s;for(let e=0;e<a.length;e++)"add"===a.get(e)[0]?t.add("add"):"end"===a.get(e)[0]?t.add("end"):t.add([...a.get(e)[0]]);L.anim.drawings.pop(),L.anim.drawings.push(t),L.draw.reset()}});l+=2,u+=2,e++,a.append(w,`layer-${c}`);for(let e=0;e<m.tweens.length;e++){const n=m.tweens[e],i=new E({type:"tween",css:{width:r*(n.endFrame-n.startFrame+1)+"px",gridRowStart:l,gridRowEnd:u,gridColumnStart:2*Math.floor(n.startFrame/y)+1,gridColumnEnd:2*Math.floor(n.endFrame/y)+3},update(){L.ui.update()}},n,m);a.append(i,`tween-${e}-layer-${c}`),t++,l+=2,u+=2}}}a.setProp("--num-layers",e),a.setProp("--num-tweens",t)}function N(){for(let e=0,a=L.anim.layers.length-1;e<a;e++){const a=L.anim.layers[e];if(a.isInFrame(L.anim.currentFrame)){const e=a.getCloneProps();e.startFrame=L.anim.currentFrame+1,L.anim.addLayer(new l(e)),a.endFrame=L.anim.currentFrame}}L.playback.setFrame(L.anim.currentFrame+1)}function D(e){for(let t=0,n=L.anim.layers.length-1;t<n;t++){const n=L.anim.layers[t];n.isInFrame(L.anim.currentFrame)&&n.isToggled!==e&&(n.groupNumber>=0?a[`group-${n.groupNumber}`].toggle.update(e):a[`layer-${t}`].toggle.update(e))}}function M(e){for(let t=0,n=L.anim.layers.length-1;t<n;t++){const n=L.anim.layers[t];n.isInFrame(L.anim.currentFrame)&&n.isLocked!==e&&a[`layer-${t}`].lock.update(e)}}function B(){for(let e=0,a=L.anim.layers.length;e<a;e++){L.anim.layers[e].reset()}U()}return{connect:function(){e=L.ui.getPanel("timeline"),L.ui.addProps({viewGroups:{value:d,text:"G",noLabel:!0,key:"backslash",callback:e=>{d=e,I()}},viewLayers:{value:i,key:"[",text:"V",class:"left-end",noLabel:!0,callback:e=>{i=e,I()}},viewActiveLayers:{value:o,key:"]",text:"V",class:"right-end",noLabel:!0,callback:e=>{o=e,I()}},viewLayerRange:{type:"UINumberStep",value:c,noLabel:!0,callback:e=>{c=e},range:[0,10]},useScrollToFrame:{type:"UIToggle",text:"Follow",noLabel:!0,value:u,callback:e=>{u=e}}}),L.ui.addCallbacks([{callback:x,key:"shift-f",text:"⊙",args:[!0]},{callback:k,text:"⇿",key:"alt-f",class:"left-end"},{callback:v,text:"⏛",key:"ctrl-f",class:"right-end"},{callback:D,text:"Select",key:"shift-v",class:"left-end",args:[!0]},{callback:D,text:"Deselect",key:"alt-d",class:"right-end",args:[!1]},{callback:M,text:"Lock",key:"shift-l",class:"left-end",args:[!0]},{callback:M,text:"Unlock",key:"alt-l",class:"right-end",args:[!1]},{callback:N,text:"Split"}]),L.ui.addProps({autoFit:{type:"UIToggleCheck",value:m,callback(e){m=e}},stateSelect:{type:"UISelect",key:"ctrl-t",label:"State",callback(e){L.states.set(e)}}}),t=L.ui.addUI({type:"UILabel",text:"0",id:"big-frame-display"}),a=e.addRow("timeline")},update:I,init:function(){e.el.addEventListener("mousemove",(e=>{1==e.which&&e.target.classList.contains("frame")&&L.anim.currentFrame!=+e.target.textContent?(L.draw.reset(),L.playback.setFrame(+e.target.textContent),L.ui.update()):e.which}))},getGroups:()=>p,setGroups(e){p=e}}}(),L.sequencer=function(e){let a,t,n,r,i,s=[],l=0,o=!1,c=0,d=0,u=!1,m=!1;function p(e){s[l]&&s[l].hide();const n=s.length;e||(e=prompt("Name this sequence")||"Sequence "+n);const r=new D({name:e,class:"row"});a.add(r,"sequence-"+n),s.push(r),t.addOption(n,e),t.value=n}function g(e){0===s.length&&p();const a=s[l],t=(a.clips.length,new N({...e,remove:()=>{a.removeClip(t)}}));a.addClip(t)}return{connect:function(){a=L.ui.getPanel("sequencer"),i=L.ui.addProp("renderSequencer",{type:"UIToggleCheck",value:!1,callback:e=>{u=e},key:"alt-q"}),a.addRow(),n=L.ui.addUI({type:"UIToggle",value:!1,onText:"❚❚",offText:"▶",callback:e=>{o=e,o&&!u&&i.update(!0)},key:"alt-space"}),r=L.ui.addUI({type:"UINumberStep",value:0,callback:e=>{c=e}}),L.ui.addCallback({text:"Capture",callback:()=>{m=!0,L.capture.startVideo(),c=0,o||n.update(!0),u||i.update(!0)}}),a.addRow(),L.ui.addCallbacks([{callback:p,text:"Add Sequence"},{callback:g,text:"Add Clip"}]),t=L.ui.addProp("sequenceSelector",{type:"UISelect",options:s.map(((e,a)=>({value:a,text:e.name}))),callback:e=>{s[l]&&(s[l].hide(),l=e,s[l].show(),L.timeline.update())}})},load:function(e){e.forEach((e=>{p(e.name),e.clips.forEach((e=>{g(e)}))}))},getData:function(){return 0!==s.length&&s.map((e=>({name:e.name,clips:e.getData()})))},getFrame:function(){if(0===s.length)return;const e=s[l];return o&&(d===L.anim.dpf?(d=0,c++,c>=e.getEndFrame()&&(c=0,n.update(!1),m&&(L.capture.stopVideo(),m=!1))):d++),r.value=c,e.getFrame(c)},isActive:()=>u&&s.length>0,isPlaying:()=>o}}(),L.animator=function(e){let a,t;function n(){t=new i(e.anim),e.anim.onPlayedState=()=>{t.update()},function(){for(const e in t.params){const n=a.addRow(),r=t.params[e];a.add(new p({text:e}),"label",n);const i=a.addRow();a.add(new f({text:"Min",value:r[0],callback:e=>{r[0]=e}}),"min",i),a.add(new f({text:"Max",value:r[1],callback:e=>{r[1]=e}}),"max",i)}}()}function r(){t=void 0,e.anim.onPlayedState=void 0;for(let e=a.rows.length-1;e>0;e--)a.rows[e].clear(),a.removeRow(a.rows[e])}return{connect:function(){a=e.ui.getPanel("animator"),e.ui.addCallbacks([{callback:n,text:"Add"},{callback:r,text:"Remove"}])}}}(L),L.ui=d(L,{useMain:!1}),L.ui.setup(),L.canvas.connect(),L.playback.connect(),L.draw.connect(),L.events.connect(),L.brush.connect(),L.eraser.connect(),L.bg.connect(),L.data.connect(),L.fio.connect(),L.capture.connect(),L.states.connect(),L.palette.connect(),L.drawings.connect(),L.animator.connect(),L.timeline.connect(),L.sequencer.connect(),L.ui.update=function(){L.timeline.update(),L.drawings.update(),L.states.update()},L.ui.update(),L.ui.settings=new u(L,{name:"lns",workspaceFields:["hideCursor"],workspaces:[{text:"Animation",url:"workspaces/Animation.json"},{text:"Drawing",url:"workspaces/Drawing.json"}],appSave:()=>({palettes:L.palette.getPalettes()}),appLoad(e){L.palette.setup(e.interface.palettes)}}),L.draw.setDefaults(),L.timeline.init(),L.playback.toggleStats(),L.renderer.start(),L.ui.settings.load(),U.src&&L.fio.loadFile(U.src),console.log(L),window.lns=L;class N extends w{constructor(e){super(e),e.state||this.setState(),this.state=e.state||"default",this.repeat=e.repeat||1,this.addClass("clip"),this.label=new p({text:"State "+this.state});const a=new f({label:"Repeat",value:this.repeat,callback:e=>{this.repeat=e}});this.add(this.label);const t=new P;this.add(t);const n=new h({text:"Change State",callback:()=>{this.setState()}});t.add(n),t.add(new p({text:"Repeat"})),t.add(a);const r=new h({text:"X",callback:()=>{e.remove()}});t.add(r)}setState(){let e=this.state;const a=new g({title:"Set State",app:L,position:this.position||L.mousePosition,callback:()=>{e&&(this.state=e,this.label.text="State "+this.state)}}),t=new F({options:Object.keys(L.anim.states),value:e,callback:a=>{e=a}});a.add(t)}get duration(){return(L.anim.states[this.state].end-L.anim.states[this.state].start+1)*this.repeat}getFrame(e){const a=L.anim.states[this.state].end-L.anim.states[this.state].start+1;return L.anim.states[this.state].start+e%a}getData(){return{state:this.state,repeat:this.repeat}}}class T extends w{constructor(e,a){super(a),this.addClass("layer"),this.layer=e,a.canMoveUp&&(this.canMoveUp=a.canMoveUp);const t=a.width;this.update=a.update,this.reset=a.reset,this.remove=a.remove,this.lineToLayer=a.lineToLayer;const n=new k({btnClass:"layer-toggle",class:"timeline-btn",text:`${e.drawingIndex}`,isOn:e.isToggled,callback:t=>{e.isToggled=t,e.isToggled&&a.setLinesProperties&&a.setLinesProperties(),r.update(e.isToggled)}}),r=new k({btnClass:"layer-highlight",class:"timeline-btn",text:"*",isOn:e.isHighlighted,callback:a=>{e.isHighlighted=a}}),i=new h({btnClass:"layer-edit",class:"timeline-btn",text:"E",callback:()=>{this.editModal(e,a)}});a.group&&(this.groupLabel=new p({text:a.group}));const s=this.getPropUIs(e,a,!1);t>40&&this.append(s.startFrameNumber),this.append(n,"toggle"),this.append(r),this.append(i),t<20&&this.append(s.toEnd),t>50&&this.append(s.lock,"lock"),t>60&&this.append(s.tween),t>70&&this.append(s.remove),t>80&&this.append(s.addToGroup),t>90&&this.append(s.merge),t>90&&this.canMoveUp&&this.append(s.moveUp),t>100&&this.groupLabel&&this.append(this.groupLabel),t>80&&(this.append(s.endFrameNumber),s.endFrameNumber.addClass("right-margin"))}getPropUIs(e,a,t){const n=t?"btn":"timeline-btn",r=new h({text:t?"Add Tween":"T",class:n,btnClass:"layer-tween",callback:()=>{this.tweenModal(e)}}),i=new h({btnClass:"remove",text:t?"Remove":"X",class:n,callback:()=>{this.remove(e),this.update()}}),s=new f({value:e.startFrame,class:t?"":n,min:0,max:L.anim.endFrame+1,callback:a=>{e.startFrame=a,a>e.endFrame&&(e.endFrame=a),e.resetTweens(),this.update()}}),l=new f({value:e.endFrame,class:t?"":n,min:0,callback:a=>{e.endFrame=a,a<e.startFrame&&(e.startFrame=a),e.resetTweens(),this.update()}}),o=new h({text:">>",class:t?"":n,callback:()=>{this.layer.endFrame=L.anim.endFrame,this.update()}}),c=new k({btnClass:"layer-lock",text:t?"Lock":"L",class:n,isOn:e.isLocked,callback:a=>{e.isLocked=a}}),d=new h({text:t?"Move Up":"^",btnClass:"move-up",class:n,callback:a.moveUp}),u=new h({text:t?"Move To Back":"^",btnClass:"move-up",class:n,callback:a.moveToBack}),m=new h({text:t?"Add to Group":"G",btnClass:"add-to-group",class:n,callback:()=>{a.addToGroup(this.position)}}),w=()=>{this.reset(),this.update()};return{tween:r,remove:i,startFrameNumber:s,endFrameNumber:l,lock:c,moveUp:d,moveToBack:u,addToGroup:m,merge:new h({text:t?"Merge Layer":"M",class:n,btnClass:"merge-layer",callback:()=>{const a=new g({text:"Merge Layer",app:L,position:this.position,callback:w,clearFunc:w});for(let t=0,n=L.anim.layers.length-1;t<n;t++){const n=L.anim.layers[t];n!==e&&(n.isInFrame(L.anim.currentFrame)&&(a.add(new p({text:`Layer ${t}, Drawing ${n.drawingIndex}`})),a.add(new k({text:"*",class:"left-end",isOn:n.isHighlighted,callback:e=>{n.isHighlighted=e}})),a.add(new h({text:"Merge",class:"right-end",callback:()=>{L.anim.merge(e.drawingIndex,n.drawingIndex,e),L.anim.removeLayer(n),w(),a.clear()}}))))}}}),toEnd:o}}editModal(e,a){const t=new g({title:"Edit Layer",app:L,position:this.position,callback:()=>{L.ui.update()}}),n=this.getPropUIs(e,a,!0);for(const e in n)"startFrameNumber"===e&&t.addBreak("Start Frame:"),"endFrameNumber"===e&&t.addBreak("End Frame:"),t.add(n[e]),"endFrameNumber"===e&&t.addBreak();t.add(new h({text:"Cut Segment",callback:()=>{const a=L.anim.drawings[e.drawingIndex];a.pop(),a.pop(),a.add("end"),e.resetDrawingEndIndex(a.length)}})),t.add(new h({text:"Cut Line",callback:()=>{const a=L.anim.drawings[e.drawingIndex];a.pop();for(let e=a.length-1;e>0&&"end"!==a.get(e)[0];e--)a.pop();e.resetDrawingEndIndex(a.length)}})),t.add(new h({text:"Line to Layer",callback:()=>{this.lineToLayer()}})),t.add(new h({text:"Clone Layer",callback:()=>{const a=e.getCloneProps();a.startFrame=a.endFrame=e.endFrame+1,L.anim.addLayer(new l(a)),L.playback.setFrame(e.endFrame+1)}})),t.add(new h({text:"Split",callback:()=>{const a=e.getCloneProps();a.startFrame=L.anim.currentFrame+1,e.endFrame=L.anim.currentFrame,L.anim.addLayer(new l(a)),L.playback.setFrame(e.endFrame+1)}})),t.add(new h({text:"Clone Drawing",callback:a.cloneDrawing})),t.adjustPosition()}tweenModal(e){const a={prop:"endIndex",startFrame:L.anim.currentFrame,endFrame:L.anim.currentFrame+10,startValue:0,endValue:"end"},t=new g({title:"Add Tween",app:L,position:this.position,callback:()=>{"end"!==a.endValue||"endIndex"!==a.prop&&"startIndex"!==a.prop||(a.endValue=L.anim.drawings[e.drawingIndex].length),e.addTween(a),this.update()}});t.addBreak("Property:"),t.add(new F({options:Object.keys(e.getTweenProps()),value:"endIndex",selected:"endIndex",callback(e){a.prop=e}})),t.addBreak("Start Frame:"),t.add(new I({value:a.startFrame,callback(e){a.startFrame=e}})),t.addBreak("End Frame:"),t.add(new I({value:a.endFrame,callback(e){a.endFrame=e}})),t.addBreak("Start Value:"),t.add(new I({value:a.startValue,callback(e){a.startValue=e}})),t.addBreak("End Value:"),t.add(new I({value:a.endValue,callback(e){a.endValue=e}}))}}class D extends w{constructor(e){super(e),this.name=e.name,this.clips=[]}addClip(e){this.clips.push(e),this.add(e)}removeClip(e){const a=this.clips.indexOf(e);this.clips.splice(a,1),this.remove(e)}show(){this.setProp("display","flex")}hide(){this.setProp("display","none")}getEndFrame(){if(0===this.clips.length)return 0;let e=0;return this.clips.forEach((a=>{e+=a.duration})),e}getFrame(e){let a=e;for(let e=0;e<this.clips.length;e++){if(a<this.clips[e].duration)return this.clips[e].getFrame(a);a-=this.clips[e].duration}}getData(){return this.clips.map((e=>e.getData()))}}class R extends w{constructor(e,a){super(a),this.index=a.index,this.layers=e,this.addClass("group"),this.startFrame=a.startFrame,this.endFrame=a.endFrame,this.update=a.update,this.reset=a.reset;const t=a.width;this.isToggled=!1;const n=new k({class:"group-toggle",btnClass:"timeline-btn",text:a.name,isOn:this.isToggled,callback:a=>{this.isToggled=a,r.update(a),e.forEach((e=>{e.toggle(this.isToggled)}))}}),r=new k({class:"group-highlight",btnClass:"timeline-btn",text:"*",isOn:!1,callback:a=>{e.forEach((e=>{e.isHighlighted=a}))}}),i=new h({class:"layer-edit",btnClass:"timeline-btn",text:"E",callback:()=>{this.editModal(e,a)}}),s=this.getPropUIs(e,a,!1);t>30&&this.append(s.startFrameNumber),this.append(n,"toggle"),this.append(r),this.append(i),t>50&&this.append(s.lock,"lock"),t>60&&this.append(s.breakUp),t>70&&this.append(s.removeLayer),t>80&&this.append(s.tween),t>90&&this.append(s.moveUp),t>80&&(this.append(s.endFrameNumber),s.endFrameNumber.addClass("right-margin"))}getPropUIs(e,a,t){const n=t?"btn":"timeline-btn";return{lock:new k({class:"group-lock",text:t?"Lock":"L",btnClass:n,isOn:!1,callback:function(){e.forEach((e=>{e.isLocked=!e.isLocked}))}}),breakUp:new h({class:"group-breakup",btnClass:n,text:t?"Break up":"X",callback:()=>{e.forEach((e=>{e.groupNumber=-1})),this.update()}}),removeLayer:new h({class:"group-remove-layer",btnClass:n,text:t?"Remove Layer":"R",callback:()=>{const e=()=>{this.reset(),this.update()},a=new g({title:"Remove Layers",app:L,position:this.position,callback:e,onClear:e});for(let e=0,t=L.anim.layers.length;e<t;e++){if(L.anim.layers[e].groupNumber!==this.index)continue;const t=L.anim.layers[e],n=new h({text:`Layer ${e}, Drawing ${t.drawingIndex}`,callback:function(){t.groupNumber=-1,a.remove(n)}});a.add(n)}}}),startFrameNumber:new f({value:this.startFrame,class:t?"":n,min:0,callback:a=>{e.forEach((e=>{e.startFrame=a,a>e.endFrame&&(e.endFrame=a),e.resetTweens()})),this.update()}}),endFrameNumber:new f({value:this.endFrame,class:t?"":n,min:0,callback:a=>{e.forEach((e=>{e.endFrame=a,a<e.startFrame&&(e.startFrame=a),e.resetTweens()})),this.update()}}),tween:new h({text:t?"Add Tween":"T",class:n,btnClass:"group-tween",callback:()=>{this.tweenModal(e)}}),moveUp:new h({text:t?"Move Up":"^",btnClass:"move-up",class:n,callback:a.moveUp}),moveToBack:new h({text:t?"Move To Back":"^",btnClass:"move-up",class:n,callback:a.moveToBack})}}editModal(e,a){const t=new g({title:"Edit Group",app:L,position:this.position,callback:()=>{this.update()}}),n=this.getPropUIs(e,a,!0);for(const e in n)"startFrameNumber"===e&&t.addBreak("Start Frame:"),"endFrameNumber"===e&&t.addBreak("End Frame:"),t.add(n[e]);t.adjustPosition()}tweenModal(e){const a={prop:"endIndex",startFrame:L.anim.currentFrame,endFrame:L.anim.currentFrame+10,startValue:0,endValue:"end"},t=new g({title:"Add Tween",app:L,position:this.position,callback:()=>{e.forEach((e=>{"end"===a.endValue&&"endIndex"===a.prop&&(a.endValue=L.anim.drawings[e.drawingIndex].length),e.addTween({...a})})),this.update()}});t.addBreak("Property:"),t.add(new F({options:Object.keys(e[0].getTweenProps()),value:"endIndex",selected:"endIndex",callback(e){a.prop=e}})),t.addBreak("Start Frame:"),t.add(new I({value:a.startFrame,callback(e){a.startFrame=e}})),t.addBreak("End Frame:"),t.add(new I({value:a.endFrame,callback(e){a.endFrame=e}})),t.addBreak("Start Value:"),t.add(new I({value:a.startValue,callback(e){a.startValue=e}})),t.addBreak("End Value:"),t.add(new I({value:a.endValue,callback(e){a.endValue=e}}))}}class E extends w{constructor(e,a,t){super(e),this.addClass("tween"),this.tween=a;const n=new h({text:"E",btnClass:"timeline-btn",class:"tween-edit",callback:()=>{const n=new g({title:"Edit Tween",app:L,position:this.position,callback:()=>{e.update()}}),r=this.getPropUIs(a,t,e,!0);n.addBreak("Start Frame"),n.add(r.startFrame),n.addBreak("End Frame"),n.add(r.endFrame),n.addBreak("Start Value"),n.add(r.startValue),n.addBreak("End Value"),n.add(r.endValue)}}),r=new h({class:"remove",text:"X",btnClass:"timeline-btn",callback:()=>{t.tweens.splice(t.tweens.indexOf(this),1),L.ui.update()}}),i=this.getPropUIs(a,t,e,!1);i.endFrame.addClass("right-margin"),this.append(i.startFrame),this.append(n),this.append(r),this.append(i.endFrame)}getPropUIs(e,a,t,n){const r=n?"btn":"timeline-btn";return{startFrame:new f({value:e.startFrame,class:n?"":r,callback:n=>{e.startFrame=n>=a.startFrame?n:a.startFrame,t.update()}}),endFrame:new f({value:e.endFrame,class:n?"":r,callback:n=>{e.endFrame=n<=a.endFrame?n:a.endFrame,t.update()}}),startValue:new f({value:e.startValue,class:n?"":r,callback(a){e.startValue=a}}),endValue:new f({value:e.endValue,class:n?"":r,callback(a){e.endValue=a}})}}}}();
//# sourceMappingURL=src_maps/animate.min.js.map
