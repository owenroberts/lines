class Clip{constructor(t){this.name=t.name,this.animation=t.animation,this.startFrame=t.startFrame,this.endFrame=t.startFrame+t.animation.endFrame,this.isVisible=!0,this.state="default",this.animation.isPlaying=!0}update(t){this.animation.frame=t-this.startFrame}draw(){this.animation.update(),this.animation.draw()}}class Timeline{constructor(t){this.tracks=[],this.tracks.push(new Track),this.activeTrackIndex=0,this.isVisible=!0}addTrack(){this.tracks.push(new Track)}get track(){return this.tracks[this.activeTrackIndex]}set track(t){this.activeTrackIndex=+t}get endFrame(){}update(t){for(let e=0;e<this.tracks.length;e++)this.tracks[e].update(t)}draw(t){for(let e=0;e<this.tracks.length;e++)this.tracks[e].draw(t)}}class Track{constructor(t){this.clips=[]}get endFrame(){}addClip(t){this.clips.push(t)}update(t){for(let e=0;e<this.clips.length;e++){const i=this.clips[e];if(!(t<i.startFrame)&&!(t>i.endFrame)){i.update(t);break}}}draw(t){for(let e=0;e<this.clips.length;e++){const i=this.clips[e];if(!(t<i.startFrame)&&!(t>i.endFrame)){i.draw(t);break}}}}function Canvas(t,e){Object.assign(Canvas.prototype,ModuleMixin);const i=this;this.canvas=document.getElementById(e.id),this.ctx=this.canvas.getContext("2d");let a=e.checkRetina&&window.devicePixelRatio||1,n=e.lineWidth||1,s=e.scale||1,o=this.canvas.width,r=this.canvas.height;this.addProp("scale",{get:()=>s,set:t=>{s=+t,i.updateSize()}}),this.addProp("width",{get:()=>o,set:t=>{o=+t,i.updateSize()}}),this.addProp("height",{get:()=>r,set:t=>{r=+t,i.updateSize()}}),this.addProp("lineWidth",{get:()=>n,set:t=>{n=+t,i.reset()}}),this.updateSize=function(){i.canvas.width=o*a*s,i.canvas.height=r*a*s,i.reset()},this.reset=function(){i.canvas.style.width=o*s+"px",i.canvas.style.height=r*s+"px",i.ctx.lineWidth=n,i.ctx.miterLimit=1,i.ctx.lineCap="round",i.ctx.lineJoin="round"}}function FileIO(t,e){Object.assign(FileIO.prototype,ModuleMixin);const i=this;let a=e.projectName||"Animation_"+(new Date).toDateString().replace(/ /g,"-");this.addProp("projectName",{get:()=>a,set:t=>{a=t,document.title=a+" ~ animation editor"}}),this.save=function(){const e={v:"0.1"};e.footage=t.footage.filePaths;const i=JSON.stringify(e),n=new Blob([i],{type:"application/x-download;charset=utf-8"});saveAs(n,a+".json")},this.load=function(e){i.projectName=e.split("/").pop().replace(".json",""),fetch(e).then((t=>t.json())).then((e=>{!function(e){t.footage.load(e.footage,!0)}(e)})).catch((t=>{console.error("err",t.message)}))}}function Footage(t){const e=this;let i=!0;const a={};function n(n,s,o,r){a[s]=new Lines(t.canvas.ctx,30,!0),a[s].loadData(n,(()=>{(r||i&&confirm("Set project settings?"))&&(i=!1,t.ui.faces.width.update(n.w),t.ui.faces.height.update(n.h))}));const c=new UIButton({text:s,callback:()=>{console.log(s,a[s]);const e=new Clip({name:s,animation:a[s],startFrame:t.renderer.frame});t.timeline.track.addClip(e)}});e.panel.footageRow.append(c),e.filePaths.push(o)}this.filePaths=[],this.load=function(t,e){t.forEach((t=>{const i=t.split("/").pop().replace(".json","");fetch(t).then((t=>t.json())).then((a=>n(a,i,t,e))).catch((t=>{console.error("err",t.message)}))}))},this.openFile=function(){const t=document.createElement("input");t.type="file",t.multiple=!0,t.click(),t.onchange=function(){let e=prompt("Directory?","/drawings/");!function(t,e){for(let i,a=0;i=t[a];a++){if(!i.type.match("application/json"))continue;const t=new FileReader;t.onload=function(t){const a=e+i.name,s=i.name.split(".")[0];n(JSON.parse(t.target.result),s,a)},t.readAsText(i)}}(t.files,e)}}}const ModuleMixin={addProp(t,e){Object.defineProperty(this,t,{get:e.get,set:e.set})}};function Renderer(t,e,i){Object.assign(Renderer.prototype,ModuleMixin);const a=this;e||(e=30),i||(i=e);let n=1e3/e,s=performance.now(),o=Math.round(e/i),r=0,c=!1,d=0;window.drawCount=0,this.isPlaying=!1,this.addProp("dps",{get:()=>e,set:t=>{n=1e3/(e=+t),o=Math.round(e/i)}}),this.addProp("fps",{get:()=>i,set:t=>{i=+t,o=Math.round(e/i)}}),this.addProp("frame",{get:()=>d,set:e=>{console.log("frame",e);let i=d;i="+1"===e?d+1:"-1"===e?d-1:"end"===e?t.timeline.endFrame:+e,i<=t.timeline.endFrame&&i>=0&&(d=i),t.ui.faces.frameDisplay.value=d}}),this.addProp("isPlaying",{get:()=>c,set:t=>{c=t}}),this.update=function(e,i){(performance.now()>n+s||i)&&(s=performance.now(),t.canvas.ctx.clearRect(0,0,t.canvas.width,t.canvas.height),c&&(r===o?(d++,r=0):r++),t.timeline.update(d),t.timeline.draw(d),window.drawCount++),i||window.requestAnimFrame(a.update)},this.start=function(){window.requestAnimFrame(a.update)}}window.addEventListener("load",(function(){const t={};t.addProp=Object.defineProperty;const e={};location.search.substr(1).split("&").map((t=>{let[i,a]=t.split("=");e[i]=a}));const i={default:new Timeline};t.addProp(t,"timeline",{get:()=>i.default,set:e=>{t.activeTimeline=e}}),t.canvas=new Canvas(t,{id:"lines",checkRetina:!0}),t.footage=new Footage(t),t.fio=new FileIO(t,{}),t.renderer=new Renderer(t),t.ui=new Interface(t),t.ui.settings=new Settings(t,"anim-editor"),t.ui.load("./interface/interface.json",(()=>{e.src&&t.fio.load(e.src),t.ui.settings.load(),t.renderer.start()})),console.log(t)}));
//# sourceMappingURL=src_maps/animEditor.min.js.map
