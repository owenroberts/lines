class Clip{constructor(t,e){e||(e=30),this.name=t.name,this.filePath=t.filePath,this.animation=t.animation,this.startFrame=t.startFrame,this.isVisible=void 0===t.isVisible||t.isVisible,this.repeatCount=t.repeatCount||1,this.state=t.state||"default",this.setup(),this.endFrame=this.calcEndFrame(),this.animation.isPlaying=!0}setup(){const t=this.animation.states[this.state];this.duration=t.end-t.start+1}calcEndFrame(){let t=this.duration*this.animation.dpf*this.repeatCount;return this.endFrame=this.startFrame+t-1,this.endFrame}update(t){let e=t-this.startFrame;e=Math.floor(e/this.animation.dpf),e%=this.duration,this.animation.currentFrame=this.animation.states[this.state].start+e}draw(){this.animation.draw()}get data(){return{name:this.name,filePath:this.filePath,startFrame:this.startFrame,isVisible:this.isVisible,state:this.state,repeatCount:this.repeatCount}}}class Composition{constructor(t){this.tracks=[],t.tracks?t.tracks.forEach((t=>{this.tracks.push(new Track(t))})):this.tracks.push(new Track({})),this.activeTrackIndex=t.activeTrackIndex||0,this.isVisible=void 0===t.isVisible||t.isVisible,this.endFrame=this.calcEndFrame()}addTrack(){this.tracks.push(new Track({}))}addComposition(t){this.track.addComposition(t)}get track(){return this.tracks[this.activeTrackIndex]}set track(t){this.activeTrackIndex=+t}calcEndFrame(){return this.endFrame=Math.max(...this.tracks.map((t=>t.calcEndFrame()))),this.endFrame}update(t){for(let e=0;e<this.tracks.length;e++)this.tracks[e].update(t)}draw(t){for(let e=0;e<this.tracks.length;e++)this.tracks[e].draw(t)}get data(){return{tracks:this.tracks.map((t=>t.data)),activeTrackIndex:this.activeTrackIndex,isVisible:this.isVisible}}}class Track{constructor(t){this.clips=[],t.clips&&t.clips.forEach((t=>{this.addClip(new Clip(t))})),this.startFrame=t.startFrame||0,this.label=t.label,this.isVisible=void 0===t.isVisible||t.isVisible,this.endFrame=this.calcEndFrame()}calcEndFrame(){return 0===this.clips.length?0:(this.endFrame=this.startFrame+Math.max(...this.clips.map((t=>t.calcEndFrame()))),this.endFrame)}addClip(t){this.clips.push(t),this.resetClips()}removeClip(t){const e=this.clips.indexOf(t);this.clips.splice(e,1),this.resetClips()}resetClips(){for(let t=1;t<this.clips.length;t++)this.clips[t-1].calcEndFrame(),this.clips[t].startFrame=this.clips[t-1].endFrame+1}update(t){for(let e=0;e<this.clips.length;e++){const i=this.clips[e];if(!(t<i.startFrame)&&!(t>i.endFrame)){i.update(t-this.startFrame);break}}}draw(t){for(let e=0;e<this.clips.length;e++){if(!this.isVisible)continue;const i=this.clips[e];if(i.isVisible&&!(t<this.startFrame+i.startFrame||t>this.startFrame+i.endFrame)){i.draw();break}}}get data(){const t={clips:this.clips.map((t=>t.data)),startFrame:this.startFrame,isVisible:this.isVisible};return this.label&&(t.label=this.label),t}}class UIClip extends UICollection{constructor(t,e){super(e);const i=new UILabel({text:t.name}),a=new UIToggleCheck({isOn:t.isVisible,callback:e=>{t.isVisible=void 0!==e?e:!t.isVisible}}),s=new UIButton({text:"Edit",callback:()=>{let e=location.pathname.includes("lines")?"lines/":"";window.open(`${location.origin}/${e}animate/?src=${t.filePath}`,"anim")}}),n=new UIButton({text:"X",callback:e.remove}),o=new UIButton({text:"+",callback:e.addClip}),r=new UINumberStep({value:t.repeatCount,callback:i=>{t.repeatCount=+i,e.drawUI()}}),c=new UISelect({options:Object.keys(t.animation.states),selected:t.state,callback:i=>{t.state=i,t.setup(),e.drawUI()}});let l=new UIRow,d=new UIRow;this.append(l),this.append(d),l.append(i),l.append(a),l.append(s),l.append(n),l.append(o),d.append(r),d.append(c)}}class UITrack extends UICollection{constructor(t,e){super(e);const i=new UIText({text:t.label||"Track "+e.index,callback:e=>{t.label=e}}),a=new UIToggleCheck({isOn:t.isVisible,callback:e=>{t.isVisible=void 0!==e?e:!t.isVisible}});this.append(i),this.append(a)}}function Canvas(t,e){Object.assign(Canvas.prototype,ModuleMixin);const i=this;this.canvas=document.getElementById(e.id),this.ctx=this.canvas.getContext("2d");let a=e.checkRetina&&window.devicePixelRatio||1,s=e.lineWidth||1,n=e.scale||1,o=this.canvas.width,r=this.canvas.height;this.addProp("scale",{get:()=>n,set:t=>{n=+t,i.updateSize()}}),this.addProp("width",{get:()=>o,set:t=>{o=+t,i.updateSize()}}),this.addProp("height",{get:()=>r,set:t=>{r=+t,i.updateSize()}}),this.addProp("lineWidth",{get:()=>s,set:t=>{s=+t,i.reset()}}),this.updateSize=function(){i.canvas.width=o*a*n,i.canvas.height=r*a*n,i.ctx.scale(1,1),i.ctx.scale(a,a),i.ctx.scale(n,n),i.reset()},this.reset=function(){i.canvas.style.width=o*n+"px",i.canvas.style.height=r*n+"px",i.ctx.lineWidth=s,i.ctx.miterLimit=1,i.ctx.lineCap="round",i.ctx.lineJoin="round"}}function Compositions(t){Object.assign(Compositions.prototype,ModuleMixin);const e=this,i={};this.addProp("data",{get:()=>{const t={};for(const e in i)t[e]=i[e].data;return t}}),this.addComposition=function(t,a){t||(t=prompt("Composition name","New Composition")),i[t]=new Composition(a||{}),e.addUI(t)},this.load=function(t){for(const i in t)e.addComposition(i,t[i])},this.get=function(t){return i[t]},this.addUI=function(a){const s=a+"-row",n=e.panel.addRow(s);n.addClass("ui-composition"),e.panel[s].append(new UIText({text:a,callback:t=>{const e=Object.getOwnPropertyDescriptor(i,a);Object.defineProperty(i,t,e),delete i[a]}})),e.panel[s].append(new UIButton({text:"Edit",callback:()=>{t.timeline.composition=a}})),e.panel[s].append(new UIButton({text:"+",callback:()=>{t.timeline.composition.addComposition(i[a])}})),e.panel[s].append(new UIButton({text:"X",callback:()=>{delete i[a],e.panel.removeRow(n)}}))}}function FileIO(t,e){Object.assign(FileIO.prototype,ModuleMixin);const i=this;let a=e.projectName||"Animation_"+(new Date).toDateString().replace(/ /g,"-");function s(e,i){t.footage.load(e.footage,!0,(()=>{!function(e){for(const i in e)for(let a=0;a<e[i].tracks.length;a++){const s=e[i].tracks[a];for(let n=0;n<s.clips.length;n++){const o=s.clips[n];e[i].tracks[a].clips[n].animation=t.footage.get(o.name)}}t.compositions.load(e)}(e.compositions),t.timeline.activeComposition=e.activeComposition,i(),t.timeline.drawUI()}))}this.addProp("projectName",{get:()=>a,set:t=>{a=t,document.title=a+" ~ animation editor"}}),this.save=function(){const e={v:"0.1"};e.activeComposition=t.timeline.activeComposition,e.footage=t.footage.filePaths,e.compositions=t.compositions.data,console.log(t.compositions.data);const i=JSON.stringify(e),s=new Blob([i],{type:"application/x-download;charset=utf-8"});saveAs(s,a+".json")},this.load=function(t,e){i.projectName=t.split("/").pop().replace(".json",""),fetch(t).then((t=>t.json())).then((t=>{s(t,e)})).catch((t=>{console.error("err",t.message)}))}}function Footage(t){const e=this;let i=!0;const a={};function s(s,n,o,r){a[n]=new Lines(t.canvas.ctx,30,!0),a[n].loadData(s,(()=>{(r||i&&confirm("Set project settings?"))&&(i=!1,t.ui.faces.width.update(s.w),t.ui.faces.height.update(s.h))}));const c=new UIButton({text:n,callback:()=>{const e=new Clip({filePath:o,name:n,animation:a[n],startFrame:t.renderer.frame});t.timeline.addClip(e)}});e.panel.footageRow.append(c),e.filePaths.push(o)}this.filePaths=[],this.load=function(t,e,i){let a=0,n=t.length;t.forEach((t=>{const o=t.split("/").pop().replace(".json","");fetch(t).then((t=>t.json())).then((r=>{s(r,o,t,e),a++,a===n&&i&&i()}))}))},this.openFile=function(){const t=document.createElement("input");t.type="file",t.multiple=!0,t.click(),t.onchange=function(){let e=prompt("Directory?","/drawings/");!function(t,e){for(let i,a=0;i=t[a];a++){if(!i.type.match("application/json"))continue;const t=new FileReader;t.onload=function(t){const a=e+i.name,n=i.name.split(".")[0];s(JSON.parse(t.target.result),n,a)},t.readAsText(i)}}(t.files,e)}},this.get=function(t){return a[t]}}const ModuleMixin={addProp(t,e){Object.defineProperty(this,t,{get:e.get,set:e.set})}};function Renderer(t,e,i){Object.assign(Renderer.prototype,ModuleMixin);const a=this;e||(e=30);let s=1e3/e,n=performance.now(),o=!1,r=0;window.drawCount=0,this.isPlaying=!1,this.addProp("dps",{get:()=>e,set:t=>{s=1e3/(e=+t),dpf=Math.round(e/i)}}),this.addProp("fps",{get:()=>i,set:t=>{i=+t,dpf=Math.round(e/i)}}),this.nextFrame=function(e){"+1"===e?a.frame=r+1:"-1"===e?a.frame=r-1:"end"===e&&(a.frame=t.timeline.composition.endFrame)},this.addProp("frame",{get:()=>r,set:e=>{let i=+e;i<=t.timeline.composition.endFrame&&i>=0&&(r=i),t.ui.faces.frameDisplay.value=r,t.timeline.updateUI()}}),this.addProp("isPlaying",{get:()=>o,set:t=>{o=t}}),this.update=function(e,i){(performance.now()>s+n||i)&&(n=performance.now(),t.canvas.ctx.clearRect(0,0,t.canvas.width,t.canvas.height),t.timeline.update(r),t.timeline.draw(r),o&&(a.frame++,r>=t.timeline.composition.endFrame&&(a.frame=0)),window.drawCount++),i||window.requestAnimFrame(a.update)},this.start=function(){window.requestAnimFrame(a.update)}}function Timeline(t){Object.assign(Timeline.prototype,ModuleMixin);const e=this;this.activeComposition="default",this.addProp("composition",{get:()=>t.compositions.get(e.activeComposition),set:t=>{e.activeComposition=t,e.drawUI()}}),this.addClip=function(t){e.composition.track.addClip(t),e.drawUI()},this.update=function(t){e.composition.update(t)},this.draw=function(t){e.composition.draw(t)};let i=!1;const a=[1,5,10,20,25,50,100];this.drawUI=function(){e.panel.timeline.clear();const s=e.composition,{tracks:n}=s;n.forEach((t=>t.resetClips()));const o=s.calcEndFrame();e.panel.timeline.setProp("--num-frames",o),e.panel.timeline.setProp("--num-tracks",n.length);const r=o/((e.panel.timeline.el.clientWidth-100)/25);let c=0;for(;a[c]<r;)if(c++,c>=a.length-1){console.warn("fuck need more pwidths");break}let l=a[c];for(let i=0;i<=o;i++){const a="frame-"+i,s=new UIButton({type:"frame",text:i%l==0?`${i}`:"",css:{gridColumnStart:2+2*i,gridColumnEnd:4+2*i},class:i==t.renderer.frame?"current-frame":"",callback:()=>{t.renderer.frame=i,e.updateUI()}});e.panel.timeline.append(s,a)}for(let i=0;i<n.length;i++){const a="track-"+i,s=n[i],o=new UITrack(s,{index:i,class:"track",css:{gridRowStart:2,gridRowEnd:2}});e.panel.timeline.append(o,a);const{clips:r}=s;for(let i=0;i<r.length;i++){const a=r[i],n="clip-"+a.name,o=new UIClip(a,{class:"clip",css:{gridColumnStart:2+2*(s.startFrame+a.startFrame),gridColumnEnd:4+2*(s.startFrame+a.endFrame)},remove:()=>{s.removeClip(a),e.drawUI()},addClip:()=>{let i=a.data;i.animation=t.footage.get(i.name),e.addClip(new Clip(i)),e.drawUI()},drawUI:e.drawUI});e.panel.timeline.append(o,n)}}i=!0},this.updateUI=function(){if(!i)return;const a=document.getElementsByClassName("current-frame");a&&a[0].classList.remove("current-frame"),e.panel.timeline["frame-"+t.renderer.frame].addClass("current-frame")}}window.addEventListener("load",(function(){const t={};t.addProp=Object.defineProperty;const e={};function i(){t.ui.settings.load(),t.renderer.start()}location.search.substr(1).split("&").map((t=>{let[i,a]=t.split("=");e[i]=a})),t.canvas=new Canvas(t,{id:"lines",checkRetina:!0}),t.timeline=new Timeline(t),t.compositions=new Compositions(t),t.footage=new Footage(t),t.fio=new FileIO(t,{}),t.renderer=new Renderer(t),t.ui=new Interface(t),t.ui.settings=new Settings(t,"anim-editor"),t.ui.load("./interface/interface.json",(()=>{e.src?t.fio.load(e.src,i):i()})),console.log(t)}));
//# sourceMappingURL=src_maps/animEditor.min.js.map
