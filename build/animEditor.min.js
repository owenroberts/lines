!function(){"use strict";class e{constructor(t,e){e||(e=30),this.name=t.name,this.filePath=t.filePath,this.animation=t.animation,this.startFrame=t.startFrame,this.isVisible=void 0===t.isVisible||t.isVisible,this.repeatCount=t.repeatCount||1,this.state=t.state||"default",this.dpf=t.dpf||this.animation.dpf,this.setup(),this.endFrame=this.calcEndFrame(),this.animation.isPlaying=!0}setup(){const t=this.animation.states[this.state];this.duration=t.end-t.start+1}calcEndFrame(){let t=this.duration*this.dpf*this.repeatCount;return this.endFrame=this.startFrame+t-1,this.endFrame}update(t){let e=t-this.startFrame;e=Math.floor(e/this.dpf),e%=this.duration,this.animation.currentFrame=this.animation.states[this.state].start+e}draw(){this.animation.draw()}get data(){return{name:this.name,filePath:this.filePath,startFrame:this.startFrame,isVisible:this.isVisible,state:this.state,repeatCount:this.repeatCount,dpf:this.dpf}}}class i{constructor(t){this.tracks=[],t.tracks?t.tracks.forEach((t=>{this.tracks.push(new a(t))})):this.tracks.push(new a({})),this.activeTrackIndex=t.activeTrackIndex||0,this.isVisible=void 0===t.isVisible||t.isVisible,this.endFrame=this.calcEndFrame()}addTrack(){this.tracks.push(new a({}))}addComposition(t){this.track.addComposition(t)}get track(){return this.tracks[this.activeTrackIndex]}set track(t){this.activeTrackIndex=+t}calcEndFrame(){return this.endFrame=Math.max(...this.tracks.map((t=>t.calcEndFrame()))),this.endFrame}update(t){for(let e=0;e<this.tracks.length;e++)this.tracks[e].update(t)}draw(t){for(let e=0;e<this.tracks.length;e++)this.tracks[e].draw(t)}get data(){return{tracks:this.tracks.map((t=>t.data)),activeTrackIndex:this.activeTrackIndex,isVisible:this.isVisible}}}class a{constructor(t){this.clips=[],t.clips&&t.clips.forEach((t=>{this.addClip(new e(t))})),this.startFrame=t.startFrame||0,this.label=t.label,this.isVisible=void 0===t.isVisible||t.isVisible,this.endFrame=this.calcEndFrame()}calcEndFrame(){return 0===this.clips.length?0:(this.endFrame=this.startFrame+Math.max(...this.clips.map((t=>t.calcEndFrame()))),this.endFrame)}addClip(t){this.clips.push(t),this.resetClips()}removeClip(t){const e=this.clips.indexOf(t);this.clips.splice(e,1),this.resetClips()}getClipIndex(t){for(let e=0;e<this.clips.length;e++)if(t>=this.clips[e].startFrame&&t<=this.clips[e].endFrame)return e}resetClips(){for(let t=1;t<this.clips.length;t++)this.clips[t-1].calcEndFrame(),this.clips[t].startFrame=this.clips[t-1].endFrame+1}update(t){for(let e=0;e<this.clips.length;e++){const i=this.clips[e];if(!(t<i.startFrame)&&!(t>i.endFrame)){i.update(t-this.startFrame);break}}}draw(t){for(let e=0;e<this.clips.length;e++){if(!this.isVisible)continue;const i=this.clips[e];if(i.isVisible&&!(t<this.startFrame+i.startFrame||t>this.startFrame+i.endFrame)){i.draw();break}}}get data(){const t={clips:this.clips.map((t=>t.data)),startFrame:this.startFrame,isVisible:this.isVisible};return this.label&&(t.label=this.label),t}}class s extends UICollection{constructor(t,e){super(e);const i=new UILabel({text:t.name}),a=new UIToggleCheck({isOn:t.isVisible,callback:e=>{t.isVisible=void 0!==e?e:!t.isVisible}}),s=new UIButton({text:"E",callback:()=>{let e=location.pathname.includes("lines")?"lines/":"";window.open(`${location.origin}/${e}animate/?src=${t.filePath}`,"anim")}}),n=new UIButton({text:"X",callback:e.remove}),r=new UIButton({text:"+",callback:e.addClip}),o=new UINumberStep({value:t.repeatCount,callback:i=>{t.repeatCount=+i,e.drawUI()}}),c=new UISelect({options:Object.keys(t.animation.states),selected:t.state,callback:i=>{t.state=i,t.setup(),e.drawUI()}}),l=new UIButton({text:"â®‚",callback:e.swap}),d=new UINumberStep({value:t.dpf,callback:i=>{t.dpf=+i,e.drawUI()}});let p=new UIRow,h=new UIRow,m=new UIRow;this.append(p),this.append(h),this.append(m),p.append(i),h.append(l),h.append(c),h.append(r),p.append(a),p.append(n),p.append(s),m.append(new UILabel({text:"R"})),m.append(o),m.append(new UILabel({text:"DPF"})),m.append(d)}}class n extends UICollection{constructor(t,e){super(e);const i=new UIText({text:t.label||"Track "+e.index,callback:e=>{t.label=e}}),a=new UIToggleCheck({isOn:t.isVisible,callback:e=>{t.isVisible=void 0!==e?e:!t.isVisible}});this.append(i),this.append(a)}}function r(t,e){Object.assign(r.prototype,p);const i=this;this.canvas=document.getElementById(e.id),this.ctx=this.canvas.getContext("2d"),this.bgColor=e.bgColor||"#ffffff";let a=e.checkRetina&&window.devicePixelRatio||1,s=e.lineWidth||1,n=e.scale||1,o=this.canvas.width,c=this.canvas.height;this.addProp("scale",{get:()=>n,set:t=>{n=+t,i.updateSize()}}),this.addProp("width",{get:()=>o,set:t=>{o=+t,i.updateSize()}}),this.addProp("height",{get:()=>c,set:t=>{c=+t,i.updateSize()}}),this.addProp("lineWidth",{get:()=>s,set:t=>{s=+t,i.reset()}}),this.updateSize=function(){i.canvas.width=o*a*n,i.canvas.height=c*a*n,i.ctx.scale(1,1),i.ctx.scale(a,a),i.ctx.scale(n,n),i.reset()},this.reset=function(){i.canvas.style.width=o*n+"px",i.canvas.style.height=c*n+"px",i.ctx.lineWidth=s,i.ctx.miterLimit=1,i.ctx.lineCap="round",i.ctx.lineJoin="round"}}function o(e,i){Object.assign(m.prototype,p);const a=this;this.videoBitsPerSecond=16e6,this.isCapturing=!1;const s={};this.start=function(){e.renderer.frame=0,e.ui.faces.videoCapture.addClass("progress"),e.renderer.updateFunc=function(){e.ui.faces.videoCapture.setProp("--progress-percent",Math.round(100*e.renderer.frame/e.timeline.composition.endFrame))},a.capture(!0),e.renderer.isPlaying=!0},this.end=function(){if(a.rec.stop(),e.renderer.updateFunc=void 0,e.ui.faces.videoCapture.removeClass("progress"),a.isCapturing=!1,e.renderer.isPlaying=!1,i.captureSettings)for(const t in i.captureSettings)e.ui.faces[t].update(s[t])},this.capture=function(n){if(!a.isCapturing){if(i.captureSettings)for(const t in i.captureSettings)s[t]=e.ui.faces[t].value,e.ui.faces[t].update(a[t]);a.isCapturing=!0;const r=e.canvas.canvas.captureStream(e.renderer.dps);a.rec=new MediaRecorder(r,{}),a.rec.start(),a.rec.addEventListener("dataavailable",(e=>{const i=new Blob([e.data],{type:"video/webm"}),a=URL.createObjectURL(i),s=document.createElement("a");document.body.appendChild(s),s.href=a,n&&(t=prompt("Title?","comp name")),s.download=`${t}.webm`,s.click()}))}}}function c(t){Object.assign(c.prototype,p);const e=this,a={};this.addProp("data",{get:()=>{const t={};for(const e in a)t[e]=a[e].data;return t}}),this.addComposition=function(t,s){t||(t=prompt("Composition name","New Composition")),a[t]=new i(s||{}),e.addUI(t)},this.load=function(t){for(const i in t)e.addComposition(i,t[i])},this.get=function(t){return a[t]},this.addUI=function(i){const s=i+"-row",n=e.panel.addRow(s);n.addClass("ui-composition"),e.panel[s].append(new UIText({text:i,callback:t=>{const e=Object.getOwnPropertyDescriptor(a,i);Object.defineProperty(a,t,e),delete a[i]}})),e.panel[s].append(new UIButton({text:"Edit",callback:()=>{t.timeline.composition=i}})),e.panel[s].append(new UIButton({text:"+",callback:()=>{t.timeline.composition.addComposition(a[i])}})),e.panel[s].append(new UIButton({text:"X",callback:()=>{delete a[i],e.panel.removeRow(n)}}))}}function l(t,e){Object.assign(l.prototype,p);const i=this;let a=e.projectName||"Animation_"+(new Date).toDateString().replace(/ /g,"-");function s(e,i){t.footage.load(e.footage,!0,(()=>{!function(e){for(const i in e)for(let a=0;a<e[i].tracks.length;a++){const s=e[i].tracks[a];for(let n=0;n<s.clips.length;n++){const r=s.clips[n];e[i].tracks[a].clips[n].animation=t.footage.get(r.name)}}t.compositions.load(e)}(e.compositions),t.timeline.activeComposition=e.activeComposition,i&&i(),t.timeline.drawUI()}))}this.addProp("projectName",{get:()=>a,set:t=>{a=t,document.title=a+" ~ animation editor"}}),this.save=function(){const e={v:"0.1"};e.activeComposition=t.timeline.activeComposition,e.footage=t.footage.filePaths,e.compositions=t.compositions.data,console.log(t.compositions.data);const i=JSON.stringify(e),s=new Blob([i],{type:"application/x-download;charset=utf-8"});saveAs(s,a+".json")},this.load=function(t,e){i.projectName=t.split("/").pop().replace(".json",""),fetch(t).then((t=>t.json())).then((t=>{s(t,e)})).catch((t=>{console.error("err",t.message)}))},this.open=function(t,e,a){i.projectName=e.split("/").pop().replace(".json",""),s(t),window.history.pushState(e,e,location.href+"?src="+a)}}function d(t){const i=this;let a=!0;const s={};function n(n,r,o,c){s[r]=new Lines(t.canvas.ctx,30,!0),s[r].loadData(n,(()=>{(c||a&&confirm("Set project settings?"))&&(a=!1,t.ui.faces.width.update(n.w),t.ui.faces.height.update(n.h),n.bg&&t.ui.faces.bgColor.update(n.bg))}));const l=new UIButton({text:r,callback:()=>{const i=new e({filePath:o,name:r,animation:s[r],startFrame:t.renderer.frame});t.timeline.addClip(i)}});i.panel.footageRow.append(l),i.filePaths.push(o)}this.filePaths=[],this.load=function(t,e,i){let a=0,s=t.length;t.forEach((t=>{const r=t.split("/").pop().replace(".json","");fetch(t).then((t=>t.json())).then((o=>{n(o,r,t,e),a++,a===s&&i&&i()}))}))},this.open=function(t,e,i){n(t,e,i)},this.get=function(t){return s[t]}}const p={addProp(t,e){Object.defineProperty(this,t,{get:e.get,set:e.set})}};function h(t,e,i){Object.assign(h.prototype,p);const a=this;e||(e=30);let s=1e3/e,n=performance.now(),r=!1,o=0;window.drawCount=0,this.isPlaying=!1,this.addProp("dps",{get:()=>e,set:t=>{s=1e3/(e=+t),dpf=Math.round(e/i)}}),this.addProp("fps",{get:()=>i,set:t=>{i=+t,dpf=Math.round(e/i)}}),this.nextFrame=function(e){"+1"===e?a.frame=o+1:"-1"===e?a.frame=o-1:"end"===e&&(a.frame=t.timeline.composition.endFrame)},this.addProp("frame",{get:()=>o,set:e=>{let i=+e;i<=t.timeline.composition.endFrame&&i>=0&&(o=i),t.ui.faces.frameDisplay.value=o,t.timeline.updateUI()}}),this.addProp("isPlaying",{get:()=>r,set:t=>{r=t}}),this.update=function(e,i){(performance.now()>s+n||i)&&(n=performance.now(),t.canvas.ctx.clearRect(0,0,t.canvas.width,t.canvas.height),t.canvas.ctx.fillStyle=t.canvas.bgColor,t.canvas.ctx.fillRect(0,0,t.canvas.width,t.canvas.height),t.timeline.update(o),t.timeline.draw(o),a.updateFunc&&a.updateFunc(),r&&(a.frame++,o>=t.timeline.composition.endFrame&&(a.frame=0,t.capture.isCapturing&&t.capture.end())),window.drawCount++),i||window.requestAnimFrame(a.update)},this.start=function(){window.requestAnimFrame(a.update)}}function m(t){Object.assign(m.prototype,p);const i=this;this.activeComposition="default",this.addProp("composition",{get:()=>t.compositions.get(i.activeComposition),set:t=>{i.activeComposition=t,i.drawUI()}}),this.addClip=function(t){i.composition.track.addClip(t),i.drawUI()},this.update=function(t){i.composition.update(t)},this.draw=function(t){i.composition.draw(t)};let a=!1,r=1;const o=[1,5,10,20,25,50,100,200];let c=1;this.addProp("scale",{get:()=>r,set:t=>{r=+t,i.drawUI()}}),this.drawUI=function(){i.panel.timeline.clear();const l=i.composition,{tracks:d}=l;d.forEach((t=>t.resetClips())),i.panel.timeline.setProp("--num-tracks",d.length);const p=l.calcEndFrame();let h=i.panel.timeline.el.clientWidth-136;h=Math.floor(h*r);let m=0;for(;h/(p/o[m])<25;)if(m++,m>=o.length-1){console.warn("fuck need more pwidths");break}c=o[m];let u=Math.floor(p/c),f=Math.floor(h/u);i.panel.timeline.setProp("--num-frames",p);for(let e=0;e<=p;e+=c){const a="frame-"+e,s=new UIButton({type:"frame",text:e%o[m]==0?`${e}`:"",css:{gridColumnStart:2+e,gridColumnEnd:2+(e+c),width:r>1?f+"px":"unset"},id:a,class:e==t.renderer.frame?"current-frame":"",callback:()=>{t.renderer.frame=e,i.updateUI()}});s.el.dataset.frameNumber=e,s.el.addEventListener("mouseover",(e=>{1===e.which&&t.renderer.frame!==+e.target.dataset.frameNumber&&(t.renderer.frame=+e.target.dataset.frameNumber)})),i.panel.timeline.append(s,a)}for(let a=0;a<d.length;a++){const r="track-"+a,o=d[a],c=new n(o,{index:a,class:"track",css:{gridRowStart:2,gridRowEnd:2}});i.panel.timeline.append(c,r);const{clips:l}=o;for(let a=0;a<l.length;a++){const n=l[a],r="clip-"+n.name,c=new s(n,{class:"clip",css:{gridColumnStart:2+(o.startFrame+n.startFrame),gridColumnEnd:3+(o.startFrame+n.endFrame)},remove:()=>{o.removeClip(n),i.drawUI()},addClip:()=>{let a=n.data;a.animation=t.footage.get(a.name),i.addClip(new e(a)),i.drawUI()},swap:()=>{if(0===a)return;let t=a,e=a-1;[o.clips[t],o.clips[e]]=[o.clips[e],o.clips[t]],o.clips[e].startFrame=0,i.drawUI()},drawUI:i.drawUI});i.panel.timeline.append(c,r)}}a=!0},this.updateUI=function(e){if(a&&(e||(e=t.renderer.frame),i.panel.timeline["frame-"+e])){const t=document.getElementsByClassName("current-frame");t[0]&&t[0].classList.remove("current-frame"),i.panel.timeline["frame-"+e].addClass("current-frame")}},this.nextFrame=function(e){const a=document.getElementsByClassName("current-frame");if(a[0]){let s=+a[0].dataset.frameNumber+c*e;t.renderer.frame=s,a[0].classList.remove("current-frame"),i.panel.timeline["frame-"+t.renderer.frame].addClass("current-frame")}},this.nextClip=function(e){const a=t.timeline.composition.track.getClipIndex(t.renderer.frame);a+e>=0&&a+e<t.timeline.composition.track.clips.length&&(t.renderer.frame=t.timeline.composition.track.clips[a+e].startFrame),i.updateUI(Math.floor(t.renderer.frame/c)*c)}}window.addEventListener("load",(function(){const t={};t.addProp=Object.defineProperty;const e={};function i(){t.ui.settings.load(),t.renderer.start()}location.search.substr(1).split("&").map((t=>{let[i,a]=t.split("=");e[i]=a})),t.canvas=new r(t,{id:"lines",checkRetina:!0}),t.timeline=new m(t),t.compositions=new c(t),t.footage=new d(t),t.fio=new l(t,{}),t.renderer=new h(t),t.capture=new o(t,{captureSettings:{lineWidth:1,canvasScale:2}}),t.ui=new Interface(t),t.ui.settings=new Settings(t,"anim-editor"),t.ui.load("./interface/interface.json",(()=>{e.src?t.fio.load(e.src,i):(t.compositions.addComposition("default",{}),i())})),console.log(t)}))}();
//# sourceMappingURL=src_maps/animEditor.min.js.map
